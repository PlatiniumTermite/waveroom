
Index Â· HTML
Copy

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>WaveRoom</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07080d;--s:#0c0e15;--b:#191e2e;
  --c:#00e5ff;--p:#8b5cf6;--g:#00ff88;
  --r:#ff4466;--t:#e8edf8;--m:#4a5578;
  --gold:#ffd700
}
html,body{background:var(--bg);color:var(--t);font-family:'Syne',sans-serif;min-height:100vh;overscroll-behavior:none}

/* animated background */
body::before{
  content:'';position:fixed;inset:0;
  background-image:linear-gradient(var(--b) 1px,transparent 1px),linear-gradient(90deg,var(--b) 1px,transparent 1px);
  background-size:48px 48px;opacity:.12;pointer-events:none;z-index:0
}
/* glow orbs */
body::after{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:
    radial-gradient(ellipse 600px 400px at 20% 10%,rgba(0,229,255,.04),transparent),
    radial-gradient(ellipse 500px 400px at 80% 90%,rgba(139,92,246,.05),transparent)
}

#app{position:relative;z-index:1;max-width:800px;margin:0 auto;padding:28px 18px}

/* NAV */
.nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:44px}
.nav-left{display:flex;align-items:center;gap:10px}
.nav-icon{
  width:36px;height:36px;border-radius:9px;
  background:linear-gradient(135deg,var(--c),var(--p));
  display:flex;align-items:center;justify-content:center;font-size:18px;
  box-shadow:0 0 20px rgba(0,229,255,.2)
}
.nav-name{
  font-size:20px;font-weight:800;
  background:linear-gradient(135deg,var(--c),var(--p));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text
}
.nav-badge{
  font-family:'Space Mono',monospace;font-size:9px;color:var(--gold);
  border:1px solid rgba(255,215,0,.3);border-radius:20px;padding:2px 8px;
  background:rgba(255,215,0,.07)
}

/* SCREENS */
.screen{display:none}
.screen.on{display:block;animation:up .22s ease}
@keyframes up{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* HOME */
.hero{text-align:center;padding:10px 0 32px}
.hero-badge{
  display:inline-flex;align-items:center;gap:6px;
  font-family:'Space Mono',monospace;font-size:10px;color:var(--c);
  border:1px solid rgba(0,229,255,.2);border-radius:20px;
  padding:4px 12px;margin-bottom:20px;background:rgba(0,229,255,.05)
}
.hero h1{font-size:clamp(32px,6vw,60px);font-weight:800;letter-spacing:-2px;line-height:1.05;margin-bottom:14px}
.hero h1 em{
  font-style:normal;
  background:linear-gradient(135deg,var(--c),var(--p));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text
}
.hero-sub{font-family:'Space Mono',monospace;font-size:12px;color:var(--m);max-width:360px;margin:0 auto 32px;line-height:1.9}

.home-cards{display:grid;grid-template-columns:1fr 1fr;gap:12px;max-width:520px;margin:0 auto}
@media(max-width:430px){.home-cards{grid-template-columns:1fr}}

.hcard{
  background:var(--s);border:1px solid var(--b);border-radius:14px;
  padding:22px 18px;cursor:pointer;text-align:left;
  transition:border-color .18s,transform .18s,box-shadow .18s;
  -webkit-tap-highlight-color:transparent;position:relative;overflow:hidden
}
.hcard::before{
  content:'';position:absolute;inset:0;opacity:0;transition:opacity .2s;border-radius:14px
}
.hcard.host-c::before{background:radial-gradient(circle at 30% 30%,rgba(0,229,255,.07),transparent 70%)}
.hcard.join-c::before{background:radial-gradient(circle at 30% 30%,rgba(139,92,246,.07),transparent 70%)}
.hcard:hover{border-color:rgba(0,229,255,.35);transform:translateY(-3px);box-shadow:0 10px 30px rgba(0,0,0,.3)}
.hcard:hover::before{opacity:1}
.hcard-icon{font-size:26px;margin-bottom:10px}
.hcard-title{font-size:16px;font-weight:700;margin-bottom:4px}
.hcard-desc{font-size:11px;color:var(--m);font-family:'Space Mono',monospace;line-height:1.55}

/* FORM */
.fbox{max-width:400px;margin:0 auto}
.back-btn{background:none;border:none;color:var(--m);font-family:'Space Mono',monospace;font-size:11px;cursor:pointer;margin-bottom:28px;padding:0;transition:color .18s}
.back-btn:hover{color:var(--c)}
.f-title{font-size:27px;font-weight:800;letter-spacing:-1px;margin-bottom:5px}
.f-sub{font-family:'Space Mono',monospace;font-size:11px;color:var(--m);margin-bottom:22px;line-height:1.75}
.f-label{display:block;font-size:9px;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--m);margin-bottom:5px}
.f-input{
  width:100%;background:var(--s);border:1px solid var(--b);border-radius:8px;
  padding:11px 13px;color:var(--t);font-family:'Space Mono',monospace;font-size:13px;
  outline:none;transition:border-color .18s;margin-bottom:12px
}
.f-input:focus{border-color:var(--c)}
.f-input::placeholder{color:var(--m)}
#join-code{letter-spacing:5px;font-size:20px;text-transform:uppercase;text-align:center}

/* BUTTONS */
.btn{
  width:100%;padding:12px;border-radius:8px;
  font-family:'Syne',sans-serif;font-size:13px;font-weight:700;
  cursor:pointer;border:none;transition:all .18s;
  display:flex;align-items:center;justify-content:center;gap:6px;
  -webkit-tap-highlight-color:transparent
}
.btn-c{background:linear-gradient(135deg,var(--c),#009eb5);color:#000}
.btn-c:hover{box-shadow:0 6px 20px rgba(0,229,255,.3);transform:translateY(-1px)}
.btn-p{background:linear-gradient(135deg,var(--p),#6d28d9);color:#fff}
.btn-p:hover{box-shadow:0 6px 20px rgba(139,92,246,.32);transform:translateY(-1px)}
.btn-g{background:var(--s);border:1px solid var(--b);color:var(--t)}
.btn-g:hover{border-color:var(--c);color:var(--c)}
.btn-r{background:var(--r);color:#fff}
.btn:disabled{opacity:.28;cursor:not-allowed;transform:none!important;box-shadow:none!important}
.btn-row{display:flex;gap:7px}
.btn-row .btn{width:auto;flex:1;padding:10px 6px;font-size:12px}

.f-err{background:rgba(255,68,102,.1);border:1px solid rgba(255,68,102,.3);border-radius:7px;padding:8px 12px;font-family:'Space Mono',monospace;font-size:11px;color:var(--r);margin-bottom:11px;display:none}
.f-err.on{display:block}

/* ROOM */
.room-head{display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:16px}
.room-name{font-size:21px;font-weight:800;letter-spacing:-.5px}
.room-code-wrap{display:flex;align-items:center;gap:8px;margin-top:5px}
.room-code{
  display:inline-flex;align-items:center;gap:6px;
  background:var(--s);border:1px solid var(--b);border-radius:7px;
  padding:6px 11px;font-family:'Space Mono',monospace;font-size:17px;
  font-weight:700;letter-spacing:4px;color:var(--c);
  cursor:pointer;transition:border-color .18s;-webkit-tap-highlight-color:transparent
}
.room-code:hover,.room-code:active{border-color:var(--c)}
.room-code small{font-size:9px;color:var(--m);letter-spacing:0}

.pill{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:100px;font-family:'Space Mono',monospace;font-size:10px;font-weight:700}
.p-live{background:rgba(0,255,136,.1);color:var(--g);border:1px solid rgba(0,255,136,.22)}
.p-wait{background:rgba(74,85,120,.13);color:var(--m);border:1px solid var(--b)}
.p-sync{background:rgba(0,229,255,.1);color:var(--c);border:1px solid rgba(0,229,255,.2)}
.dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.d-g{background:var(--g);animation:bl 1.3s infinite}
.d-m{background:var(--m)}
.d-c{background:var(--c);animation:bl 1.3s infinite}
@keyframes bl{0%,100%{opacity:1}50%{opacity:.28}}

/* PANEL */
.panel{background:var(--s);border:1px solid var(--b);border-radius:13px;padding:16px;margin-bottom:11px;position:relative}
.ptitle{font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--m);font-family:'Space Mono',monospace;margin-bottom:11px}

/* DOLBY BADGE */
.dolby-badge{
  position:absolute;top:14px;right:14px;
  font-family:'Space Mono',monospace;font-size:8px;font-weight:700;
  color:var(--gold);border:1px solid rgba(255,215,0,.3);
  border-radius:4px;padding:2px 6px;background:rgba(255,215,0,.07);
  letter-spacing:1px
}

/* TRACK */
.track-info{display:flex;align-items:center;gap:11px;margin-bottom:14px}
.track-art{
  width:44px;height:44px;border-radius:10px;flex-shrink:0;
  background:linear-gradient(135deg,var(--p),var(--c));
  display:flex;align-items:center;justify-content:center;font-size:20px;
  animation:rotate 10s linear infinite;animation-play-state:paused;
  box-shadow:0 4px 14px rgba(0,229,255,.15)
}
.track-art.spin{animation-play-state:running}
@keyframes rotate{to{transform:rotate(360deg)}}
.track-name{font-size:14px;font-weight:700;word-break:break-all;line-height:1.3}
.track-sub{font-family:'Space Mono',monospace;font-size:10px;color:var(--m);margin-top:2px}

/* SEEKBAR */
.seekbar{padding:5px 0;cursor:pointer;margin-bottom:5px;user-select:none}
.seekbar-track{width:100%;height:4px;background:var(--b);border-radius:10px;overflow:hidden}
.seekbar-fill{
  height:100%;width:0%;border-radius:10px;transition:width .2s linear;
  background:linear-gradient(90deg,var(--c),var(--p))
}
.seekbar-times{display:flex;justify-content:space-between;font-family:'Space Mono',monospace;font-size:9px;color:var(--m);margin-top:4px}

.vol-row{display:flex;align-items:center;gap:8px;margin-top:10px}
.vol-lbl{font-family:'Space Mono',monospace;font-size:10px;color:var(--m);white-space:nowrap}
input[type=range]{flex:1;accent-color:var(--c);cursor:pointer;height:18px}

/* DOLBY EQ */
.eq-row{display:flex;align-items:flex-end;gap:6px;margin-top:12px;padding:10px 12px;background:rgba(255,215,0,.04);border:1px solid rgba(255,215,0,.12);border-radius:8px}
.eq-label{font-family:'Space Mono',monospace;font-size:9px;color:var(--gold);text-transform:uppercase;letter-spacing:.8px;white-space:nowrap;margin-right:4px}
.eq-btn{
  flex:1;padding:5px 4px;border-radius:5px;font-family:'Space Mono',monospace;
  font-size:9px;font-weight:700;cursor:pointer;border:1px solid rgba(255,215,0,.2);
  background:transparent;color:var(--m);transition:all .15s;white-space:nowrap;
  -webkit-tap-highlight-color:transparent
}
.eq-btn:hover,.eq-btn.active{background:rgba(255,215,0,.15);color:var(--gold);border-color:rgba(255,215,0,.4)}

/* URL INPUT */
.url-section{margin-bottom:0}
.url-row{display:flex;gap:7px}
.url-row .f-input{margin-bottom:0;flex:1;font-size:11px}
.url-row .btn{width:auto;padding:11px 13px;white-space:nowrap;font-size:12px}
.url-divider{text-align:center;font-family:'Space Mono',monospace;font-size:9px;color:var(--m);margin:9px 0}

/* CANVAS */
canvas{width:100%;height:54px;display:block;border-radius:6px;background:var(--bg)}

/* LISTENERS */
.l-count{color:var(--c)}
.no-listeners{font-family:'Space Mono',monospace;font-size:11px;color:var(--m);text-align:center;padding:12px 0}
.listener-item{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--b);font-family:'Space Mono',monospace;font-size:11px}
.listener-item:last-child{border:none}
.listener-av{width:26px;height:26px;border-radius:6px;background:linear-gradient(135deg,var(--p),var(--c));display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}

/* SYNC BOX */
.sync-box{background:rgba(0,229,255,.04);border:1px solid rgba(0,229,255,.1);border-radius:8px;padding:10px 13px;font-family:'Space Mono',monospace;font-size:11px;color:var(--m);line-height:1.85}
.sync-box b{color:var(--c)}

/* HINT */
.hint-box{background:rgba(0,229,255,.04);border:1px solid rgba(0,229,255,.1);border-radius:8px;padding:10px 13px;font-family:'Space Mono',monospace;font-size:10px;color:var(--m);line-height:1.9;margin-bottom:10px}
.hint-box b{color:var(--c)}
.hint-box strong{color:var(--t)}

/* TOAST */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);background:#161b26;border:1px solid var(--b);border-radius:8px;padding:8px 16px;font-family:'Space Mono',monospace;font-size:11px;z-index:999;transition:transform .28s ease;white-space:nowrap;max-width:92vw;text-align:center}
.toast.on{transform:translateX(-50%) translateY(0)}

/* MOBILE UNLOCK OVERLAY */
#unlock-overlay{position:fixed;inset:0;background:rgba(7,8,13,.96);z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;cursor:pointer;-webkit-tap-highlight-color:transparent}
#unlock-overlay.gone{display:none}
.uo-icon{font-size:50px;animation:tap 1.5s infinite}
@keyframes tap{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}
.uo-title{font-size:20px;font-weight:800}
.uo-sub{font-family:'Space Mono',monospace;font-size:11px;color:var(--m);text-align:center;max-width:230px;line-height:1.65}
</style>
</head>
<body>

<!-- Mobile audio unlock -->
<div id="unlock-overlay" class="gone" onclick="unlockTap()">
  <div class="uo-icon">ğŸ‘†</div>
  <div class="uo-title">Tap to Enable Audio</div>
  <div class="uo-sub">Your browser needs one tap before audio can play automatically</div>
</div>

<div id="app">
  <div class="nav">
    <div class="nav-left">
      <div class="nav-icon">ğŸŒŠ</div>
      <div class="nav-name">WaveRoom</div>
    </div>
    <div class="nav-badge">âœ¦ DOLBY ENHANCED</div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• HOME â•â•â•â•â•â•â•â•â•â• -->
  <div id="s-home" class="screen on">
    <div class="hero">
      <div class="hero-badge">âš¡ Zero-lag multi-device sync</div>
      <h1>One Audio.<br><em>Every Device.</em><br>Same Moment.</h1>
      <p class="hero-sub">
        Host pastes a URL or shares tab audio.<br>
        Everyone in the room hears the exact same second<br>
        through their own speakers â€” with Dolby-style processing.
      </p>
      <div class="home-cards">
        <div class="hcard host-c" onclick="show('s-create')">
          <div class="hcard-icon">ğŸ™</div>
          <div class="hcard-title">Host a Room</div>
          <div class="hcard-desc">Load any audio URL. You control play/pause for everyone.</div>
        </div>
        <div class="hcard join-c" onclick="show('s-join')">
          <div class="hcard-icon">ğŸ§</div>
          <div class="hcard-title">Join a Room</div>
          <div class="hcard-desc">Enter a 6-letter code. Audio loads and syncs automatically.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• CREATE â•â•â•â•â•â•â•â•â•â• -->
  <div id="s-create" class="screen">
    <div class="fbox">
      <button class="back-btn" onclick="show('s-home')">â† Back</button>
      <div class="f-title">Host a Room</div>
      <div class="f-sub">Create a room. Load any audio. Everyone hears it in sync â€” no uploads needed from listeners.</div>
      <label class="f-label">Room Name</label>
      <input class="f-input" id="room-name" type="text" placeholder="Friday Night Session" maxlength="40">
      <button class="btn btn-c" onclick="createRoom()">Create Room â†’</button>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• JOIN â•â•â•â•â•â•â•â•â•â• -->
  <div id="s-join" class="screen">
    <div class="fbox">
      <button class="back-btn" onclick="show('s-home')">â† Back</button>
      <div class="f-title">Join a Room</div>
      <div class="f-sub">Enter the 6-letter code. Audio loads automatically â€” nothing to upload.</div>
      <label class="f-label">Room Code</label>
      <input class="f-input" id="join-code" type="text" placeholder="ABC123" maxlength="6" autocomplete="off">
      <div class="f-err" id="join-err">Room not found. Check the code and try again.</div>
      <button class="btn btn-p" onclick="joinRoom()">Join Room â†’</button>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• HOST ROOM â•â•â•â•â•â•â•â•â•â• -->
  <div id="s-host" class="screen">
    <div class="room-head">
      <div>
        <div class="room-name" id="h-room-name">Room</div>
        <div class="room-code" onclick="copyCode()">
          <span id="h-code">------</span>
          <small>tap to copy</small>
        </div>
      </div>
      <div id="h-pill" class="pill p-wait"><div class="dot d-m"></div><span>Paused</span></div>
    </div>

    <!-- Load Track Panel -->
    <div class="panel">
      <div class="ptitle">Load Audio for Everyone</div>
      <div class="hint-box">
        Paste any <b>audio URL</b> ending in .mp3 .wav .ogg â€” our server fetches it for everyone automatically.<br>
        <strong>Free music:</strong> Go to <b>archive.org</b> â†’ find any album â†’ right-click an MP3 â†’ Copy Link
      </div>
      <div class="url-row url-section">
        <input class="f-input" id="h-url" type="url" placeholder="https://example.com/song.mp3" autocomplete="off">
        <button class="btn btn-c" onclick="hostLoadUrl()">Load</button>
      </div>
      <div class="url-divider">â€” or pick from your device (only you hear local files) â€”</div>
      <label class="btn btn-g" style="cursor:pointer" onclick="G('h-file').click()">
        ğŸ“ Choose File
      </label>
      <input type="file" id="h-file" accept="audio/*" style="display:none" onchange="hostLoadFile()">
    </div>

    <!-- Player (hidden until track loaded) -->
    <div class="panel" id="h-player" style="display:none">
      <div class="dolby-badge">DOLBY âœ¦</div>
      <div class="track-info">
        <div class="track-art" id="h-art">ğŸµ</div>
        <div>
          <div class="track-name" id="h-track-name">â€”</div>
          <div class="track-sub" id="h-track-sub">â€”</div>
        </div>
      </div>
      <div class="seekbar" id="h-seekbar" onclick="hostSeek(event)">
        <div class="seekbar-track"><div class="seekbar-fill" id="h-prog"></div></div>
        <div class="seekbar-times"><span id="h-cur">0:00</span><span id="h-dur">0:00</span></div>
      </div>
      <div class="btn-row" style="margin-top:10px">
        <button class="btn btn-c" onclick="hostPlay()">â–¶ Play</button>
        <button class="btn btn-g" onclick="hostPause()">â¸ Pause</button>
        <button class="btn btn-g" onclick="hostRestart()">â® Restart</button>
      </div>
      <div class="vol-row">
        <span class="vol-lbl">ğŸ”Š Volume</span>
        <input type="range" min="0" max="1" step="0.01" value="0.9" oninput="setHostVol(this.value)">
      </div>
      <!-- Dolby EQ presets -->
      <div class="eq-row">
        <span class="eq-label">âœ¦ Sound</span>
        <button class="eq-btn active" id="eq-flat" onclick="setEQ('flat')">Flat</button>
        <button class="eq-btn" id="eq-dolby" onclick="setEQ('dolby')">Dolby</button>
        <button class="eq-btn" id="eq-bass" onclick="setEQ('bass')">Bass+</button>
        <button class="eq-btn" id="eq-vocal" onclick="setEQ('vocal')">Vocal</button>
        <button class="eq-btn" id="eq-spatial" onclick="setEQ('spatial')">Spatial</button>
      </div>
    </div>

    <!-- Visualizer -->
    <div class="panel">
      <div class="ptitle">Live Visualizer</div>
      <canvas id="h-viz"></canvas>
    </div>

    <!-- Listeners -->
    <div class="panel">
      <div class="ptitle" style="display:flex;justify-content:space-between">
        <span>Listeners Connected</span><span class="l-count" id="h-l-count">0</span>
      </div>
      <div id="h-listeners"><div class="no-listeners">No one joined yet â€” share your code!</div></div>
    </div>

    <div style="margin-top:10px"><button class="btn btn-g" onclick="leave()">Leave Room</button></div>
    <audio id="h-audio" crossorigin="anonymous" style="display:none"></audio>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• LISTENER ROOM â•â•â•â•â•â•â•â•â•â• -->
  <div id="s-listen" class="screen">
    <div class="room-head">
      <div>
        <div class="room-name" id="l-room-name">Room</div>
        <div style="font-family:'Space Mono',monospace;font-size:10px;color:var(--m);margin-top:3px" id="l-code-label"></div>
      </div>
      <div id="l-pill" class="pill p-wait"><div class="dot d-m"></div><span>Waiting...</span></div>
    </div>

    <div class="panel">
      <div class="dolby-badge">DOLBY âœ¦</div>
      <div class="track-info">
        <div class="track-art" id="l-art">ğŸµ</div>
        <div>
          <div class="track-name" id="l-track-name">Waiting for host...</div>
          <div class="track-sub">Host controls playback â€” you control your own volume</div>
        </div>
      </div>
      <div class="seekbar">
        <div class="seekbar-track"><div class="seekbar-fill" id="l-prog"></div></div>
        <div class="seekbar-times"><span id="l-cur">0:00</span><span id="l-dur">0:00</span></div>
      </div>
      <div class="vol-row" style="margin-top:10px">
        <span class="vol-lbl">ğŸ”Š Your Volume</span>
        <input type="range" min="0" max="1" step="0.01" value="0.9" oninput="setListenerVol(this.value)">
      </div>
      <!-- Dolby EQ for listener too -->
      <div class="eq-row">
        <span class="eq-label">âœ¦ Sound</span>
        <button class="eq-btn active" id="leq-flat" onclick="setEQL('flat')">Flat</button>
        <button class="eq-btn" id="leq-dolby" onclick="setEQL('dolby')">Dolby</button>
        <button class="eq-btn" id="leq-bass" onclick="setEQL('bass')">Bass+</button>
        <button class="eq-btn" id="leq-vocal" onclick="setEQL('vocal')">Vocal</button>
        <button class="eq-btn" id="leq-spatial" onclick="setEQL('spatial')">Spatial</button>
      </div>
    </div>

    <div class="panel">
      <div class="sync-box" id="l-sync-box">
        <b>Sync Status:</b> Waiting for host to load a track...
      </div>
    </div>

    <div class="panel">
      <div class="ptitle">Live Visualizer</div>
      <canvas id="l-viz"></canvas>
    </div>

    <div style="margin-top:10px"><button class="btn btn-g" onclick="leave()">Leave Room</button></div>
    <audio id="l-audio" crossorigin="anonymous" style="display:none"></audio>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const NTP_ROUNDS  = 10;   // more rounds = more accurate clock
const SCHED_MS    = 500;  // schedule play 500ms ahead â€” gives all devices time to prepare
const DRIFT_TOL   = 0.05; // 50ms drift tolerance before correction

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sock=null, roomCode=null, amHost=false;
let clockOffset=0, ntpSamples=[], ntpDone=false;
let pendingPlay=null, progRaf=null;
let listeners={};

// Audio nodes
let hostACtx=null, hostSrc=null, hostGain=null, hostEQ=null;
let listACtx=null, listSrc=null, listGain=null, listEQ=null;

// Visualizer
let vizACtx=null, vizAnalyser=null, vizRaf=null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const G = id => document.getElementById(id);

function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('on'));
  G(id).classList.add('on');
}

function toast(msg, dur=3500) {
  const t = G('toast'); t.textContent=msg; t.classList.add('on');
  setTimeout(()=>t.classList.remove('on'), dur);
}

function fmt(s) {
  if (!s||isNaN(s)) return '0:00';
  return Math.floor(s/60)+':'+(('0'+Math.floor(s%60)).slice(-2));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBILE UNLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function unlockTap() {
  G('unlock-overlay').classList.add('gone');
  if (vizACtx) vizACtx.resume();
  if (listACtx) listACtx.resume();
  const la = G('l-audio');
  if (la && la.src && la.paused) la.play().catch(()=>{});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOLBY-STYLE AUDIO PROCESSING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Creates: AudioContext â†’ Source â†’ EQ chain â†’ Compressor â†’ Gain â†’ Destination
// Each EQ preset applies different filter settings for Dolby-like effect

const EQ_PRESETS = {
  flat:    { sub:0,  bass:0,  mid:0,  high:0,  presence:0,  comp:false },
  dolby:   { sub:3,  bass:4,  mid:-1, high:3,  presence:2,  comp:true  }, // warm + airy
  bass:    { sub:8,  bass:7,  mid:-2, high:0,  presence:0,  comp:true  }, // heavy bass
  vocal:   { sub:-2, bass:-1, mid:4,  high:5,  presence:3,  comp:true  }, // clear vocals
  spatial: { sub:2,  bass:2,  mid:0,  high:5,  presence:4,  comp:true  }  // wide/open
};

function buildAudioChain(audioEl, isHost) {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const src = ctx.createMediaElementSource(audioEl);

    // 5-band EQ
    const subFilter   = ctx.createBiquadFilter(); // sub bass ~60Hz
    const bassFilter  = ctx.createBiquadFilter(); // bass ~200Hz
    const midFilter   = ctx.createBiquadFilter(); // mids ~1kHz
    const highFilter  = ctx.createBiquadFilter(); // highs ~8kHz
    const presFilter  = ctx.createBiquadFilter(); // presence ~14kHz

    subFilter.type   = 'lowshelf';   subFilter.frequency.value   = 60;
    bassFilter.type  = 'peaking';    bassFilter.frequency.value  = 200;   bassFilter.Q.value = 0.8;
    midFilter.type   = 'peaking';    midFilter.frequency.value   = 1000;  midFilter.Q.value = 0.8;
    highFilter.type  = 'peaking';    highFilter.frequency.value  = 8000;  highFilter.Q.value = 0.8;
    presFilter.type  = 'highshelf';  presFilter.frequency.value  = 14000;

    // Compressor (for Dolby warmth)
    const comp = ctx.createDynamicsCompressor();
    comp.threshold.value = -20;
    comp.knee.value = 10;
    comp.ratio.value = 4;
    comp.attack.value = 0.003;
    comp.release.value = 0.1;

    // Stereo widener (simple mid-side processing)
    const splitter = ctx.createChannelSplitter(2);
    const merger   = ctx.createChannelMerger(2);
    const wideGainL = ctx.createGain();
    const wideGainR = ctx.createGain();
    wideGainL.gain.value = 1.15;
    wideGainR.gain.value = 1.15;

    // Master gain
    const gain = ctx.createGain();
    gain.gain.value = 0.9;

    // Chain: src â†’ sub â†’ bass â†’ mid â†’ high â†’ pres â†’ comp â†’ gain â†’ dest
    src.connect(subFilter);
    subFilter.connect(bassFilter);
    bassFilter.connect(midFilter);
    midFilter.connect(highFilter);
    highFilter.connect(presFilter);
    presFilter.connect(comp);
    comp.connect(gain);
    gain.connect(ctx.destination);

    const eqNodes = { subFilter, bassFilter, midFilter, highFilter, presFilter, comp, gain };

    if (isHost) {
      hostACtx=ctx; hostSrc=src; hostGain=gain; hostEQ=eqNodes;
    } else {
      listACtx=ctx; listSrc=src; listGain=gain; listEQ=eqNodes;
    }

    // Also connect to analyser for visualizer
    if (!vizACtx) {
      vizACtx = ctx;
      vizAnalyser = ctx.createAnalyser();
      vizAnalyser.fftSize = 512;
      gain.connect(vizAnalyser);
    }

    return eqNodes;
  } catch(e) {
    console.warn('Audio chain error:', e);
    return null;
  }
}

function applyEQPreset(eqNodes, preset) {
  if (!eqNodes) return;
  const p = EQ_PRESETS[preset];
  eqNodes.subFilter.gain.value  = p.sub;
  eqNodes.bassFilter.gain.value = p.bass;
  eqNodes.midFilter.gain.value  = p.mid;
  eqNodes.highFilter.gain.value = p.high;
  eqNodes.presFilter.gain.value = p.presence;
  eqNodes.comp.ratio.value = p.comp ? 4 : 1;
}

function setEQ(preset) {
  applyEQPreset(hostEQ, preset);
  ['flat','dolby','bass','vocal','spatial'].forEach(p => {
    const btn = G('eq-'+p);
    if (btn) btn.classList.toggle('active', p===preset);
  });
}

function setEQL(preset) {
  applyEQPreset(listEQ, preset);
  ['flat','dolby','bass','vocal','spatial'].forEach(p => {
    const btn = G('leq-'+p);
    if (btn) btn.classList.toggle('active', p===preset);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initSock() {
  if (sock && sock.connected) return;
  sock = io({ transports: ['websocket','polling'] });

  sock.on('connect', () => {
    console.log('Connected:', sock.id);
    doNTP();
    // Keep Render from sleeping â€” ping every 10s
    if (window._keepAliveTimer) clearInterval(window._keepAliveTimer);
    window._keepAliveTimer = setInterval(() => {
      if (sock && sock.connected) sock.emit('keepalive');
    }, 10000);
  });

  // If server restarted (Render woke up), rooms are gone â€” warn user
  sock.on('disconnect', (reason) => {
    console.warn('Disconnected:', reason);
    if (reason === 'transport close' || reason === 'io server disconnect') {
      toast('âš ï¸ Reconnecting to server...');
    }
  });

  sock.on('reconnect', () => {
    toast('âœ… Reconnected!');
    doNTP();
    // If we were in a room, it's gone â€” send them back home
    if (roomCode) {
      toast('Session ended â€” server restarted. Please create a new room.');
      setTimeout(leave, 2000);
    }
  });

  sock.on('connect_error', () => toast('Connection error â€” check your internet'));

  sock.on('ntp:pong', ({ clientTime, serverTime }) => {
    const now = Date.now();
    const rtt = now - clientTime;
    ntpSamples.push({ rtt, offset: now - (serverTime + rtt/2) });
    if (ntpSamples.length < NTP_ROUNDS)
      setTimeout(() => sock.emit('ntp:ping', { clientTime: Date.now() }), 50);
    else finishNTP();
  });

  // HOST events
  sock.on('room:listener_joined', ({ id }) => {
    listeners[id] = true; renderListeners();
    // Immediately sync new listener with current track + state
    const a = G('h-audio');
    if (a.src) {
      // Re-send the track so they load it
      if (window._currentTrackUrl) {
        sock.emit('track:set', {
          url: window._currentTrackUrl,
          title: window._currentTrackTitle || 'Audio',
          proxyUrl: window._currentProxyUrl || window._currentTrackUrl
        });
      }
      setTimeout(() => {
        if (!a.paused) {
          const playAt = srvNow() + SCHED_MS;
          sock.emit('audio:play', { position: a.currentTime, serverPlayAt: playAt });
        } else {
          sock.emit('audio:pause', { position: a.currentTime });
        }
      }, 500);
    }
  });
  sock.on('room:listener_left', ({ id }) => { delete listeners[id]; renderListeners(); });
  sock.on('room:count', n => G('h-l-count').textContent = n);

  // LISTENER events â€” use proxyUrl if available for CORS-free loading
  sock.on('track:set', ({ url, title, proxyUrl }) => {
    loadListenerTrack(proxyUrl || url, title);
  });

  sock.on('audio:play', ({ position, serverPlayAt }) => schedPlay(position, serverPlayAt));

  sock.on('audio:pause', ({ position }) => {
    cancelSched();
    const a = G('l-audio');
    if (!a.src) return;
    a.pause(); a.currentTime = position;
    setPill('l-pill', 'p-wait', 'd-m', 'Paused');
    setSyncInfo('Host paused.');
    G('l-art').classList.remove('spin');
  });

  sock.on('audio:seek', ({ position, playing, serverPlayAt }) => {
    cancelSched();
    const a = G('l-audio');
    if (!a.src) return;
    a.currentTime = position;
    if (playing) schedPlay(position, serverPlayAt);
    else { a.pause(); G('l-art').classList.remove('spin'); }
  });

  sock.on('room:host_left', () => { toast('Host ended the session'); leave(); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NTP CLOCK SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doNTP() {
  ntpSamples=[]; ntpDone=false;
  sock.emit('ntp:ping', { clientTime: Date.now() });
}

function finishNTP() {
  // Use best 3 samples (lowest RTT = least network jitter)
  ntpSamples.sort((a,b) => a.rtt - b.rtt);
  const best = ntpSamples.slice(0, 3);
  clockOffset = best.reduce((s,x) => s + x.offset, 0) / best.length;
  ntpDone = true;
  console.log('NTP done. offset='+clockOffset.toFixed(1)+'ms bestRTT='+ntpSamples[0].rtt+'ms');
}

function srvNow() {
  return Date.now() - clockOffset; // our best estimate of server's current time
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ZERO-LAG SCHEDULED PLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function schedPlay(position, serverPlayAt) {
  cancelSched();
  const a = G('l-audio');
  if (!a.src) { setSyncInfo('âš ï¸ Waiting for audio to load...'); return; }

  // Convert server timestamp â†’ local time using our measured offset
  const localPlayAt = serverPlayAt + clockOffset;
  const msLeft = localPlayAt - Date.now();

  console.log('schedPlay: msLeft='+msLeft.toFixed(0)+'ms pos='+position.toFixed(3));

  function doPlay() {
    // Correct for any remaining latency
    const late = Math.max(0, (Date.now() - localPlayAt)) / 1000;
    const targetPos = Math.max(0, position + late);
    const drift = Math.abs(a.currentTime - targetPos);
    if (drift > DRIFT_TOL) a.currentTime = targetPos;

    a.play().then(() => {
      G('l-art').classList.add('spin');
      setPill('l-pill', 'p-sync', 'd-c', 'â— In Sync');
      setSyncInfo('ğŸ§ Playing in sync â€” drift: <b>'+Math.round(drift*1000)+'ms</b>');
      G('unlock-overlay').classList.add('gone');
      if (!vizACtx) buildAudioChain(a, false);
      if (listACtx) listACtx.resume();
      startProg(a, 'l-prog', 'l-cur', 'l-dur');
      startViz('l-viz');
    }).catch(() => {
      // Autoplay blocked â€” show tap overlay
      G('unlock-overlay').classList.remove('gone');
      setSyncInfo('ğŸ‘† Tap the screen once to start audio');
      G('unlock-overlay').onclick = () => {
        a.play().then(() => {
          unlockTap();
          G('l-art').classList.add('spin');
          setPill('l-pill', 'p-sync', 'd-c', 'â— In Sync');
          if (!vizACtx) buildAudioChain(a, false);
          startViz('l-viz');
        });
      };
    });
  }

  if (msLeft > 15) {
    // Pre-seek slightly before target and wait
    a.currentTime = Math.max(0, position - 0.01);
    pendingPlay = setTimeout(doPlay, msLeft);
  } else {
    // Already late â€” compensate position
    const elapsed = (-msLeft) / 1000;
    a.currentTime = Math.max(0, position + elapsed);
    doPlay();
  }
}

function cancelSched() {
  if (pendingPlay) { clearTimeout(pendingPlay); pendingPlay = null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CREATE / JOIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createRoom() {
  const name = G('room-name').value.trim() || 'Audio Room';
  initSock(); amHost = true;
  sock.emit('room:create', { name }, res => {
    if (!res.ok) { toast('Could not create room'); return; }
    roomCode = res.code;
    G('h-room-name').textContent = res.name;
    G('h-code').textContent = res.code;
    show('s-host');
    toast('Room created! Share code: ' + res.code + ' ğŸ‰');
  });
}

function joinRoom() {
  const code = G('join-code').value.trim().toUpperCase();
  if (!code) { toast('Enter a room code'); return; }
  if (code.length < 6) { toast('Code must be 6 characters'); return; }
  G('join-err').classList.remove('on');
  initSock(); amHost = false;

  function doJoin() {
    console.log('Attempting join:', code);
    sock.emit('room:join', { code }, res => {
      console.log('Join response:', JSON.stringify(res));
      if (!res || !res.ok) {
        G('join-err').textContent = 'Room not found. Check the code â€” host must still be in the room.';
        G('join-err').classList.add('on');
        return;
      }
      G('join-err').classList.remove('on');
      roomCode = code;
      G('l-room-name').textContent = res.name;
      G('l-code-label').textContent = 'Room: ' + code;
      show('s-listen');
      toast('Joined! ğŸ§');
      if (res.track) {
        const trackUrl = res.track.proxyUrl || res.track.url;
        loadListenerTrack(trackUrl, res.track.title, () => {
          if (res.state && res.state.playing && res.state.serverPlayAt) {
            const elapsed = (srvNow() - res.state.serverPlayAt) / 1000;
            schedPlay(Math.max(0, res.state.position + elapsed), srvNow() + SCHED_MS);
          } else if (res.state) {
            G('l-audio').currentTime = res.state.position || 0;
          }
        });
      }
    });
  }

  if (sock.connected) {
    doJoin();
  } else {
    toast('Connecting to server...');
    sock.once('connect', () => setTimeout(doJoin, 200));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD TRACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hostLoadUrl() {
  const rawUrl = G('h-url').value.trim();
  if (!rawUrl) { toast('Enter an audio URL'); return; }

  // Always route through our proxy â€” fixes ALL CORS issues
  const proxyUrl = '/proxy?url=' + encodeURIComponent(rawUrl);
  const title = rawUrl.split('/').pop().split('?')[0].replace(/\.[^.]+$/,'') || 'Audio';

  loadHostAudio(rawUrl, proxyUrl, title);
}

function hostLoadFile() {
  const f = G('h-file').files[0];
  if (!f) return;
  const localUrl = URL.createObjectURL(f);
  const title = f.name.replace(/\.[^.]+$/,'');
  // Local files can't be proxied â€” they only play on host device
  // We still need a shareable URL for listeners â€” warn the host
  window._currentTrackUrl = localUrl;
  window._currentTrackTitle = title;
  window._currentProxyUrl = null;
  loadHostAudio(localUrl, localUrl, title, true);
}

function loadHostAudio(originalUrl, proxyUrl, title, isLocal=false) {
  const a = G('h-audio');
  if (hostACtx) { hostACtx.close().catch(()=>{}); hostACtx=null; hostSrc=null; hostGain=null; hostEQ=null; }

  // Store for late-joining listeners
  window._currentTrackUrl = originalUrl;
  window._currentProxyUrl = isLocal ? null : proxyUrl;
  window._currentTrackTitle = title;

  // Host loads via proxy (fixes CORS for host too)
  a.src = proxyUrl; a.load();
  G('h-track-name').textContent = title;
  G('h-track-sub').textContent = 'Loading...';
  G('h-player').style.display = 'block';

  a.addEventListener('loadedmetadata', () => {
    G('h-dur').textContent = fmt(a.duration);
    G('h-track-sub').textContent = fmt(a.duration);
    buildAudioChain(a, true);
    startProg(a, 'h-prog', 'h-cur', 'h-dur');
    startViz('h-viz');
    if (isLocal) {
      toast('ğŸµ File loaded â€” only you can hear local files');
    } else {
      toast('âœ… Track loaded â€” press Play! â–¶');
    }
  }, { once: true });

  a.addEventListener('error', (e) => {
    console.error('Audio load error:', e);
    toast('âŒ Could not load â€” try a direct .mp3 link from archive.org');
  }, { once: true });

  // Tell all listeners to load via proxy URL
  if (!isLocal) {
    sock.emit('track:set', { url: originalUrl, title, proxyUrl });
  }
}

function loadListenerTrack(url, title, cb) {
  const a = G('l-audio');
  if (listACtx) { listACtx.close().catch(()=>{}); listACtx=null; listSrc=null; listGain=null; listEQ=null; vizACtx=null; vizAnalyser=null; }

  a.src = url; a.load();
  G('l-track-name').textContent = title || 'Loading...';
  setSyncInfo('Loading track...');

  a.addEventListener('canplay', () => {
    if (a.duration) G('l-dur').textContent = fmt(a.duration);
    setSyncInfo('âœ… Track ready â€” waiting for host to play');
    buildAudioChain(a, false);
    if (cb) cb();
  }, { once: true });

  a.addEventListener('error', (e) => {
    console.error('Listener audio error:', e);
    setSyncInfo('âŒ Could not load track. Ask host to use a direct .mp3 URL.');
  }, { once: true });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOST PLAYBACK CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hostPlay() {
  const a = G('h-audio');
  if (!a.src) { toast('Load a track first'); return; }
  if (hostACtx) hostACtx.resume();
  const pos = a.currentTime;
  const playAt = srvNow() + SCHED_MS;
  // Host also schedules its own play at the same time
  setTimeout(() => { a.play(); G('h-art').classList.add('spin'); }, SCHED_MS);
  setPill('h-pill', 'p-live', 'd-g', 'â— Playing');
  sock.emit('audio:play', { position: pos, serverPlayAt: playAt });
}

function hostPause() {
  const a = G('h-audio');
  a.pause(); G('h-art').classList.remove('spin');
  setPill('h-pill', 'p-wait', 'd-m', 'Paused');
  sock.emit('audio:pause', { position: a.currentTime });
}

function hostRestart() {
  const a = G('h-audio');
  a.currentTime = 0;
  if (hostACtx) hostACtx.resume();
  const playAt = srvNow() + SCHED_MS;
  setTimeout(() => { a.play(); G('h-art').classList.add('spin'); }, SCHED_MS);
  setPill('h-pill', 'p-live', 'd-g', 'â— Playing');
  sock.emit('audio:play', { position: 0, serverPlayAt: playAt });
}

function hostSeek(e) {
  const a = G('h-audio');
  if (!a.duration) return;
  const bar = e.currentTarget.querySelector('.seekbar-track');
  const rect = bar.getBoundingClientRect();
  const ratio = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
  const seekTo = ratio * a.duration;
  a.currentTime = seekTo;
  const playing = !a.paused;
  const playAt = srvNow() + SCHED_MS;
  if (playing) setTimeout(() => a.play(), SCHED_MS);
  sock.emit('audio:seek', { position: seekTo, playing, serverPlayAt: playAt });
}

function setHostVol(v) {
  const a = G('h-audio'); a.volume = parseFloat(v);
  if (hostGain) hostGain.gain.value = parseFloat(v);
}

function setListenerVol(v) {
  const a = G('l-audio'); a.volume = parseFloat(v);
  if (listGain) listGain.gain.value = parseFloat(v);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function leave() {
  cancelSched();
  if (progRaf) { cancelAnimationFrame(progRaf); progRaf=null; }
  stopViz();
  ['h-audio','l-audio'].forEach(id => { const a=G(id); if(a){a.pause();a.src='';} });
  if (hostACtx) { hostACtx.close().catch(()=>{}); hostACtx=null; }
  if (listACtx) { listACtx.close().catch(()=>{}); listACtx=null; }
  vizACtx=null; vizAnalyser=null;
  if (sock) { sock.disconnect(); sock=null; }
  roomCode=null; listeners={};
  show('s-home');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyCode() {
  navigator.clipboard.writeText(G('h-code').textContent).then(() => toast('Code copied! ğŸ“‹'));
}

function setSyncInfo(html) {
  G('l-sync-box').innerHTML = '<b>Sync Status:</b> ' + html;
}

function setPill(id, cls, dotCls, label) {
  const el = G(id);
  el.className = 'pill ' + cls;
  el.innerHTML = '<div class="dot '+dotCls+'"></div><span>'+label+'</span>';
}

function renderListeners() {
  const ids = Object.keys(listeners);
  G('h-l-count').textContent = ids.length;
  const el = G('h-listeners');
  if (!ids.length) { el.innerHTML='<div class="no-listeners">No one joined yet â€” share your code!</div>'; return; }
  el.innerHTML = ids.map((id,i) =>
    '<div class="listener-item"><div class="listener-av">ğŸ§</div><span>Listener '+(i+1)+'</span>'+
    '<span style="margin-left:auto;font-size:9px;color:var(--g)">â— synced</span></div>'
  ).join('');
}

function startProg(audio, fillId, curId, durId) {
  if (progRaf) { cancelAnimationFrame(progRaf); progRaf=null; }
  function tick() {
    progRaf = requestAnimationFrame(tick);
    const pct = audio.duration ? (audio.currentTime/audio.duration*100) : 0;
    G(fillId).style.width = pct + '%';
    G(curId).textContent = fmt(audio.currentTime);
    if (audio.duration) G(durId).textContent = fmt(audio.duration);
  }
  tick();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISUALIZER â€” frequency bars with glow
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startViz(canvasId) {
  if (vizRaf) { cancelAnimationFrame(vizRaf); vizRaf=null; }
  if (!vizAnalyser) return;
  const canvas = G(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth || 700, H = canvas.offsetHeight || 54;
  canvas.width = W; canvas.height = H;
  const buf = new Uint8Array(vizAnalyser.frequencyBinCount);
  const barW = (W / buf.length) * 2.5;

  function frame() {
    vizRaf = requestAnimationFrame(frame);
    vizAnalyser.getByteFrequencyData(buf);
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = '#07080d';
    ctx.fillRect(0,0,W,H);
    let x=0;
    for (let i=0; i<buf.length; i++) {
      const ratio = buf[i]/255;
      const h = ratio * H;
      const hue = 170 + (i/buf.length) * 120;
      const alpha = 0.7 + ratio * 0.3;
      // Bar
      ctx.fillStyle = `hsla(${hue},100%,60%,${alpha})`;
      ctx.fillRect(x, H-h, barW, h);
      // Glow top
      if (ratio > 0.5) {
        ctx.fillStyle = `hsla(${hue},100%,80%,0.6)`;
        ctx.fillRect(x, H-h-2, barW, 2);
      }
      x += barW + 1;
    }
  }
  frame();
}

function stopViz() {
  if (vizRaf) { cancelAnimationFrame(vizRaf); vizRaf=null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT FORMATTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
G('join-code').addEventListener('input', function() {
  this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g,'');
});
</script>
</body>
</html>
