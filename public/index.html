<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>WaveRoom â€” Sync Audio</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07080d;--s:#0c0e16;--b:#1a1f30;
  --c:#00e5ff;--p:#8b5cf6;--g:#00ff88;
  --r:#ff4466;--t:#e8edf8;--m:#4a5578;--gold:#ffd700
}
html,body{background:var(--bg);color:var(--t);font-family:'Syne',sans-serif;min-height:100vh;overscroll-behavior:none}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(var(--b) 1px,transparent 1px),linear-gradient(90deg,var(--b) 1px,transparent 1px);background-size:48px 48px;opacity:.12;pointer-events:none;z-index:0}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse 700px 400px at 15% 0%,rgba(0,229,255,.035),transparent),radial-gradient(ellipse 600px 500px at 85% 100%,rgba(139,92,246,.04),transparent)}
#app{position:relative;z-index:1;max-width:800px;margin:0 auto;padding:26px 16px}

.nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:40px}
.nav-left{display:flex;align-items:center;gap:10px}
.nav-icon{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,var(--c),var(--p));display:flex;align-items:center;justify-content:center;font-size:17px;box-shadow:0 0 16px rgba(0,229,255,.18)}
.nav-name{font-size:19px;font-weight:800;background:linear-gradient(135deg,var(--c),var(--p));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.nav-badge{font-family:'Space Mono',monospace;font-size:9px;color:var(--gold);border:1px solid rgba(255,215,0,.25);border-radius:20px;padding:2px 8px;background:rgba(255,215,0,.06)}

.screen{display:none}
.screen.on{display:block;animation:up .2s ease}
@keyframes up{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* HOME */
.hero{text-align:center;padding:8px 0 28px}
.hero-chip{display:inline-flex;align-items:center;gap:5px;font-family:'Space Mono',monospace;font-size:10px;color:var(--c);border:1px solid rgba(0,229,255,.18);border-radius:20px;padding:3px 10px;margin-bottom:18px;background:rgba(0,229,255,.05)}
.hero h1{font-size:clamp(30px,6vw,58px);font-weight:800;letter-spacing:-2px;line-height:1.05;margin-bottom:12px}
.hero h1 em{font-style:normal;background:linear-gradient(135deg,var(--c),var(--p));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero-sub{font-family:'Space Mono',monospace;font-size:12px;color:var(--m);max-width:360px;margin:0 auto 28px;line-height:1.9}
.home-cards{display:grid;grid-template-columns:1fr 1fr;gap:11px;max-width:500px;margin:0 auto}
@media(max-width:420px){.home-cards{grid-template-columns:1fr}}
.hcard{background:var(--s);border:1px solid var(--b);border-radius:13px;padding:20px 16px;cursor:pointer;text-align:left;transition:border-color .18s,transform .18s;-webkit-tap-highlight-color:transparent;position:relative;overflow:hidden}
.hcard:hover,.hcard:active{border-color:rgba(0,229,255,.35);transform:translateY(-2px)}
.hi{font-size:22px;margin-bottom:8px}.ht{font-size:15px;font-weight:700;margin-bottom:3px}
.hd{font-size:11px;color:var(--m);font-family:'Space Mono',monospace;line-height:1.5}

/* FORM */
.fbox{max-width:390px;margin:0 auto}
.back{background:none;border:none;color:var(--m);font-family:'Space Mono',monospace;font-size:11px;cursor:pointer;margin-bottom:24px;padding:0;transition:color .18s}
.back:hover{color:var(--c)}
.ftitle{font-size:26px;font-weight:800;letter-spacing:-1px;margin-bottom:4px}
.fsub{font-family:'Space Mono',monospace;font-size:11px;color:var(--m);margin-bottom:20px;line-height:1.7}
.fl{display:block;font-size:9px;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--m);margin-bottom:5px}
.fi{width:100%;background:var(--s);border:1px solid var(--b);border-radius:8px;padding:11px 13px;color:var(--t);font-family:'Space Mono',monospace;font-size:13px;outline:none;transition:border-color .18s;margin-bottom:12px}
.fi:focus{border-color:var(--c)}
.fi::placeholder{color:var(--m)}
#join-code{letter-spacing:5px;font-size:20px;text-transform:uppercase;text-align:center}

.btn{width:100%;padding:12px;border-radius:8px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;border:none;transition:all .18s;display:flex;align-items:center;justify-content:center;gap:6px;-webkit-tap-highlight-color:transparent}
.bc{background:linear-gradient(135deg,var(--c),#009eb5);color:#000}
.bc:hover{box-shadow:0 5px 18px rgba(0,229,255,.28);transform:translateY(-1px)}
.bp{background:linear-gradient(135deg,var(--p),#6d28d9);color:#fff}
.bp:hover{box-shadow:0 5px 18px rgba(139,92,246,.3);transform:translateY(-1px)}
.bg{background:var(--s);border:1px solid var(--b);color:var(--t)}
.bg:hover,.bg:active{border-color:var(--c);color:var(--c)}
.br{background:rgba(255,68,102,.15);border:1px solid rgba(255,68,102,.3);color:var(--r)}
.btn:disabled{opacity:.28;cursor:not-allowed;transform:none!important;box-shadow:none!important}
.brow{display:flex;gap:7px}
.brow .btn{width:auto;flex:1;padding:9px 6px;font-size:12px}
.ferr{background:rgba(255,68,102,.08);border:1px solid rgba(255,68,102,.25);border-radius:7px;padding:8px 12px;font-family:'Space Mono',monospace;font-size:11px;color:var(--r);margin-bottom:11px;display:none;line-height:1.6}
.ferr.on{display:block}

/* ROOM */
.rhead{display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:9px;margin-bottom:14px}
.rname{font-size:20px;font-weight:800;letter-spacing:-.5px}
.rcode{display:inline-flex;align-items:center;gap:6px;margin-top:4px;background:var(--s);border:1px solid var(--b);border-radius:7px;padding:5px 10px;font-family:'Space Mono',monospace;font-size:17px;font-weight:700;letter-spacing:4px;color:var(--c);cursor:pointer;transition:border-color .18s;-webkit-tap-highlight-color:transparent}
.rcode:hover,.rcode:active{border-color:var(--c)}
.rcode small{font-size:9px;color:var(--m);letter-spacing:0}
.pill{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:100px;font-family:'Space Mono',monospace;font-size:10px;font-weight:700}
.pl{background:rgba(0,255,136,.1);color:var(--g);border:1px solid rgba(0,255,136,.22)}
.pw{background:rgba(74,85,120,.13);color:var(--m);border:1px solid var(--b)}
.ps{background:rgba(0,229,255,.1);color:var(--c);border:1px solid rgba(0,229,255,.2)}
.dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.dg{background:var(--g);animation:bl 1.3s infinite}
.dm{background:var(--m)}
.dc{background:var(--c);animation:bl 1.3s infinite}
@keyframes bl{0%,100%{opacity:1}50%{opacity:.28}}

.panel{background:var(--s);border:1px solid var(--b);border-radius:12px;padding:15px;margin-bottom:10px;position:relative}
.ptitle{font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--m);font-family:'Space Mono',monospace;margin-bottom:10px}
.dbadge{position:absolute;top:13px;right:13px;font-family:'Space Mono',monospace;font-size:8px;font-weight:700;color:var(--gold);border:1px solid rgba(255,215,0,.25);border-radius:4px;padding:2px 5px;background:rgba(255,215,0,.06);letter-spacing:1px}

/* LOAD SECTION */
.load-panel{background:var(--s);border:1px solid var(--b);border-radius:12px;padding:15px;margin-bottom:10px}
.src-tabs{display:flex;gap:6px;margin-bottom:12px}
.src-tab{flex:1;padding:7px;border-radius:7px;font-family:'Space Mono',monospace;font-size:10px;font-weight:700;cursor:pointer;border:1px solid var(--b);background:transparent;color:var(--m);transition:all .15s;-webkit-tap-highlight-color:transparent;text-align:center}
.src-tab.active{background:rgba(0,229,255,.1);color:var(--c);border-color:rgba(0,229,255,.3)}
.src-pane{display:none}
.src-pane.on{display:block}
.url-row{display:flex;gap:7px}
.url-row .fi{margin-bottom:0;flex:1;font-size:11px}
.url-row .btn{width:auto;padding:11px 14px;white-space:nowrap;font-size:12px}

/* STATUS BAR */
.load-status{display:flex;align-items:center;gap:7px;margin-top:9px;font-family:'Space Mono',monospace;font-size:11px;min-height:20px;color:var(--m)}
.load-status .spin{display:inline-block;animation:rot .7s linear infinite}
@keyframes rot{to{transform:rotate(360deg)}}

/* PLAYER */
.tinfo{display:flex;align-items:center;gap:10px;margin-bottom:13px}
.tart{width:40px;height:40px;border-radius:9px;flex-shrink:0;background:linear-gradient(135deg,var(--p),var(--c));display:flex;align-items:center;justify-content:center;font-size:18px;animation:rot 10s linear infinite;animation-play-state:paused;box-shadow:0 4px 12px rgba(0,229,255,.12)}
.tart.spin{animation-play-state:running}
.tname{font-size:13px;font-weight:700;word-break:break-all;line-height:1.3}
.tsub{font-family:'Space Mono',monospace;font-size:10px;color:var(--m);margin-top:2px}
.seekbar{padding:5px 0;cursor:pointer;margin-bottom:4px;user-select:none}
.seek-track{width:100%;height:4px;background:var(--b);border-radius:10px;overflow:hidden}
.seek-fill{height:100%;width:0%;border-radius:10px;transition:width .2s linear;background:linear-gradient(90deg,var(--c),var(--p))}
.seek-times{display:flex;justify-content:space-between;font-family:'Space Mono',monospace;font-size:9px;color:var(--m);margin-top:4px}
.vol{display:flex;align-items:center;gap:7px;margin-top:10px}
.vol-lbl{font-family:'Space Mono',monospace;font-size:10px;color:var(--m);white-space:nowrap}
input[type=range]{flex:1;accent-color:var(--c);cursor:pointer;height:16px}

/* DOLBY EQ */
.eq-row{display:flex;align-items:center;gap:5px;margin-top:11px;padding:8px 10px;background:rgba(255,215,0,.04);border:1px solid rgba(255,215,0,.1);border-radius:7px;flex-wrap:wrap}
.eq-lbl{font-family:'Space Mono',monospace;font-size:9px;color:var(--gold);text-transform:uppercase;letter-spacing:.8px;white-space:nowrap;margin-right:2px}
.eq-btn{flex:1;min-width:46px;padding:5px 3px;border-radius:5px;font-family:'Space Mono',monospace;font-size:9px;font-weight:700;cursor:pointer;border:1px solid rgba(255,215,0,.15);background:transparent;color:var(--m);transition:all .14s;-webkit-tap-highlight-color:transparent;text-align:center}
.eq-btn:hover,.eq-btn.on{background:rgba(255,215,0,.12);color:var(--gold);border-color:rgba(255,215,0,.35)}

canvas{width:100%;height:52px;display:block;border-radius:6px;background:var(--bg)}

/* LISTENERS */
.lcnt{color:var(--c)}
.nol{font-family:'Space Mono',monospace;font-size:11px;color:var(--m);text-align:center;padding:11px 0}
.litem{display:flex;align-items:center;gap:7px;padding:6px 0;border-bottom:1px solid var(--b);font-family:'Space Mono',monospace;font-size:11px}
.litem:last-child{border:none}
.lav{width:24px;height:24px;border-radius:5px;background:linear-gradient(135deg,var(--p),var(--c));display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0}

/* SYNC BOX */
.sbox{background:rgba(0,229,255,.04);border:1px solid rgba(0,229,255,.1);border-radius:8px;padding:9px 12px;font-family:'Space Mono',monospace;font-size:11px;color:var(--m);line-height:1.85}
.sbox b{color:var(--c)}

/* TOAST */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);background:#161b26;border:1px solid var(--b);border-radius:8px;padding:9px 16px;font-family:'Space Mono',monospace;font-size:11px;z-index:999;transition:transform .28s ease;white-space:nowrap;max-width:94vw;text-align:center;pointer-events:none}
.toast.on{transform:translateX(-50%) translateY(0)}

/* UNLOCK */
#unlock{position:fixed;inset:0;background:rgba(7,8,13,.96);z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:13px;cursor:pointer;-webkit-tap-highlight-color:transparent}
#unlock.gone{display:none}
.ui{font-size:48px;animation:tap 1.5s infinite}
@keyframes tap{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.ut{font-size:19px;font-weight:800}
.us{font-family:'Space Mono',monospace;font-size:11px;color:var(--m);text-align:center;max-width:230px;line-height:1.65}
</style>
</head>
<body>

<div id="unlock" class="gone" onclick="doUnlock()">
  <div class="ui">ğŸ‘†</div>
  <div class="ut">Tap to Enable Audio</div>
  <div class="us">Your browser needs one tap before audio plays automatically</div>
</div>

<div id="app">
  <div class="nav">
    <div class="nav-left">
      <div class="nav-icon">ğŸŒŠ</div>
      <div class="nav-name">WaveRoom</div>
    </div>
    <div class="nav-badge">âœ¦ DOLBY</div>
  </div>

  <!-- HOME -->
  <div id="s-home" class="screen on">
    <div class="hero">
      <div class="hero-chip">âš¡ Zero-lag Â· All devices Â· Dolby sound</div>
      <h1>One Audio.<br><em>Every Device.</em><br>Same Second.</h1>
      <p class="hero-sub">Host pastes a YouTube link or any audio URL.<br>Every listener hears the exact same moment<br>on their own speaker â€” perfectly in sync.</p>
      <div class="home-cards">
        <div class="hcard" onclick="show('s-create')">
          <div class="hi">ğŸ™</div>
          <div class="ht">Host a Room</div>
          <div class="hd">Paste any URL. Control play/pause for everyone.</div>
        </div>
        <div class="hcard" onclick="show('s-join')">
          <div class="hi">ğŸ§</div>
          <div class="ht">Join a Room</div>
          <div class="hd">Enter 6-letter code. Audio syncs automatically.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- CREATE -->
  <div id="s-create" class="screen">
    <div class="fbox">
      <button class="back" onclick="show('s-home')">â† Back</button>
      <div class="ftitle">Host a Room</div>
      <div class="fsub">Create a room. Load any audio. You control playback for everyone â€” no uploads needed for listeners.</div>
      <label class="fl">Room Name (optional)</label>
      <input class="fi" id="rname-input" type="text" placeholder="Friday Night Session" maxlength="40">
      <button class="btn bc" onclick="createRoom()">Create Room â†’</button>
    </div>
  </div>

  <!-- JOIN -->
  <div id="s-join" class="screen">
    <div class="fbox">
      <button class="back" onclick="show('s-home')">â† Back</button>
      <div class="ftitle">Join a Room</div>
      <div class="fsub">Enter the 6-letter code. Audio loads and plays automatically in sync.</div>
      <label class="fl">Room Code</label>
      <input class="fi" id="join-code" type="text" placeholder="ABC123" maxlength="6" autocomplete="off" spellcheck="false">
      <div class="ferr" id="join-err">Room not found. Make sure the host is still connected and the code is correct.</div>
      <button class="btn bp" onclick="joinRoom()">Join Room â†’</button>
    </div>
  </div>

  <!-- HOST ROOM -->
  <div id="s-host" class="screen">
    <div class="rhead">
      <div>
        <div class="rname" id="h-rname">Room</div>
        <div class="rcode" onclick="copyCode()">
          <span id="h-code">------</span>
          <small>tap to copy</small>
        </div>
      </div>
      <div id="h-pill" class="pill pw"><div class="dot dm"></div><span>Paused</span></div>
    </div>

    <!-- Load Track -->
    <div class="load-panel">
      <div class="ptitle">Load Audio for Everyone</div>
      <div class="src-tabs">
        <button class="src-tab active" onclick="switchTab('youtube')">â–¶ YouTube</button>
        <button class="src-tab" onclick="switchTab('url')">ğŸ”— Direct URL</button>
        <button class="src-tab" onclick="switchTab('file')">ğŸ“ File</button>
      </div>

      <!-- YouTube pane -->
      <div class="src-pane on" id="pane-youtube">
        <div class="url-row">
          <input class="fi" id="yt-url" type="url" placeholder="Paste YouTube URL..." autocomplete="off">
          <button class="btn bc" onclick="loadYoutube()">Load</button>
        </div>
        <div class="load-status" id="yt-status"></div>
      </div>

      <!-- Direct URL pane -->
      <div class="src-pane" id="pane-url">
        <div class="url-row">
          <input class="fi" id="direct-url" type="url" placeholder="https://example.com/song.mp3" autocomplete="off">
          <button class="btn bc" onclick="loadDirectUrl()">Load</button>
        </div>
        <div class="load-status" id="url-status"></div>
      </div>

      <!-- File pane -->
      <div class="src-pane" id="pane-file">
        <button class="btn bg" onclick="G('file-input').click()" style="margin-bottom:8px">
          ğŸ“ Choose Audio File
        </button>
        <input type="file" id="file-input" accept="audio/*" style="display:none" onchange="loadFile()">
        <div style="font-family:'Space Mono',monospace;font-size:10px;color:var(--m);line-height:1.65">
          âš ï¸ Local files only play on your device.<br>Use YouTube or URL tab so everyone hears it.
        </div>
        <div class="load-status" id="file-status"></div>
      </div>
    </div>

    <!-- Player (hidden until loaded) -->
    <div class="panel" id="h-player" style="display:none">
      <div class="dbadge">DOLBY âœ¦</div>
      <div class="tinfo">
        <div class="tart" id="h-art">ğŸµ</div>
        <div>
          <div class="tname" id="h-tname">â€”</div>
          <div class="tsub" id="h-tsub">â€”</div>
        </div>
      </div>
      <div class="seekbar" id="h-seekbar" onclick="hostSeek(event)">
        <div class="seek-track"><div class="seek-fill" id="h-fill"></div></div>
        <div class="seek-times"><span id="h-cur">0:00</span><span id="h-dur">0:00</span></div>
      </div>
      <div class="brow" style="margin-top:10px">
        <button class="btn bc" onclick="hostPlay()">â–¶ Play</button>
        <button class="btn bg" onclick="hostPause()">â¸ Pause</button>
        <button class="btn bg" onclick="hostRestart()">â®</button>
      </div>
      <div class="vol">
        <span class="vol-lbl">ğŸ”Š Vol</span>
        <input type="range" min="0" max="1" step="0.01" value="0.9" id="h-vol" oninput="hostVolChange(this.value)">
      </div>
      <div class="eq-row">
        <span class="eq-lbl">âœ¦ Sound</span>
        <button class="eq-btn on" id="heq-flat"    onclick="setEQ(this,'h')">Flat</button>
        <button class="eq-btn"    id="heq-dolby"   onclick="setEQ(this,'h')">Dolby</button>
        <button class="eq-btn"    id="heq-bass"    onclick="setEQ(this,'h')">Bass+</button>
        <button class="eq-btn"    id="heq-vocal"   onclick="setEQ(this,'h')">Vocal</button>
        <button class="eq-btn"    id="heq-spatial" onclick="setEQ(this,'h')">Spatial</button>
      </div>
    </div>

    <!-- Visualizer -->
    <div class="panel">
      <div class="ptitle">Live Visualizer</div>
      <canvas id="h-viz"></canvas>
    </div>

    <!-- Listeners -->
    <div class="panel">
      <div class="ptitle" style="display:flex;justify-content:space-between">
        <span>Listeners</span><span class="lcnt" id="h-lcnt">0</span>
      </div>
      <div id="h-llist"><div class="nol">No one joined yet â€” share your code!</div></div>
    </div>

    <div style="margin-top:10px"><button class="btn bg" onclick="leave()">Leave Room</button></div>
    <audio id="h-audio" crossorigin="anonymous" style="display:none" preload="auto"></audio>
  </div>

  <!-- LISTENER ROOM -->
  <div id="s-listen" class="screen">
    <div class="rhead">
      <div>
        <div class="rname" id="l-rname">Room</div>
        <div style="font-family:'Space Mono',monospace;font-size:10px;color:var(--m);margin-top:3px" id="l-clabel"></div>
      </div>
      <div id="l-pill" class="pill pw"><div class="dot dm"></div><span>Waiting...</span></div>
    </div>

    <div class="panel">
      <div class="dbadge">DOLBY âœ¦</div>
      <div class="tinfo">
        <div class="tart" id="l-art">ğŸµ</div>
        <div>
          <div class="tname" id="l-tname">Waiting for host...</div>
          <div class="tsub">Host controls playback â€¢ you control your volume</div>
        </div>
      </div>
      <div class="seekbar">
        <div class="seek-track"><div class="seek-fill" id="l-fill"></div></div>
        <div class="seek-times"><span id="l-cur">0:00</span><span id="l-dur">0:00</span></div>
      </div>
      <div class="vol" style="margin-top:10px">
        <span class="vol-lbl">ğŸ”Š Your Volume</span>
        <input type="range" min="0" max="1" step="0.01" value="0.9" oninput="listVolChange(this.value)">
      </div>
      <div class="eq-row">
        <span class="eq-lbl">âœ¦ Sound</span>
        <button class="eq-btn on" id="leq-flat"    onclick="setEQ(this,'l')">Flat</button>
        <button class="eq-btn"    id="leq-dolby"   onclick="setEQ(this,'l')">Dolby</button>
        <button class="eq-btn"    id="leq-bass"    onclick="setEQ(this,'l')">Bass+</button>
        <button class="eq-btn"    id="leq-vocal"   onclick="setEQ(this,'l')">Vocal</button>
        <button class="eq-btn"    id="leq-spatial" onclick="setEQ(this,'l')">Spatial</button>
      </div>
    </div>

    <div class="panel">
      <div class="sbox" id="l-sync"><b>Sync Status:</b> Waiting for host to load a track...</div>
    </div>

    <div class="panel">
      <div class="ptitle">Live Visualizer</div>
      <canvas id="l-viz"></canvas>
    </div>

    <div style="margin-top:10px"><button class="btn bg" onclick="leave()">Leave Room</button></div>
    <audio id="l-audio" crossorigin="anonymous" style="display:none" preload="auto"></audio>
  </div>
</div>
<div id="toast" class="toast"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const NTP_ROUNDS = 10;
const SCHED_MS   = 600;   // 600ms scheduling window
const DRIFT_TOL  = 0.06;  // 60ms

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sock=null, roomCode=null, amHost=false;
let clockOffset=0, ntpSamples=[], ntpDone=false;
let pendingPlay=null, progRaf=null;
let listeners={};
let hACtx=null, hEQ=null, hGain=null;
let lACtx=null, lEQ=null, lGain=null;
let vizAn=null, vizRaf=null;
let currentTrack=null; // {url, title, streamUrl}

// EQ presets
const EQ = {
  flat:    [0,  0,  0,  0,  0,  false],
  dolby:   [3,  4, -1,  3,  2,  true ],
  bass:    [8,  7, -2,  0,  0,  true ],
  vocal:   [-2,-1,  4,  5,  3,  true ],
  spatial: [2,  2,  0,  5,  4,  true ],
};

const G = id => document.getElementById(id);

function show(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('on'));
  G(id).classList.add('on');
}

function toast(msg, dur=3500) {
  const t=G('toast'); t.textContent=msg; t.classList.add('on');
  clearTimeout(t._t);
  t._t=setTimeout(()=>t.classList.remove('on'), dur);
}

function fmt(s) {
  if (!s||isNaN(s)||!isFinite(s)) return '0:00';
  return Math.floor(s/60)+':'+(('0'+Math.floor(s%60)).slice(-2));
}

function srvNow() { return Date.now()-clockOffset; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBILE UNLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doUnlock() {
  G('unlock').classList.add('gone');
  if (lACtx) lACtx.resume();
  if (hACtx) hACtx.resume();
  const la=G('l-audio');
  if (la.src && la.paused) la.play().catch(()=>{});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name) {
  document.querySelectorAll('.src-tab').forEach((t,i)=>{
    const names=['youtube','url','file'];
    t.classList.toggle('active', names[i]===name);
    G('pane-'+names[i]).classList.toggle('on', names[i]===name);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatus(id, html) {
  G(id).innerHTML = html;
}

async function loadYoutube() {
  const raw = G('yt-url').value.trim();
  if (!raw) { toast('Paste a YouTube URL'); return; }
  setStatus('yt-status', '<span class="spin">âŸ³</span> Fetching YouTube audio...');
  try {
    const res = await fetch('/yt-info?url='+encodeURIComponent(raw));
    const data = await res.json();
    if (!res.ok || data.error) {
      setStatus('yt-status', 'âŒ '+data.error);
      return;
    }
    // Stream through our server to avoid CORS
    const streamUrl = '/yt-stream?url='+encodeURIComponent(raw);
    setStatus('yt-status', 'âœ… '+data.title);
    applyTrack(streamUrl, data.title, raw);
  } catch(e) {
    setStatus('yt-status', 'âŒ Failed: '+e.message);
  }
}

function loadDirectUrl() {
  const raw = G('direct-url').value.trim();
  if (!raw) { toast('Enter a URL'); return; }
  setStatus('url-status', '<span class="spin">âŸ³</span> Loading...');
  // Route through proxy to fix CORS
  const proxyUrl = '/proxy?url='+encodeURIComponent(raw);
  const title = raw.split('/').pop().split('?')[0].replace(/\.[^.]+$/,'') || 'Audio';
  applyTrack(proxyUrl, title, raw);
  setStatus('url-status', 'âŸ³ Connecting...');
}

function loadFile() {
  const f = G('file-input').files[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  const title = f.name.replace(/\.[^.]+$/,'');
  setStatus('file-status', 'âš ï¸ Local file â€” only plays on your device');
  applyTrack(url, title, null, true);
}

function applyTrack(streamUrl, title, originalUrl, isLocal=false) {
  const a = G('h-audio');
  teardownAudio('h');

  currentTrack = { streamUrl, title, originalUrl, isLocal };

  a.src = streamUrl;
  a.load();
  G('h-tname').textContent = title;
  G('h-tsub').textContent = 'Loading...';
  G('h-player').style.display = 'block';

  a.onloadedmetadata = () => {
    G('h-dur').textContent = fmt(a.duration);
    G('h-tsub').textContent = fmt(a.duration) + (isLocal?' (local only)':'');
    buildChain(a, 'h');
    startProg(a,'h-fill','h-cur','h-dur');
    startViz('h-viz');
    setStatus('yt-status','âœ… Ready â€” press Play!');
    setStatus('url-status','âœ… Ready â€” press Play!');
    setStatus('file-status','âœ… '+title);
    toast('âœ… Track loaded â€” press Play! â–¶');
  };

  a.onerror = (e) => {
    const msg = a.error ? ['','ABORTED','NETWORK_ERROR','DECODE_ERROR','SRC_NOT_SUPPORTED'][a.error.code]||a.error.code : 'unknown';
    console.error('Audio error:', msg, e);
    setStatus('yt-status','âŒ Could not load: '+msg);
    setStatus('url-status','âŒ Could not load: '+msg);
    toast('âŒ Audio failed: '+msg);
  };

  // Share with listeners (unless local file)
  if (!isLocal && sock) {
    sock.emit('track:set', { streamUrl, title, originalUrl });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOLBY AUDIO CHAIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildChain(audioEl, side) {
  teardownAudio(side);
  try {
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const src = ctx.createMediaElementSource(audioEl);
    const sub  = makeFilter(ctx,'lowshelf',60);
    const bass = makeFilter(ctx,'peaking',200,0.8);
    const mid  = makeFilter(ctx,'peaking',1000,0.8);
    const hi   = makeFilter(ctx,'peaking',8000,0.8);
    const pres = makeFilter(ctx,'highshelf',14000);
    const comp = ctx.createDynamicsCompressor();
    comp.threshold.value=-18; comp.knee.value=10; comp.ratio.value=4;
    comp.attack.value=0.003; comp.release.value=0.1;
    const gain = ctx.createGain();
    gain.gain.value = 0.9;
    const an = ctx.createAnalyser();
    an.fftSize = 512;
    src.connect(sub); sub.connect(bass); bass.connect(mid);
    mid.connect(hi); hi.connect(pres); pres.connect(comp);
    comp.connect(gain); gain.connect(an); an.connect(ctx.destination);
    const eq = {sub,bass,mid,hi,pres,comp};
    if (side==='h') { hACtx=ctx; hEQ=eq; hGain=gain; vizAn=an; }
    else            { lACtx=ctx; lEQ=eq; lGain=gain; vizAn=an; }
    return {ctx,eq,gain,an};
  } catch(e) { console.warn('chain err',e); return null; }
}

function makeFilter(ctx,type,freq,q) {
  const f=ctx.createBiquadFilter();
  f.type=type; f.frequency.value=freq;
  if (q) f.Q.value=q;
  return f;
}

function teardownAudio(side) {
  if (side==='h' && hACtx) { hACtx.close().catch(()=>{}); hACtx=null; hEQ=null; hGain=null; }
  if (side==='l' && lACtx) { lACtx.close().catch(()=>{}); lACtx=null; lEQ=null; lGain=null; }
}

function setEQ(btn, side) {
  const preset = btn.id.replace(/^[hl]eq-/,'');
  const vals = EQ[preset];
  const eq = side==='h' ? hEQ : lEQ;
  if (eq) {
    eq.sub.gain.value=vals[0]; eq.bass.gain.value=vals[1];
    eq.mid.gain.value=vals[2]; eq.hi.gain.value=vals[3];
    eq.pres.gain.value=vals[4]; eq.comp.ratio.value=vals[5]?4:1;
  }
  document.querySelectorAll(`[id^="${side}eq-"]`).forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initSock() {
  if (sock && sock.connected) return;
  sock = io({ transports:['websocket','polling'], reconnectionAttempts: 10 });

  sock.on('connect', () => {
    console.log('Connected:', sock.id);
    doNTP();
    clearInterval(window._ka);
    window._ka = setInterval(()=>{ if(sock&&sock.connected) sock.emit('keepalive'); }, 10000);
  });

  sock.on('disconnect', reason => {
    console.warn('Disconnect:', reason);
    if (roomCode) toast('âš ï¸ Connection lost â€” reconnecting...');
  });

  sock.on('reconnect', () => {
    toast('âœ… Reconnected!');
    doNTP();
    if (roomCode && !amHost) {
      toast('Session ended â€” server restarted. Rejoin the room.');
      setTimeout(leave, 2500);
    }
  });

  sock.on('connect_error', ()=> toast('Cannot connect to server'));

  sock.on('ntp:pong', ({clientTime, serverTime}) => {
    const now=Date.now(), rtt=now-clientTime;
    ntpSamples.push({rtt, offset: now-(serverTime+rtt/2)});
    if (ntpSamples.length<NTP_ROUNDS)
      setTimeout(()=>sock.emit('ntp:ping',{clientTime:Date.now()}),50);
    else finishNTP();
  });

  // HOST
  sock.on('room:listener_joined', ({id}) => {
    listeners[id]=true; renderListeners();
    // Send current track + state to new joiner
    if (currentTrack && !currentTrack.isLocal) {
      sock.emit('track:set',{
        streamUrl: currentTrack.streamUrl,
        title: currentTrack.title,
        originalUrl: currentTrack.originalUrl
      });
      const a=G('h-audio');
      if (a.src) {
        setTimeout(()=>{
          if (!a.paused) sock.emit('audio:play',{position:a.currentTime, serverPlayAt:srvNow()+SCHED_MS});
          else sock.emit('audio:pause',{position:a.currentTime});
        }, 800);
      }
    }
  });
  sock.on('room:listener_left', ({id})=>{ delete listeners[id]; renderListeners(); });
  sock.on('room:count', n=>G('h-lcnt').textContent=n);

  // LISTENER
  sock.on('track:set', ({streamUrl, title}) => loadListenerTrack(streamUrl, title));
  sock.on('audio:play', ({position, serverPlayAt}) => schedPlay(position, serverPlayAt));
  sock.on('audio:pause', ({position}) => {
    cancelSched();
    const a=G('l-audio'); if(!a.src)return;
    a.pause(); a.currentTime=position;
    G('l-art').classList.remove('spin');
    setPill('l-pill','pw','dm','Paused');
    setSyncInfo('Host paused.');
  });
  sock.on('audio:seek', ({position, playing, serverPlayAt}) => {
    cancelSched();
    const a=G('l-audio'); if(!a.src)return;
    a.currentTime=position;
    if (playing) schedPlay(position, serverPlayAt);
    else { a.pause(); G('l-art').classList.remove('spin'); }
  });
  sock.on('room:host_left', ()=>{ toast('Host ended the session'); leave(); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NTP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doNTP() {
  ntpSamples=[]; ntpDone=false;
  sock.emit('ntp:ping',{clientTime:Date.now()});
}
function finishNTP() {
  ntpSamples.sort((a,b)=>a.rtt-b.rtt);
  const best=ntpSamples.slice(0,3);
  clockOffset=best.reduce((s,x)=>s+x.offset,0)/best.length;
  ntpDone=true;
  console.log('NTP: offset='+clockOffset.toFixed(1)+'ms RTT='+ntpSamples[0].rtt+'ms');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ZERO-LAG SCHEDULED PLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function schedPlay(position, serverPlayAt) {
  cancelSched();
  const a=G('l-audio');
  if (!a.src) { setSyncInfo('âš ï¸ Waiting for track to load...'); return; }

  const localPlayAt = serverPlayAt + clockOffset;
  const msLeft = localPlayAt - Date.now();

  function doPlay() {
    const late = Math.max(0,(Date.now()-localPlayAt))/1000;
    const target = Math.max(0, position+late);
    const drift = Math.abs(a.currentTime-target);
    if (drift>DRIFT_TOL) a.currentTime=target;

    a.play().then(()=>{
      G('l-art').classList.add('spin');
      setPill('l-pill','ps','dc','â— In Sync');
      setSyncInfo('ğŸ§ In sync â€” drift corrected: <b>'+Math.round(drift*1000)+'ms</b>');
      G('unlock').classList.add('gone');
      if (!lACtx) buildChain(a,'l');
      if (lACtx) lACtx.resume();
      startProg(a,'l-fill','l-cur','l-dur');
      startViz('l-viz');
    }).catch(()=>{
      G('unlock').classList.remove('gone');
      setSyncInfo('ğŸ‘† Tap the screen to start audio');
      G('unlock').onclick=()=>{
        a.play().then(()=>{
          doUnlock();
          G('l-art').classList.add('spin');
          setPill('l-pill','ps','dc','â— In Sync');
          if (!lACtx) buildChain(a,'l');
          startViz('l-viz');
        });
      };
    });
  }

  if (msLeft>15) {
    a.currentTime = Math.max(0,position-0.01);
    pendingPlay = setTimeout(doPlay, msLeft);
  } else {
    a.currentTime = Math.max(0, position+Math.max(0,-msLeft/1000));
    doPlay();
  }
}

function cancelSched() {
  if (pendingPlay) { clearTimeout(pendingPlay); pendingPlay=null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CREATE / JOIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createRoom() {
  const name = G('rname-input').value.trim() || 'Audio Room';
  initSock(); amHost=true;
  const go=()=>sock.emit('room:create',{name},res=>{
    if(!res.ok){toast('Could not create room');return;}
    roomCode=res.code;
    G('h-rname').textContent=res.name;
    G('h-code').textContent=res.code;
    show('s-host');
    toast('Room created! Share code: '+res.code+' ğŸ‰');
  });
  if (sock.connected) go();
  else { toast('Connecting...'); sock.once('connect',()=>setTimeout(go,200)); }
}

function joinRoom() {
  const code = G('join-code').value.trim().toUpperCase();
  if (!code||code.length<6) { toast('Enter the full 6-letter code'); return; }
  G('join-err').classList.remove('on');
  initSock(); amHost=false;

  const go=()=>{
    console.log('joining room:', code);
    sock.emit('room:join',{code},res=>{
      console.log('join result:', JSON.stringify(res));
      if (!res||!res.ok) {
        G('join-err').classList.add('on');
        return;
      }
      roomCode=code;
      G('l-rname').textContent=res.name;
      G('l-clabel').textContent='Room code: '+code;
      show('s-listen');
      toast('Joined! Syncing with host ğŸ§');
      if (res.track && res.track.streamUrl) {
        loadListenerTrack(res.track.streamUrl, res.track.title, ()=>{
          if (res.state&&res.state.playing&&res.state.serverPlayAt) {
            const elapsed=(srvNow()-res.state.serverPlayAt)/1000;
            schedPlay(Math.max(0,res.state.position+elapsed), srvNow()+SCHED_MS);
          } else if (res.state) {
            G('l-audio').currentTime=res.state.position||0;
          }
        });
      }
    });
  };
  if (sock.connected) go();
  else { toast('Connecting...'); sock.once('connect',()=>setTimeout(go,300)); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LISTENER TRACK LOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadListenerTrack(url, title, cb) {
  const a=G('l-audio');
  teardownAudio('l');
  vizAn=null; if(vizRaf){cancelAnimationFrame(vizRaf);vizRaf=null;}

  a.src=url; a.load();
  G('l-tname').textContent=title||'Loading...';
  setSyncInfo('âŸ³ Loading track...');

  a.oncanplay=()=>{
    if (a.duration) G('l-dur').textContent=fmt(a.duration);
    setSyncInfo('âœ… Track ready â€” waiting for host to play');
    buildChain(a,'l');
    a.oncanplay=null;
    if (cb) cb();
  };
  a.onerror=()=>{
    const c=a.error?a.error.code:0;
    const msgs=['','Aborted','Network error','Decode error','Not supported'];
    setSyncInfo('âŒ Track load failed: '+(msgs[c]||'Unknown error'));
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOST CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hostPlay() {
  const a=G('h-audio');
  if (!a.src){toast('Load a track first');return;}
  if (hACtx) hACtx.resume();
  const pos=a.currentTime, playAt=srvNow()+SCHED_MS;
  setTimeout(()=>{ a.play(); G('h-art').classList.add('spin'); }, SCHED_MS);
  setPill('h-pill','pl','dg','â— Playing');
  sock.emit('audio:play',{position:pos, serverPlayAt:playAt});
}

function hostPause() {
  const a=G('h-audio');
  a.pause(); G('h-art').classList.remove('spin');
  setPill('h-pill','pw','dm','Paused');
  sock.emit('audio:pause',{position:a.currentTime});
}

function hostRestart() {
  const a=G('h-audio');
  a.currentTime=0;
  if (hACtx) hACtx.resume();
  const playAt=srvNow()+SCHED_MS;
  setTimeout(()=>{ a.play(); G('h-art').classList.add('spin'); }, SCHED_MS);
  setPill('h-pill','pl','dg','â— Playing');
  sock.emit('audio:play',{position:0, serverPlayAt:playAt});
}

function hostSeek(e) {
  const a=G('h-audio'); if(!a.duration)return;
  const bar=e.currentTarget.querySelector('.seek-track');
  const rect=bar.getBoundingClientRect();
  const ratio=Math.max(0,Math.min(1,(e.clientX-rect.left)/rect.width));
  const seekTo=ratio*a.duration;
  a.currentTime=seekTo;
  const playing=!a.paused, playAt=srvNow()+SCHED_MS;
  if (playing) setTimeout(()=>a.play(), SCHED_MS);
  sock.emit('audio:seek',{position:seekTo, playing, serverPlayAt:playAt});
}

function hostVolChange(v) {
  G('h-audio').volume=parseFloat(v);
  if (hGain) hGain.gain.value=parseFloat(v);
}
function listVolChange(v) {
  G('l-audio').volume=parseFloat(v);
  if (lGain) lGain.gain.value=parseFloat(v);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function leave() {
  cancelSched();
  clearInterval(window._ka);
  if (progRaf){cancelAnimationFrame(progRaf);progRaf=null;}
  if (vizRaf){cancelAnimationFrame(vizRaf);vizRaf=null;}
  ['h-audio','l-audio'].forEach(id=>{const a=G(id);if(a){a.pause();a.src='';}});
  teardownAudio('h'); teardownAudio('l');
  if (sock){sock.disconnect();sock=null;}
  roomCode=null; listeners={}; currentTrack=null; vizAn=null;
  show('s-home');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyCode() {
  navigator.clipboard.writeText(G('h-code').textContent).then(()=>toast('Code copied! ğŸ“‹'));
}
function setSyncInfo(html) { G('l-sync').innerHTML='<b>Sync Status:</b> '+html; }
function setPill(id,cls,dotCls,lbl) {
  const el=G(id);
  el.className='pill '+cls;
  el.innerHTML='<div class="dot '+dotCls+'"></div><span>'+lbl+'</span>';
}
function renderListeners() {
  const ids=Object.keys(listeners);
  G('h-lcnt').textContent=ids.length;
  const el=G('h-llist');
  if(!ids.length){el.innerHTML='<div class="nol">No one joined yet â€” share your code!</div>';return;}
  el.innerHTML=ids.map((id,i)=>
    '<div class="litem"><div class="lav">ğŸ§</div><span>Listener '+(i+1)+'</span>'+
    '<span style="margin-left:auto;font-size:9px;color:var(--g)">â— synced</span></div>'
  ).join('');
}
function startProg(audio,fillId,curId,durId) {
  if(progRaf){cancelAnimationFrame(progRaf);progRaf=null;}
  function tick(){
    progRaf=requestAnimationFrame(tick);
    const p=audio.duration?(audio.currentTime/audio.duration*100):0;
    G(fillId).style.width=p+'%';
    G(curId).textContent=fmt(audio.currentTime);
    if(audio.duration)G(durId).textContent=fmt(audio.duration);
  }
  tick();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISUALIZER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startViz(canvasId) {
  if(vizRaf){cancelAnimationFrame(vizRaf);vizRaf=null;}
  if(!vizAn)return;
  const cv=G(canvasId);if(!cv)return;
  const ctx=cv.getContext('2d');
  const W=cv.offsetWidth||700,H=cv.offsetHeight||52;
  cv.width=W;cv.height=H;
  const buf=new Uint8Array(vizAn.frequencyBinCount);
  const bw=(W/buf.length)*2.4;
  function frame(){
    vizRaf=requestAnimationFrame(frame);
    vizAn.getByteFrequencyData(buf);
    ctx.fillStyle='#07080d';ctx.fillRect(0,0,W,H);
    let x=0;
    for(let i=0;i<buf.length;i++){
      const r=buf[i]/255, h=r*H;
      const hue=170+i/buf.length*110;
      ctx.fillStyle='hsla('+hue+',100%,60%,'+(0.65+r*0.35)+')';
      ctx.fillRect(x,H-h,bw,h);
      if(r>0.55){ctx.fillStyle='hsla('+hue+',100%,85%,0.7)';ctx.fillRect(x,H-h-2,bw,2);}
      x+=bw+1;
    }
  }
  frame();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT FORMATTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
G('join-code').addEventListener('input',function(){
  this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'');
});
</script>
</body>
</html>
