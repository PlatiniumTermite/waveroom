<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>WaveRoom â€” Live Audio Sync</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#06070c;--s:#0b0d17;--b:#161b2e;
  --c:#00e5ff;--p:#8b5cf6;--g:#00ff88;
  --r:#ff4466;--t:#e8edf8;--m:#4a5578;
  --gold:#ffd700;--orange:#ff7b35
}
html,body{background:var(--bg);color:var(--t);font-family:'Syne',sans-serif;min-height:100vh;overscroll-behavior:none;-webkit-tap-highlight-color:transparent}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(var(--b) 1px,transparent 1px),linear-gradient(90deg,var(--b) 1px,transparent 1px);background-size:48px 48px;opacity:.08;pointer-events:none;z-index:0}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse 800px 500px at 10% 0%,rgba(0,229,255,.04),transparent),radial-gradient(ellipse 600px 600px at 90% 100%,rgba(139,92,246,.05),transparent)}
#app{position:relative;z-index:1;max-width:840px;margin:0 auto;padding:22px 16px 60px}

/* NAV */
.nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:40px;flex-wrap:wrap;gap:8px}
.nav-left{display:flex;align-items:center;gap:10px}
.nav-icon{width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,var(--c),var(--p));display:flex;align-items:center;justify-content:center;font-size:18px}
.nav-name{font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--c),var(--p));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.nav-right{display:flex;align-items:center;gap:8px}
.badge{font-family:'Space Mono',monospace;font-size:9px;border-radius:20px;padding:3px 9px;letter-spacing:.4px}
.badge-gold{color:var(--gold);border:1px solid rgba(255,215,0,.25);background:rgba(255,215,0,.06)}
.badge-conn{color:var(--m);border:1px solid var(--b);background:transparent;display:flex;align-items:center;gap:5px}
.badge-conn.on{color:var(--g);border-color:rgba(0,255,136,.2)}
.ndot{width:5px;height:5px;border-radius:50%;background:currentColor;flex-shrink:0}
.badge-conn.on .ndot{animation:blk 1.8s infinite}
@keyframes blk{0%,100%{opacity:1}50%{opacity:.25}}

/* SCREENS */
.screen{display:none}.screen.on{display:block;animation:fu .2s ease}
@keyframes fu{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* HOME */
.hero{text-align:center;padding:4px 0 28px}
.hero-chip{display:inline-flex;align-items:center;gap:5px;font-family:'Space Mono',monospace;font-size:10px;color:var(--c);border:1px solid rgba(0,229,255,.18);border-radius:20px;padding:3px 11px;margin-bottom:16px;background:rgba(0,229,255,.05)}
.hero h1{font-size:clamp(26px,6vw,58px);font-weight:800;letter-spacing:-2px;line-height:1.05;margin-bottom:12px}
.hero h1 em{font-style:normal;background:linear-gradient(135deg,var(--c),var(--p));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero-sub{font-family:'Space Mono',monospace;font-size:11px;color:var(--m);max-width:380px;margin:0 auto 28px;line-height:1.9}
.home-cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;max-width:520px;margin:0 auto 20px}
@media(max-width:430px){.home-cards{grid-template-columns:1fr}}
.hcard{background:var(--s);border:1px solid var(--b);border-radius:13px;padding:20px 16px;cursor:pointer;text-align:left;transition:border-color .18s,transform .18s,box-shadow .18s}
.hcard:hover{border-color:rgba(0,229,255,.35);transform:translateY(-2px);box-shadow:0 6px 24px rgba(0,229,255,.07)}
.hi{font-size:22px;margin-bottom:8px}.ht{font-size:14px;font-weight:700;margin-bottom:4px}
.hd{font-size:10.5px;color:var(--m);font-family:'Space Mono',monospace;line-height:1.55}
.feats{display:flex;justify-content:center;gap:16px;flex-wrap:wrap;max-width:520px;margin:0 auto}
.feat{font-family:'Space Mono',monospace;font-size:10px;color:var(--m)}

/* FORM */
.fbox{max-width:400px;margin:0 auto}
.back{background:none;border:none;color:var(--m);font-family:'Space Mono',monospace;font-size:11px;cursor:pointer;margin-bottom:24px;padding:0;transition:color .18s}
.back:hover{color:var(--c)}
.ftitle{font-size:26px;font-weight:800;letter-spacing:-1px;margin-bottom:5px}
.fsub{font-family:'Space Mono',monospace;font-size:11px;color:var(--m);margin-bottom:20px;line-height:1.75}
.fl{display:block;font-size:9px;font-weight:700;letter-spacing:1.3px;text-transform:uppercase;color:var(--m);margin-bottom:5px}
.fi{width:100%;background:var(--s);border:1px solid var(--b);border-radius:8px;padding:11px 13px;color:var(--t);font-family:'Space Mono',monospace;font-size:13px;outline:none;transition:border-color .18s;margin-bottom:12px}
.fi:focus{border-color:var(--c)}
.fi::placeholder{color:var(--m)}
#join-code{letter-spacing:6px;font-size:21px;text-transform:uppercase;text-align:center}
.ferr{background:rgba(255,68,102,.08);border:1px solid rgba(255,68,102,.25);border-radius:7px;padding:9px 12px;font-family:'Space Mono',monospace;font-size:11px;color:var(--r);margin-bottom:11px;display:none;line-height:1.6}
.ferr.on{display:block}

/* BUTTONS */
.btn{width:100%;padding:12px;border-radius:8px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;border:none;transition:all .18s;display:flex;align-items:center;justify-content:center;gap:6px;letter-spacing:.2px}
.bc{background:linear-gradient(135deg,var(--c),#00b8d9);color:#000}
.bc:hover{box-shadow:0 5px 20px rgba(0,229,255,.3);transform:translateY(-1px)}
.bp{background:linear-gradient(135deg,var(--p),#6d28d9);color:#fff}
.bp:hover{box-shadow:0 5px 20px rgba(139,92,246,.3);transform:translateY(-1px)}
.bg{background:var(--s);border:1px solid var(--b);color:var(--t)}
.bg:hover{border-color:rgba(0,229,255,.35);color:var(--c)}
.bo{background:linear-gradient(135deg,var(--orange),#e55a00);color:#fff}
.bo:hover{box-shadow:0 5px 20px rgba(255,123,53,.3);transform:translateY(-1px)}
.br{background:rgba(255,68,102,.1);border:1px solid rgba(255,68,102,.28);color:var(--r)}
.btn:disabled{opacity:.25;cursor:not-allowed;transform:none!important;box-shadow:none!important}
.brow{display:flex;gap:7px}.brow .btn{flex:1;padding:9px 5px;font-size:11.5px}

/* ROOM HEADER */
.rhead{display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:9px;margin-bottom:13px}
.rname{font-size:20px;font-weight:800;letter-spacing:-.5px}
.rcode{display:inline-flex;align-items:center;gap:6px;margin-top:4px;background:var(--s);border:1px solid var(--b);border-radius:7px;padding:5px 11px;font-family:'Space Mono',monospace;font-size:17px;font-weight:700;letter-spacing:4px;color:var(--c);cursor:pointer;transition:border-color .18s;user-select:none}
.rcode:hover{border-color:var(--c)}
.rcode small{font-size:9px;color:var(--m);letter-spacing:0;font-weight:400}
.pill{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:100px;font-family:'Space Mono',monospace;font-size:10px;font-weight:700;white-space:nowrap}
.pl{background:rgba(0,255,136,.08);color:var(--g);border:1px solid rgba(0,255,136,.18)}
.pw{background:rgba(74,85,120,.1);color:var(--m);border:1px solid var(--b)}
.ps{background:rgba(0,229,255,.07);color:var(--c);border:1px solid rgba(0,229,255,.18)}
.po{background:rgba(255,123,53,.1);color:var(--orange);border:1px solid rgba(255,123,53,.25)}
.dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.dg{background:var(--g);animation:blk 1.3s infinite}.dm{background:var(--m)}.dc{background:var(--c);animation:blk 1.3s infinite}.do{background:var(--orange);animation:blk 1.3s infinite}

/* PANELS */
.panel{background:var(--s);border:1px solid var(--b);border-radius:12px;padding:15px;margin-bottom:10px;position:relative;overflow:hidden}
.panel::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.04),transparent)}
.ptitle{font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--m);font-family:'Space Mono',monospace;margin-bottom:10px}
.dbadge{position:absolute;top:12px;right:12px;font-family:'Space Mono',monospace;font-size:8px;font-weight:700;color:var(--gold);border:1px solid rgba(255,215,0,.18);border-radius:4px;padding:2px 5px;background:rgba(255,215,0,.05);letter-spacing:.7px}

/* MODE TABS */
.mode-tabs{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:13px}
.mode-tab{padding:12px 8px;border-radius:9px;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;cursor:pointer;border:1px solid var(--b);background:transparent;color:var(--m);transition:all .18s;text-align:center;line-height:1.4}
.mode-tab.active-url{background:rgba(0,229,255,.08);color:var(--c);border-color:rgba(0,229,255,.28)}
.mode-tab.active-screen{background:rgba(255,123,53,.1);color:var(--orange);border-color:rgba(255,123,53,.28)}
.mode-pane{display:none}.mode-pane.on{display:block}

/* SCREEN SHARE */
.screen-share-box{background:rgba(255,123,53,.05);border:1px solid rgba(255,123,53,.15);border-radius:10px;padding:16px;text-align:center}
.share-icon{font-size:40px;margin-bottom:10px}
.share-title{font-size:16px;font-weight:700;margin-bottom:6px}
.share-desc{font-family:'Space Mono',monospace;font-size:10.5px;color:var(--m);line-height:1.7;margin-bottom:14px}
.share-steps{background:rgba(0,0,0,.3);border-radius:7px;padding:10px 12px;margin-bottom:14px;text-align:left}
.share-step{font-family:'Space Mono',monospace;font-size:10px;color:var(--m);padding:2px 0;display:flex;gap:7px;align-items:flex-start;line-height:1.55}
.share-step-num{color:var(--orange);font-weight:700;flex-shrink:0}
.live-indicator{display:flex;align-items:center;justify-content:center;gap:7px;font-family:'Space Mono',monospace;font-size:11px;color:var(--orange);margin-bottom:10px}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--orange);animation:blk .8s infinite}

/* URL LOAD */
.src-tabs{display:flex;gap:5px;margin-bottom:11px}
.src-tab{flex:1;padding:7px 4px;border-radius:7px;font-family:'Space Mono',monospace;font-size:10px;font-weight:700;cursor:pointer;border:1px solid var(--b);background:transparent;color:var(--m);transition:all .15s;text-align:center}
.src-tab.active{background:rgba(0,229,255,.07);color:var(--c);border-color:rgba(0,229,255,.28)}
.src-pane{display:none}.src-pane.on{display:block}
.url-row{display:flex;gap:7px}.url-row .fi{margin-bottom:0;flex:1;font-size:11px}.url-row .btn{width:auto;padding:11px 14px;font-size:12px}
.load-status{display:flex;align-items:center;gap:6px;margin-top:9px;font-family:'Space Mono',monospace;font-size:11px;min-height:20px;color:var(--m);line-height:1.5}
.spin{display:inline-block;animation:rot .7s linear infinite}
@keyframes rot{to{transform:rotate(360deg)}}

/* PLAYER */
.tinfo{display:flex;align-items:center;gap:11px;margin-bottom:12px}
.tart{width:42px;height:42px;border-radius:9px;flex-shrink:0;background:linear-gradient(135deg,var(--p),var(--c));display:flex;align-items:center;justify-content:center;font-size:19px;animation:rot 12s linear infinite;animation-play-state:paused}
.tart.spin{animation-play-state:running}
.tname{font-size:13px;font-weight:700;word-break:break-all;line-height:1.35}
.tsub{font-family:'Space Mono',monospace;font-size:10px;color:var(--m);margin-top:2px}
.seekbar{padding:5px 0;cursor:pointer;margin-bottom:4px;user-select:none;touch-action:none}
.seek-track{width:100%;height:4px;background:var(--b);border-radius:10px}
.seek-fill{height:100%;width:0%;border-radius:10px;transition:width .18s linear;background:linear-gradient(90deg,var(--c),var(--p))}
.seek-times{display:flex;justify-content:space-between;font-family:'Space Mono',monospace;font-size:9px;color:var(--m);margin-top:4px}
.vol{display:flex;align-items:center;gap:7px;margin-top:10px}
.vol-lbl{font-family:'Space Mono',monospace;font-size:10px;color:var(--m);white-space:nowrap}
input[type=range]{flex:1;accent-color:var(--c);cursor:pointer;height:16px}
.vol-val{font-family:'Space Mono',monospace;font-size:10px;color:var(--m);min-width:30px;text-align:right}

/* AI EQ */
.eq-wrap{margin-top:12px;padding:10px 12px;background:rgba(0,0,0,.2);border:1px solid rgba(255,215,0,.09);border-radius:8px}
.eq-hdr{display:flex;align-items:center;gap:6px;margin-bottom:9px;font-family:'Space Mono',monospace;font-size:9px;color:var(--gold);text-transform:uppercase;letter-spacing:.8px}
.eq-ai{font-size:7px;background:rgba(255,215,0,.08);border:1px solid rgba(255,215,0,.18);color:var(--gold);padding:1px 5px;border-radius:3px}
.eq-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:4px}
.eq-btn{padding:6px 2px;border-radius:5px;font-family:'Space Mono',monospace;font-size:9px;font-weight:700;cursor:pointer;border:1px solid rgba(255,255,255,.05);background:transparent;color:var(--m);transition:all .14s;text-align:center;line-height:1.3}
.eq-btn.on,.eq-btn:hover{background:rgba(255,215,0,.09);color:var(--gold);border-color:rgba(255,215,0,.28)}
.depth-row{display:flex;align-items:center;gap:6px;margin-top:7px;font-family:'Space Mono',monospace;font-size:9px;color:var(--m)}
.depth-bar{flex:1;height:3px;background:var(--b);border-radius:10px;overflow:hidden}
.depth-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--c),var(--gold));transition:width .5s;border-radius:10px}

/* VISUALIZER */
canvas{width:100%;height:58px;display:block;border-radius:7px;background:var(--bg)}

/* LISTENERS */
.lcnt{color:var(--c);font-weight:700}
.nol{font-family:'Space Mono',monospace;font-size:11px;color:var(--m);text-align:center;padding:12px 0}
.litem{display:flex;align-items:center;gap:7px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.03);font-family:'Space Mono',monospace;font-size:11px}
.litem:last-child{border:none}
.lav{width:24px;height:24px;border-radius:5px;background:linear-gradient(135deg,var(--p),var(--c));display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0}

/* SYNC BOX */
.sbox{background:rgba(0,229,255,.03);border:1px solid rgba(0,229,255,.09);border-radius:8px;padding:9px 12px;font-family:'Space Mono',monospace;font-size:11px;color:var(--m);line-height:1.85}
.sbox b{color:var(--c)}
.stats-row{display:flex;gap:14px;margin-top:8px;flex-wrap:wrap}
.stat{font-family:'Space Mono',monospace;font-size:9px}
.stat-val{font-size:13px;font-weight:700;color:var(--c);display:block}
.stat-lbl{color:var(--m);text-transform:uppercase;letter-spacing:.4px}

/* TOAST */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);background:#111520;border:1px solid rgba(255,255,255,.09);border-radius:8px;padding:9px 16px;font-family:'Space Mono',monospace;font-size:11px;z-index:9999;transition:transform .26s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;max-width:92vw;text-align:center;pointer-events:none;box-shadow:0 8px 28px rgba(0,0,0,.5)}
.toast.on{transform:translateX(-50%) translateY(0)}

/* UNLOCK */
#unlock{position:fixed;inset:0;background:rgba(6,7,12,.97);z-index:1000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:13px;cursor:pointer;backdrop-filter:blur(8px)}
#unlock.gone{display:none}
.ui{font-size:50px;animation:tp 1.4s infinite}
@keyframes tp{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.ut{font-size:19px;font-weight:800}
.us{font-family:'Space Mono',monospace;font-size:11px;color:var(--m);text-align:center;max-width:230px;line-height:1.7}

/* LIVE STREAM WAVE */
.live-wave{display:flex;align-items:center;justify-content:center;gap:2px;height:24px;margin:8px 0}
.live-bar{width:3px;border-radius:3px;background:var(--orange);animation:wavebar 1s ease-in-out infinite}
.live-bar:nth-child(2){animation-delay:.1s}.live-bar:nth-child(3){animation-delay:.2s}.live-bar:nth-child(4){animation-delay:.3s}.live-bar:nth-child(5){animation-delay:.4s}
@keyframes wavebar{0%,100%{height:4px;opacity:.4}50%{height:18px;opacity:1}}
</style>
</head>
<body>

<div id="unlock" class="gone" onclick="doUnlock()">
  <div class="ui">ğŸ‘†</div>
  <div class="ut">Tap to Enable Audio</div>
  <div class="us">Browser needs one tap before audio can play</div>
</div>

<div id="app">
  <div class="nav">
    <div class="nav-left">
      <div class="nav-icon">ğŸŒŠ</div>
      <div class="nav-name">WaveRoom</div>
    </div>
    <div class="nav-right">
      <div class="badge badge-conn" id="conn-badge"><span class="ndot"></span><span id="conn-txt">Offline</span></div>
      <div class="badge badge-gold">âœ¦ AI SPATIAL</div>
    </div>
  </div>

  <!-- HOME -->
  <div id="s-home" class="screen on">
    <div class="hero">
      <div class="hero-chip">âš¡ Google-Meet-Style Audio Â· AI Spatial Â· Zero Lag</div>
      <h1>One Audio.<br><em>Every Device.</em><br>Same Second.</h1>
      <p class="hero-sub">Share any audio â€” YouTube, Spotify, anything playing<br>on your device â€” to every listener in perfect sync.<br>No uploads. No plugins. Works like Google Meet.</p>
      <div class="home-cards">
        <div class="hcard" onclick="show('s-create')">
          <div class="hi">ğŸ™</div>
          <div class="ht">Host a Room</div>
          <div class="hd">Share your screen/tab audio or any URL. Control playback for everyone.</div>
        </div>
        <div class="hcard" onclick="show('s-join')">
          <div class="hi">ğŸ§</div>
          <div class="ht">Join a Room</div>
          <div class="hd">Enter 6-letter code. Audio syncs automatically with AI drift correction.</div>
        </div>
      </div>
      <div class="feats">
        <div class="feat">ğŸ–¥ Screen/Tab Share</div>
        <div class="feat">âš¡ &lt;50ms Sync</div>
        <div class="feat">ğŸµ YouTube + URL</div>
        <div class="feat">ğŸ”Š AI Spatial Audio</div>
        <div class="feat">ğŸ“¡ NTP Clock Sync</div>
      </div>
    </div>
  </div>

  <!-- CREATE -->
  <div id="s-create" class="screen">
    <div class="fbox">
      <button class="back" onclick="show('s-home')">â† Back</button>
      <div class="ftitle">Host a Room</div>
      <div class="fsub">Create a room. Share your screen audio or a URL. You control everything.</div>
      <label class="fl">Room Name (optional)</label>
      <input class="fi" id="rname-input" type="text" placeholder="Friday Night Session" maxlength="40">
      <button class="btn bc" onclick="createRoom()">Create Room â†’</button>
    </div>
  </div>

  <!-- JOIN -->
  <div id="s-join" class="screen">
    <div class="fbox">
      <button class="back" onclick="show('s-home')">â† Back</button>
      <div class="ftitle">Join a Room</div>
      <div class="fsub">Enter the 6-letter code from the host.</div>
      <label class="fl">Room Code</label>
      <input class="fi" id="join-code" type="text" placeholder="ABC123" maxlength="6" autocomplete="off" spellcheck="false" inputmode="text">
      <div class="ferr" id="join-err">Room not found. Check the code and make sure the host is online.</div>
      <button class="btn bp" onclick="joinRoom()">Join Room â†’</button>
    </div>
  </div>

  <!-- HOST ROOM -->
  <div id="s-host" class="screen">
    <div class="rhead">
      <div>
        <div class="rname" id="h-rname">Room</div>
        <div class="rcode" onclick="copyCode()"><span id="h-code">------</span><small>copy</small></div>
      </div>
      <div id="h-pill" class="pill pw"><div class="dot dm"></div><span>Ready</span></div>
    </div>

    <!-- MODE TABS -->
    <div class="mode-tabs">
      <button class="mode-tab active-screen" id="tab-screen" onclick="switchMode('screen')">
        ğŸ–¥ Screen / Tab Share<br><span style="font-size:9px;font-weight:400;opacity:.7">Like Google Meet Â· Zero lag</span>
      </button>
      <button class="mode-tab" id="tab-url" onclick="switchMode('url')">
        ğŸ”— YouTube / URL<br><span style="font-size:9px;font-weight:400;opacity:.7">Paste any audio link</span>
      </button>
    </div>

    <!-- SCREEN SHARE PANE -->
    <div class="mode-pane on" id="pane-screen">
      <div class="screen-share-box">
        <div class="share-icon">ğŸ–¥</div>
        <div class="share-title">Share Your Screen Audio</div>
        <div class="share-desc">Share any tab or your entire screen â€” Chrome will capture<br>its audio and stream it live to all listeners in real-time.</div>
        <div class="share-steps">
          <div class="share-step"><span class="share-step-num">1.</span>Open YouTube (or Spotify, SoundCloud, anything) in another Chrome tab</div>
          <div class="share-step"><span class="share-step-num">2.</span>Click "Start Screen Share" â†’ choose that <b style="color:var(--t)">Chrome Tab</b></div>
          <div class="share-step"><span class="share-step-num">3.</span>âœ… Make sure <b style="color:var(--orange)">"Share tab audio"</b> checkbox is ticked</div>
          <div class="share-step"><span class="share-step-num">4.</span>Press Share â€” all listeners hear it live with &lt;150ms lag</div>
        </div>
        <div style="background:rgba(255,123,53,.06);border:1px solid rgba(255,123,53,.18);border-radius:7px;padding:9px 12px;margin-bottom:14px;font-family:'Space Mono',monospace;font-size:10px;color:var(--orange);line-height:1.7">
          ğŸ’¡ <b>Works with:</b> YouTube, Spotify Web, SoundCloud, Apple Music, Tidal, local files â€” anything in Chrome
        </div>
        <div id="screen-live-indicator" style="display:none">
          <div class="live-indicator"><div class="live-dot"></div>LIVE â€” streaming to listeners</div>
          <div class="live-wave">
            <div class="live-bar"></div><div class="live-bar"></div><div class="live-bar"></div>
            <div class="live-bar"></div><div class="live-bar"></div>
          </div>
        </div>
        <div class="brow">
          <button class="btn bo" id="share-btn" onclick="startScreenShare()">ğŸ–¥ Start Screen Share</button>
          <button class="btn br" id="stop-share-btn" onclick="stopScreenShare()" style="display:none">â¹ Stop</button>
        </div>
      </div>
    </div>

    <!-- URL PANE -->
    <div class="mode-pane" id="pane-url">
      <div class="load-panel" style="background:var(--s);border:1px solid var(--b);border-radius:12px;padding:14px;margin-bottom:10px">
        <div class="ptitle">Load Audio for Everyone</div>
        <div class="src-tabs">
          <button class="src-tab active" id="tab-yt" onclick="switchSrc('yt')">â–¶ YouTube</button>
          <button class="src-tab" id="tab-direct" onclick="switchSrc('direct')">ğŸ”— Direct URL</button>
          <button class="src-tab" id="tab-file" onclick="switchSrc('file')">ğŸ“ File</button>
        </div>
        <div class="src-pane on" id="pane-yt">
          <div class="url-row">
            <input class="fi" id="yt-url" type="url" placeholder="Paste YouTube URL..." autocomplete="off">
            <button class="btn bc" id="yt-btn" onclick="loadYoutube()">Load</button>
          </div>
          <div class="load-status" id="yt-status"></div>
          <!-- YouTube IFrame Player (hidden, used for sync) -->
          <div id="yt-player-wrap" style="display:none;margin-top:10px;border-radius:10px;overflow:hidden;position:relative;padding-bottom:56.25%;height:0;">
            <div id="yt-player" style="position:absolute;top:0;left:0;width:100%;height:100%;"></div>
          </div>
          <div id="yt-listener-wrap" style="display:none;margin-top:10px;border-radius:10px;overflow:hidden;position:relative;padding-bottom:56.25%;height:0;">
            <div id="yt-listener-player" style="position:absolute;top:0;left:0;width:100%;height:100%;"></div>
          </div>
        </div>
        <div class="src-pane" id="pane-direct">
          <div class="url-row">
            <input class="fi" id="direct-url" type="url" placeholder="https://example.com/audio.mp3" autocomplete="off">
            <button class="btn bc" onclick="loadDirectUrl()">Load</button>
          </div>
          <div class="load-status" id="url-status"></div>
        </div>
        <div class="src-pane" id="pane-file">
          <button class="btn bg" onclick="G('file-input').click()" style="margin-bottom:8px">ğŸ“ Choose File</button>
          <input type="file" id="file-input" accept="audio/*,video/*" style="display:none" onchange="loadFile()">
          <div style="font-family:'Space Mono',monospace;font-size:10px;color:var(--m);line-height:1.6">âš ï¸ Local files only play on your device. Use Screen Share so everyone hears it.</div>
          <div class="load-status" id="file-status"></div>
        </div>
      </div>

      <div class="panel" id="h-player" style="display:none">
        <div class="dbadge">AI SPATIAL âœ¦</div>
        <div class="tinfo">
          <div class="tart" id="h-art">ğŸµ</div>
          <div style="flex:1;min-width:0">
            <div class="tname" id="h-tname">â€”</div>
            <div class="tsub" id="h-tsub">Loading...</div>
          </div>
        </div>
        <div class="seekbar" id="h-seekbar">
          <div class="seek-track"><div class="seek-fill" id="h-fill"></div></div>
          <div class="seek-times"><span id="h-cur">0:00</span><span id="h-dur">0:00</span></div>
        </div>
        <div class="brow" style="margin-top:10px">
          <button class="btn bc" id="h-play-btn" onclick="hostPlay()" disabled>â–¶ Play</button>
          <button class="btn bg" onclick="hostPause()">â¸ Pause</button>
          <button class="btn bg" onclick="hostRestart()">â®</button>
        </div>
        <div class="vol">
          <span class="vol-lbl">ğŸ”Š</span>
          <input type="range" min="0" max="1" step="0.01" value="0.85" id="h-vol" oninput="hostVol(this.value)">
          <span class="vol-val" id="h-vol-val">85%</span>
        </div>
        <div class="eq-wrap" id="h-eq-wrap">
          <div class="eq-hdr">ğŸ› AI Spatial Audio <span class="eq-ai">AI</span></div>
          <div class="eq-grid">
            <button class="eq-btn on" id="heq-flat"   onclick="setEQ(this,'h')">Flat<br><span style="font-size:7px;opacity:.5">Linear</span></button>
            <button class="eq-btn"    id="heq-atmos"  onclick="setEQ(this,'h')">Atmos<br><span style="font-size:7px;opacity:.5">3D</span></button>
            <button class="eq-btn"    id="heq-cinema" onclick="setEQ(this,'h')">Cinema<br><span style="font-size:7px;opacity:.5">Wide</span></button>
            <button class="eq-btn"    id="heq-bass"   onclick="setEQ(this,'h')">Bass+<br><span style="font-size:7px;opacity:.5">Deep</span></button>
            <button class="eq-btn"    id="heq-vocal"  onclick="setEQ(this,'h')">Vocal<br><span style="font-size:7px;opacity:.5">Clear</span></button>
          </div>
          <div class="depth-row">
            <span style="white-space:nowrap">Spatial Depth</span>
            <div class="depth-bar"><div class="depth-fill" id="h-depth"></div></div>
            <span style="min-width:26px;text-align:right" id="h-depth-val">0%</span>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="ptitle">Live Frequency Spectrum</div>
      <canvas id="h-viz"></canvas>
    </div>

    <div class="panel">
      <div class="ptitle" style="display:flex;justify-content:space-between">
        <span>Listeners</span><span class="lcnt" id="h-lcnt">0</span>
      </div>
      <div id="h-llist"><div class="nol">No one joined yet â€” share your code!</div></div>
    </div>

    <div style="margin-top:10px"><button class="btn br" onclick="leave()">ğŸšª End Room</button></div>
    <audio id="h-audio" crossorigin="anonymous" style="display:none" preload="auto"></audio>
  </div>

  <!-- LISTENER ROOM -->
  <div id="s-listen" class="screen">
    <div class="rhead">
      <div>
        <div class="rname" id="l-rname">Room</div>
        <div style="font-family:'Space Mono',monospace;font-size:10px;color:var(--m);margin-top:3px" id="l-clabel"></div>
      </div>
      <div id="l-pill" class="pill pw"><div class="dot dm"></div><span>Connecting...</span></div>
    </div>

    <!-- Live stream view -->
    <div class="panel" id="l-stream-panel" style="display:none">
      <div class="dbadge">LIVE âœ¦</div>
      <div class="tinfo">
        <div class="tart spin" id="l-stream-art">ğŸ“¡</div>
        <div>
          <div class="tname" id="l-stream-title">Live Stream</div>
          <div class="tsub">Host is sharing audio in real-time</div>
        </div>
      </div>
      <div class="live-wave">
        <div class="live-bar"></div><div class="live-bar"></div><div class="live-bar"></div>
        <div class="live-bar"></div><div class="live-bar"></div>
      </div>
    </div>

    <!-- URL playback view -->
    <div class="panel" id="l-url-panel">
      <div class="dbadge">AI SPATIAL âœ¦</div>
      <div class="tinfo">
        <div class="tart" id="l-art">ğŸµ</div>
        <div style="flex:1;min-width:0">
          <div class="tname" id="l-tname">Waiting for host...</div>
          <div class="tsub">Host controls playback Â· you control volume</div>
        </div>
      </div>
      <div class="seekbar">
        <div class="seek-track"><div class="seek-fill" id="l-fill"></div></div>
        <div class="seek-times"><span id="l-cur">0:00</span><span id="l-dur">0:00</span></div>
      </div>
    </div>

    <div class="panel">
      <div class="vol">
        <span class="vol-lbl">ğŸ”Š Volume</span>
        <input type="range" min="0" max="1" step="0.01" value="0.85" id="l-vol" oninput="listVol(this.value)">
        <span class="vol-val" id="l-vol-val">85%</span>
      </div>
      <div class="eq-wrap" style="margin-top:12px">
        <div class="eq-hdr">ğŸ› AI Spatial Audio <span class="eq-ai">AI</span></div>
        <div class="eq-grid">
          <button class="eq-btn on" id="leq-flat"   onclick="setEQ(this,'l')">Flat<br><span style="font-size:7px;opacity:.5">Linear</span></button>
          <button class="eq-btn"    id="leq-atmos"  onclick="setEQ(this,'l')">Atmos<br><span style="font-size:7px;opacity:.5">3D</span></button>
          <button class="eq-btn"    id="leq-cinema" onclick="setEQ(this,'l')">Cinema<br><span style="font-size:7px;opacity:.5">Wide</span></button>
          <button class="eq-btn"    id="leq-bass"   onclick="setEQ(this,'l')">Bass+<br><span style="font-size:7px;opacity:.5">Deep</span></button>
          <button class="eq-btn"    id="leq-vocal"  onclick="setEQ(this,'l')">Vocal<br><span style="font-size:7px;opacity:.5">Clear</span></button>
        </div>
        <div class="depth-row">
          <span style="white-space:nowrap">Spatial Depth</span>
          <div class="depth-bar"><div class="depth-fill" id="l-depth"></div></div>
          <span style="min-width:26px;text-align:right" id="l-depth-val">0%</span>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="ptitle">Sync Status</div>
      <div class="sbox" id="l-sync"><b>Status:</b> Waiting for host...</div>
      <div class="stats-row" id="l-stats" style="display:none">
        <div class="stat"><span class="stat-val" id="l-drift">â€”</span><span class="stat-lbl">Drift</span></div>
        <div class="stat"><span class="stat-val" id="l-offset">â€”</span><span class="stat-lbl">Clock Î”</span></div>
        <div class="stat"><span class="stat-val" id="l-rtt">â€”</span><span class="stat-lbl">RTT</span></div>
        <div class="stat"><span class="stat-val" id="l-mode-val">â€”</span><span class="stat-lbl">Mode</span></div>
      </div>
    </div>

    <div class="panel">
      <div class="ptitle">Live Spectrum</div>
      <canvas id="l-viz"></canvas>
    </div>

    <div style="margin-top:10px"><button class="btn bg" onclick="leave()">â† Leave</button></div>
    <audio id="l-audio" crossorigin="anonymous" style="display:none" preload="auto"></audio>
    <!-- Live stream playback target -->
    <audio id="l-stream-audio" style="display:none" autoplay></audio>
  </div>
</div>
<div id="toast" class="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const NTP_ROUNDS = 12;
const SCHED_LEAD = 700;   // ms ahead we schedule play
const DRIFT_TOL  = 0.05;  // seconds â€” soft correction threshold
const DRIFT_HARD = 0.35;  // seconds â€” hard resync threshold

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI SPATIAL PRESETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PRESETS = {
  flat:   {sub:0,  bass:0,  lo:0,  mid:0,  hi:0,  pres:0,  air:0,  ratio:2, thr:-24, knee:8,  rev:0,    depth:0,  label:'Flat'},
  atmos:  {sub:4,  bass:3,  lo:-2, mid:1,  hi:5,  pres:6,  air:7,  ratio:4, thr:-18, knee:10, rev:0.18, depth:85, label:'Atmos 3D'},
  cinema: {sub:6,  bass:5,  lo:1,  mid:2,  hi:4,  pres:5,  air:5,  ratio:5, thr:-20, knee:12, rev:0.28, depth:95, label:'Cinema'},
  bass:   {sub:10, bass:8,  lo:3,  mid:-2, hi:1,  pres:2,  air:1,  ratio:6, thr:-22, knee:8,  rev:0.06, depth:20, label:'Bass+'},
  vocal:  {sub:-3, bass:-2, lo:1,  mid:5,  hi:4,  pres:3,  air:2,  ratio:3, thr:-16, knee:6,  rev:0.12, depth:30, label:'Vocal'},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sock=null, roomCode=null, amHost=false;
let clockOffset=0, ntpSamples=[], bestRTT=0;
let pendingPlay=null, progRaf=null, vizRaf=null, driftTimer=null;
let listeners={};
let hAudioCtx=null, hChain=null;
let lAudioCtx=null, lChain=null;
let vizAnalyser=null;
let currentTrack=null;
let currentEQ={h:'flat', l:'flat'};
let currentMode='screen';

// Screen share (host side)
let screenStream=null, mediaRec=null, screenVizCtx=null;

// MSE stream (listener side)
let lMS=null, lSB=null, lChunks=[], lMime='audio/webm;codecs=opus', lPlaying=false;

// KEY FIX: track whether listener audio is ready to play
let lAudioReady=false;
let lPendingSchedPlay=null; // if audio:play arrives before canplay, store it

const G = id => document.getElementById(id);
function srvNow(){ return Date.now() - clockOffset; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('on'));
  G(id).classList.add('on');
}
function toast(msg, dur=3500){
  const t=G('toast'); t.textContent=msg; t.classList.add('on');
  clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('on'), dur);
}
function fmt(s){
  if(!s||!isFinite(s)) return '0:00';
  return Math.floor(s/60)+':'+(('0'+Math.floor(s%60)).slice(-2));
}
function setConn(on){
  const b=G('conn-badge');
  b.className='badge badge-conn'+(on?' on':'');
  G('conn-txt').textContent=on?'Online':'Offline';
}
function setStatus(id,html){ const e=G(id); if(e) e.innerHTML=html; }
function setSyncInfo(html){ G('l-sync').innerHTML='<b>Status:</b> '+html; }
function setPill(id,cls,dot,lbl){
  const e=G(id); if(!e) return;
  e.className='pill '+cls;
  e.innerHTML='<div class="dot '+dot+'"></div><span>'+lbl+'</span>';
}
function renderListeners(){
  const ids=Object.keys(listeners);
  G('h-lcnt').textContent=ids.length;
  const el=G('h-llist');
  if(!ids.length){ el.innerHTML='<div class="nol">No one yet â€” share your code!</div>'; return; }
  el.innerHTML=ids.map((id,i)=>`<div class="litem"><div class="lav">ğŸ§</div><span>Listener ${i+1}</span><span style="margin-left:auto;font-family:'Space Mono',monospace;font-size:9px;color:var(--g)">â— live</span></div>`).join('');
}
function copyCode(){
  const code=G('h-code').textContent;
  navigator.clipboard?.writeText(code).then(()=>toast('ğŸ“‹ Copied: '+code)) || (() => {
    const e=document.createElement('input');e.value=code;document.body.appendChild(e);e.select();document.execCommand('copy');document.body.removeChild(e);toast('ğŸ“‹ Copied: '+code);
  })();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UNLOCK OVERLAY (mobile autoplay fix)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doUnlock(){
  G('unlock').classList.add('gone');
  [lAudioCtx, hAudioCtx].forEach(c=>{ if(c) c.resume(); });
  // Try playing pending audio
  const la=G('l-audio');
  if(la && la.src && la.paused && lAudioReady){
    la.play().catch(()=>{});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODE / TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchMode(m){
  currentMode=m;
  G('tab-screen').className='mode-tab'+(m==='screen'?' active-screen':'');
  G('tab-url').className='mode-tab'+(m==='url'?' active-url':'');
  G('pane-screen').classList.toggle('on', m==='screen');
  G('pane-url').classList.toggle('on', m==='url');
}
function switchSrc(s){
  ['yt','direct','file'].forEach(n=>{
    G('tab-'+n).classList.toggle('active', n===s);
    G('pane-'+n).classList.toggle('on', n===s);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NTP CLOCK SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doNTP(){ ntpSamples=[]; sock.emit('ntp:ping',{clientTime:Date.now()}); }
function finishNTP(){
  ntpSamples.sort((a,b)=>a.rtt-b.rtt);
  const best=ntpSamples.slice(0, Math.ceil(NTP_ROUNDS/3));
  clockOffset=best.reduce((s,x)=>s+x.offset,0)/best.length;
  bestRTT=ntpSamples[0].rtt;
  console.log(`[NTP] offset=${clockOffset.toFixed(1)}ms RTT=${bestRTT}ms`);
  if(G('l-offset')) G('l-offset').textContent=Math.round(Math.abs(clockOffset))+'ms';
  if(G('l-rtt'))    G('l-rtt').textContent=bestRTT+'ms';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN SHARE â€” HOST SIDE
// Google Meet style: capture tab audio via getDisplayMedia
// encode WebM/Opus chunks â†’ send to server â†’ relay to listeners
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startScreenShare(){
  try{
    screenStream = await navigator.mediaDevices.getDisplayMedia({
      video: {width:1, height:1, frameRate:1}, // Chrome needs video:true to offer audio
      audio: {echoCancellation:false, noiseSuppression:false, autoGainControl:false, sampleRate:48000, channelCount:2}
    });
    const aTracks = screenStream.getAudioTracks();
    if(!aTracks.length){
      screenStream.getTracks().forEach(t=>t.stop());
      toast('âŒ No audio captured. Tick "Share tab audio" in Chrome dialog.',7000);
      return;
    }
    // Stop video track immediately â€” we only need audio
    screenStream.getVideoTracks().forEach(t=>t.stop());

    // Host hears own audio
    const localAud=new Audio();
    localAud.srcObject=new MediaStream([...aTracks]);
    localAud.volume=parseFloat(G('h-vol').value)||0.85;
    localAud.play().catch(()=>{});

    // Visualizer for host
    if(screenVizCtx){ screenVizCtx.close(); screenVizCtx=null; }
    screenVizCtx=new(window.AudioContext||window.webkitAudioContext)();
    const srcN=screenVizCtx.createMediaStreamSource(new MediaStream([...aTracks]));
    const anN=screenVizCtx.createAnalyser(); anN.fftSize=1024;
    srcN.connect(anN); vizAnalyser=anN; startViz('h-viz');

    // Pick best MIME type
    const mime=['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus']
      .find(m=>MediaRecorder.isTypeSupported(m)) || '';
    lMime=mime; // share mime with listeners

    mediaRec=new MediaRecorder(new MediaStream([...aTracks]),{mimeType:mime, audioBitsPerSecond:128000});
    let seq=0;
    mediaRec.ondataavailable=async e=>{
      if(!e.data||e.data.size===0||!sock||!roomCode) return;
      const buf=await e.data.arrayBuffer();
      sock.emit('stream:chunk',{seq:seq++, mime, data:buf});
    };
    mediaRec.start(80); // 80ms chunks

    sock.emit('stream:start',{title:aTracks[0].label||'Screen Audio', mime});

    G('screen-live-indicator').style.display='block';
    G('share-btn').style.display='none';
    G('stop-share-btn').style.display='';
    setPill('h-pill','po','do','â— Live');
    toast('ğŸ”´ Live! Everyone hears your audio.');
    aTracks[0].onended=()=>stopScreenShare();

  }catch(e){
    if(e.name==='NotAllowedError') toast('âŒ Permission denied.',5000);
    else toast('âŒ '+e.message, 5000);
    console.error('[SHARE]',e);
  }
}

function stopScreenShare(){
  try{ if(mediaRec&&mediaRec.state!=='inactive') mediaRec.stop(); }catch(e){}
  try{ if(screenStream) screenStream.getTracks().forEach(t=>t.stop()); }catch(e){}
  try{ if(screenVizCtx){ screenVizCtx.close(); screenVizCtx=null; } }catch(e){}
  screenStream=null; mediaRec=null;
  if(vizRaf){ cancelAnimationFrame(vizRaf); vizRaf=null; vizAnalyser=null; }
  if(sock) sock.emit('stream:stop');
  G('screen-live-indicator').style.display='none';
  G('share-btn').style.display='';
  G('stop-share-btn').style.display='none';
  setPill('h-pill','pw','dm','Ready');
  toast('â¹ Stream stopped');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MSE STREAM â€” LISTENER SIDE
// MediaSource Extensions: buffer WebM/Opus chunks
// same tech as YouTube / Netflix streaming
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initMSE(mime){
  lPlaying=false; lChunks=[];
  const audio=G('l-stream-audio');

  // Clean up previous MSE
  try{ if(lMS&&lMS.readyState==='open') lMS.endOfStream(); }catch(e){}
  if(audio.src&&audio.src.startsWith('blob:')) URL.revokeObjectURL(audio.src);
  audio.pause(); audio.removeAttribute('src'); audio.load();

  if(!window.MediaSource){ console.error('[MSE] not supported'); return; }

  const supported=MediaSource.isTypeSupported(mime);
  if(!supported){
    // Try plain webm
    if(MediaSource.isTypeSupported('audio/webm')) mime='audio/webm';
    else{ console.error('[MSE] no supported mime'); return; }
  }
  lMime=mime;
  lMS=new MediaSource();
  audio.src=URL.createObjectURL(lMS);

  lMS.addEventListener('sourceopen',()=>{
    console.log('[MSE] sourceopen mime='+lMime);
    try{
      lSB=lMS.addSourceBuffer(lMime);
      lSB.mode='sequence';
      lSB.addEventListener('updateend',flushMSE);
      lSB.addEventListener('error',e=>console.error('[MSE SB error]',e));
      flushMSE(); // drain any chunks that arrived early
    }catch(e){ console.error('[MSE addSourceBuffer]',e); }
  },{once:true});
}

function flushMSE(){
  if(!lSB||lSB.updating||!lChunks.length) return;
  try{
    lSB.appendBuffer(lChunks.shift());
    // Start playing as soon as first chunk appended
    const audio=G('l-stream-audio');
    if(!lPlaying && lSB.buffered.length>0 && lSB.buffered.end(0)>0.1){
      lPlaying=true;
      audio.volume=parseFloat(G('l-vol').value)||0.85;
      audio.play().catch(()=>{
        G('unlock').classList.remove('gone');
        G('unlock').onclick=()=>{
          doUnlock();
          audio.play().catch(()=>{});
        };
      });
    }
    // Trim old buffer (keep last 10s to save memory)
    if(lSB.buffered.length>0){
      const s=lSB.buffered.start(0), e=lSB.buffered.end(0);
      const audio=G('l-stream-audio');
      const trim=audio.currentTime-6;
      if(trim>s && !lSB.updating){
        try{ lSB.remove(s, trim); }catch(ex){}
      }
    }
  }catch(e){
    if(e.name==='QuotaExceededError'){
      lChunks=[];
      try{ if(lSB.buffered.length>0) lSB.remove(lSB.buffered.start(0),lSB.buffered.end(0)); }catch(ex){}
    } else {
      console.warn('[MSE appendBuffer]',e.message);
    }
  }
}

function pushStreamChunk(rawData){
  let ab;
  if(rawData instanceof ArrayBuffer)      ab=rawData;
  else if(rawData?.buffer)               ab=rawData.buffer.slice(rawData.byteOffset, rawData.byteOffset+rawData.byteLength);
  else if(Array.isArray(rawData))        ab=new Uint8Array(rawData).buffer;
  else{ console.warn('[MSE] unknown chunk type',typeof rawData); return; }
  lChunks.push(ab);
  flushMSE();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// YOUTUBE / URL LOAD â€” HOST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// YOUTUBE IFRAME SYNC SYSTEM
// Works exactly like Watch2Gether / Teleparty:
// Every user loads YouTube independently in their
// own browser â€” host sends play/pause/seek/videoId
// over socket. Zero server-side extraction.
// Never blocked. Works forever.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ytPlayer = null;       // host player
let ytListenerPlayer = null; // listener player
let ytReady = false;
let ytListenerReady = false;
let ytVideoId = null;
let ytSyncInterval = null;

// Extract video ID from any YouTube URL format
function ytExtractId(url){
  try{
    const u = new URL(url.includes('://') ? url : 'https://'+url);
    if(u.hostname === 'youtu.be') return u.pathname.slice(1).split('?')[0];
    return u.searchParams.get('v') || null;
  }catch(e){ return null; }
}

// Load YouTube IFrame API once
let ytApiLoaded = false;
function loadYtApi(cb){
  if(ytApiLoaded && window.YT && window.YT.Player){ cb(); return; }
  window.onYouTubeIframeAPIReady = function(){
    ytApiLoaded = true;
    cb();
  };
  if(!document.getElementById('yt-api-script')){
    const s = document.createElement('script');
    s.id = 'yt-api-script';
    s.src = 'https://www.youtube.com/iframe_api';
    document.head.appendChild(s);
  } else if(window.YT && window.YT.Player){
    ytApiLoaded = true; cb();
  }
}

function loadYoutube(){
  const raw = G('yt-url').value.trim();
  if(!raw){ toast('Paste a YouTube URL'); return; }
  const videoId = ytExtractId(raw);
  if(!videoId){ setStatus('yt-status','âŒ Invalid YouTube URL'); return; }

  const btn = G('yt-btn');
  btn.disabled = true; btn.textContent = '...';
  setStatus('yt-status','<span class="spin">âŸ³</span> Loading YouTube player...');

  loadYtApi(()=>{
    ytVideoId = videoId;
    G('yt-player-wrap').style.display = 'block';

    // Destroy old player if exists
    if(ytPlayer){ try{ ytPlayer.destroy(); }catch(e){} ytPlayer=null; ytReady=false; }

    ytPlayer = new YT.Player('yt-player', {
      height:'100%', width:'100%',
      videoId: videoId,
      playerVars:{
        autoplay:0, controls:1, rel:0, modestbranding:1,
        playsinline:1, enablejsapi:1,
      },
      events:{
        onReady(e){
          ytReady = true;
          btn.disabled = false; btn.textContent = 'Load';
          const title = ytPlayer.getVideoData()?.title || 'YouTube Video';
          setStatus('yt-status','âœ… '+title);
          G('h-player').style.display = 'block';
          G('h-tname').textContent = title;
          G('h-tsub').textContent = fmt(ytPlayer.getDuration()) + ' Â· YouTube';
          G('h-dur').textContent = fmt(ytPlayer.getDuration());
          G('h-play-btn').disabled = false;
          toast('âœ… Loaded â€” press Play â–¶');
          // Tell all listeners which video to load
          if(sock) sock.emit('yt:load',{ videoId, title });
          currentTrack = { isYT:true, videoId, title, isLocal:false };
          startYtProg();
          // Build viz from YT audio (needs AudioContext on user gesture)
        },
        onStateChange(e){
          // YT.PlayerState: -1=unstarted, 0=ended, 1=playing, 2=paused, 3=buffering, 5=cued
          if(e.data === YT.PlayerState.PLAYING){
            G('h-art').classList.add('spin');
            setPill('h-pill','pl','dg','â— Playing');
          } else if(e.data === YT.PlayerState.PAUSED){
            G('h-art').classList.remove('spin');
            setPill('h-pill','pw','dm','Paused');
          }
        },
        onError(e){
          const errs={2:'Invalid video ID',5:'HTML5 error',100:'Video not found',101:'Embedding not allowed',150:'Embedding not allowed'};
          setStatus('yt-status','âŒ '+(errs[e.data]||'YouTube error '+e.data));
          btn.disabled=false; btn.textContent='Load';
        }
      }
    });
  });
}

// HOST: play YouTube + sync
function hostYtPlay(){
  if(!ytPlayer||!ytReady){ toast('Load a YouTube video first'); return; }
  const pos = ytPlayer.getCurrentTime();
  const playAt = srvNow() + SCHED_LEAD;
  ytPlayer.playVideo();
  setPill('h-pill','pl','dg','â— Playing');
  sock.emit('yt:play',{ position:pos, serverPlayAt:playAt });
}
function hostYtPause(){
  if(!ytPlayer||!ytReady) return;
  ytPlayer.pauseVideo();
  setPill('h-pill','pw','dm','Paused');
  sock.emit('yt:pause',{ position:ytPlayer.getCurrentTime() });
}
function hostYtRestart(){
  if(!ytPlayer||!ytReady) return;
  ytPlayer.seekTo(0);
  const playAt = srvNow() + SCHED_LEAD;
  ytPlayer.playVideo();
  sock.emit('yt:play',{ position:0, serverPlayAt:playAt });
}

// Progress bar for YouTube
function startYtProg(){
  if(progRaf){ cancelAnimationFrame(progRaf); progRaf=null; }
  function tick(){
    progRaf = requestAnimationFrame(tick);
    if(!ytPlayer||!ytReady) return;
    try{
      const cur = ytPlayer.getCurrentTime()||0;
      const dur = ytPlayer.getDuration()||0;
      const p = dur ? (cur/dur*100) : 0;
      const f=G('h-fill'); if(f) f.style.width=p+'%';
      if(G('h-cur')) G('h-cur').textContent=fmt(cur);
      if(G('h-dur')) G('h-dur').textContent=fmt(dur);
    }catch(e){}
  }
  tick();
}

// LISTENER: load + sync YouTube player
function initListenerYt(videoId, onReady){
  G('yt-listener-wrap').style.display = 'block';
  if(ytListenerPlayer){ try{ytListenerPlayer.destroy();}catch(e){} ytListenerPlayer=null; ytListenerReady=false; }

  loadYtApi(()=>{
    ytListenerPlayer = new YT.Player('yt-listener-player',{
      height:'100%', width:'100%',
      videoId: videoId,
      playerVars:{ autoplay:0, controls:0, rel:0, modestbranding:1, playsinline:1, mute:0 },
      events:{
        onReady(e){
          ytListenerReady = true;
          const vol = parseFloat(G('l-vol').value)||0.85;
          ytListenerPlayer.setVolume(vol*100);
          if(onReady) onReady();
        },
        onError(e){ console.error('[YT listener] error',e.data); }
      }
    });
  });
}

function schedYtPlay(position, serverPlayAt){
  if(!ytListenerPlayer||!ytListenerReady){ return; }
  const localPlayAt = serverPlayAt + clockOffset;
  const msLeft = localPlayAt - Date.now();
  const execute = ()=>{
    const late = Math.max(0,(Date.now()-localPlayAt))/1000;
    const target = Math.max(0, position+late);
    ytListenerPlayer.seekTo(target, true);
    ytListenerPlayer.playVideo();
    setPill('l-pill','ps','dc','â— In Sync');
    setSyncInfo('ğŸ§ Playing in sync');
    G('l-art').classList.add('spin');
    G('l-tname').textContent = currentTrack?.title || 'YouTube';
    // Drift correction
    clearInterval(driftTimer);
    driftTimer = setInterval(()=>{
      if(!ytListenerPlayer) return;
      try{
        const state = ytListenerPlayer.getPlayerState();
        if(state !== 1) return; // only when playing
        const elapsed = (srvNow()-serverPlayAt)/1000;
        const expected = position+elapsed;
        const actual = ytListenerPlayer.getCurrentTime();
        const d = Math.abs(actual-expected);
        if(d > DRIFT_HARD){ ytListenerPlayer.seekTo(expected,true); console.warn('[YT SYNC] corrected',d.toFixed(2)+'s'); }
        if(G('l-drift')) G('l-drift').textContent = Math.round(d*1000)+'ms';
      }catch(e){}
    }, 3000);
  };
  if(msLeft > 20){ setSyncInfo('âŸ³ Syncing...'); setTimeout(execute, msLeft); }
  else execute();
}

function loadDirectUrl(){
  const raw=G('direct-url').value.trim();
  if(!raw){ toast('Enter a URL'); return; }
  const title=decodeURIComponent(raw.split('/').pop().split('?')[0].replace(/\.[^.]+$/,'')||'Audio');
  applyTrack('/proxy?url='+encodeURIComponent(raw), title, raw);
  setStatus('url-status','<span class="spin">âŸ³</span> Loading...');
}

function loadFile(){
  const f=G('file-input').files[0]; if(!f) return;
  setStatus('file-status','âš ï¸ Local only â€” use Screen Share so everyone hears it');
  applyTrack(URL.createObjectURL(f), f.name.replace(/\.[^.]+$/,''), null, true);
}

function applyTrack(streamUrl, title, originalUrl, isLocal=false){
  const a=G('h-audio');
  // Tear down host chain first
  if(hAudioCtx){ hAudioCtx.close().catch(()=>{}); hAudioCtx=null; hChain=null; }
  if(vizRaf&&currentMode!=='screen'){ cancelAnimationFrame(vizRaf); vizRaf=null; }
  currentTrack={streamUrl,title,originalUrl,isLocal};

  a.pause(); a.src=''; a.load(); // full reset
  a.src=streamUrl; a.load();
  G('h-tname').textContent=title;
  G('h-tsub').textContent='Loading...';
  G('h-player').style.display='block';
  G('h-play-btn').disabled=true;

  a.addEventListener('loadedmetadata', function onMeta(){
    a.removeEventListener('loadedmetadata',onMeta);
    G('h-dur').textContent=fmt(a.duration);
    G('h-tsub').textContent=fmt(a.duration)+(isLocal?' Â· local only':' Â· ready');
    G('h-play-btn').disabled=false;
    if(!hAudioCtx) buildAudioChain(a,'h');
    startProg(a,'h-fill','h-cur','h-dur');
    startViz('h-viz');
    toast('âœ… Loaded â€” press Play â–¶');
    setStatus('yt-status','âœ… Ready');
    setStatus('url-status','âœ… Ready');
  });
  a.addEventListener('error', function onErr(){
    a.removeEventListener('error',onErr);
    const codes=['','ABORTED','NETWORK','DECODE','NOT_SUPPORTED'];
    const m=a.error?(codes[a.error.code]||'ERR_'+a.error.code):'UNKNOWN';
    setStatus('yt-status','âŒ '+m); setStatus('url-status','âŒ '+m);
    toast('âŒ '+m+' â€” Try Screen Share',6000);
    G('h-play-btn').disabled=false;
  });

  setupSeekbar(a);
  if(!isLocal && sock) sock.emit('track:set',{streamUrl,title,originalUrl});
}

function setupSeekbar(audio){
  const oldBar=G('h-seekbar');
  const bar=oldBar.cloneNode(true);
  oldBar.parentNode.replaceChild(bar,oldBar);
  let drag=false;
  const getR=e=>{
    const rc=bar.querySelector('.seek-track').getBoundingClientRect();
    return Math.max(0,Math.min(1,((e.touches?e.touches[0].clientX:e.clientX)-rc.left)/rc.width));
  };
  const doSeek=e=>{
    if(!audio.duration) return;
    const r=getR(e), pos=r*audio.duration;
    audio.currentTime=pos;
    G('h-fill').style.width=(r*100)+'%';
    const playing=!audio.paused, playAt=srvNow()+SCHED_LEAD;
    if(playing) setTimeout(()=>audio.play().catch(()=>{}),SCHED_LEAD);
    if(sock) sock.emit('audio:seek',{position:pos,playing,serverPlayAt:playAt});
  };
  bar.addEventListener('mousedown', e=>{drag=true;doSeek(e);});
  bar.addEventListener('touchstart',e=>{drag=true;doSeek(e);},{passive:true});
  document.addEventListener('mousemove',e=>{if(drag)doSeek(e);});
  document.addEventListener('touchmove',e=>{if(drag)doSeek(e);},{passive:true});
  document.addEventListener('mouseup',  ()=>{drag=false;});
  document.addEventListener('touchend', ()=>{drag=false;});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI AUDIO CHAIN
// 7-band EQ + Convolution Reverb + Compressor
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildAudioChain(el, side){
  if(side==='h'&&hAudioCtx) return hChain;
  if(side==='l'&&lAudioCtx) return lChain;
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)({sampleRate:48000, latencyHint:'playback'});
    const src=ctx.createMediaElementSource(el);
    const f1=mkF(ctx,'lowshelf', 40);
    const f2=mkF(ctx,'peaking', 120, 1.0);
    const f3=mkF(ctx,'peaking', 400, 0.9);
    const f4=mkF(ctx,'peaking',1200, 0.9);
    const f5=mkF(ctx,'peaking',4000, 1.0);
    const f6=mkF(ctx,'peaking',8000, 1.1);
    const f7=mkF(ctx,'highshelf',16000);
    const comp=ctx.createDynamicsCompressor();
    Object.assign(comp,{});
    comp.threshold.value=-24; comp.knee.value=8; comp.ratio.value=2;
    comp.attack.value=0.003; comp.release.value=0.15;
    const rev=ctx.createConvolver(); rev.buffer=makeIR(ctx,2.2,3);
    const revG=ctx.createGain(); revG.gain.value=0;
    const dryG=ctx.createGain(); dryG.gain.value=1;
    const master=ctx.createGain(); master.gain.value=parseFloat(side==='h'?G('h-vol').value:G('l-vol').value)||0.85;
    const an=ctx.createAnalyser(); an.fftSize=1024; an.smoothingTimeConstant=0.82;
    src.connect(f1); f1.connect(f2); f2.connect(f3); f3.connect(f4);
    f4.connect(f5); f5.connect(f6); f6.connect(f7);
    f7.connect(dryG); f7.connect(rev); rev.connect(revG);
    dryG.connect(comp); revG.connect(comp);
    comp.connect(master); master.connect(an); an.connect(ctx.destination);
    const chain={f1,f2,f3,f4,f5,f6,f7,comp,rev,revG,dryG,master,an};
    if(side==='h'){ hAudioCtx=ctx; hChain=chain; }
    else          { lAudioCtx=ctx; lChain=chain; }
    vizAnalyser=an;
    applyPreset(PRESETS[currentEQ[side]||'flat'], chain);
    ctx.resume();
    return chain;
  }catch(e){ console.error('[chain]',e); return null; }
}

function makeIR(ctx,dur,decay){
  const len=Math.floor(ctx.sampleRate*dur);
  const buf=ctx.createBuffer(2,len,ctx.sampleRate);
  for(let ch=0;ch<2;ch++){
    const d=buf.getChannelData(ch);
    for(let i=0;i<len;i++){
      const t=i/ctx.sampleRate, env=Math.pow(Math.max(0,1-t/dur),decay);
      d[i]=(Math.random()*2-1)*env*0.4;
      if(i<ctx.sampleRate*0.04) d[i]*=1.8;
    }
  }
  return buf;
}

function mkF(ctx,type,freq,q){
  const f=ctx.createBiquadFilter(); f.type=type; f.frequency.value=freq;
  if(q!==undefined) f.Q.value=q; return f;
}

function applyPreset(p, chain){
  if(!chain) return;
  chain.f1.gain.value=p.sub; chain.f2.gain.value=p.bass;
  chain.f3.gain.value=p.lo;  chain.f4.gain.value=p.mid;
  chain.f5.gain.value=p.hi;  chain.f6.gain.value=p.pres;
  chain.f7.gain.value=p.air;
  chain.comp.ratio.value=p.ratio; chain.comp.threshold.value=p.thr; chain.comp.knee.value=p.knee;
  chain.revG.gain.value=p.rev; chain.dryG.gain.value=1-(p.rev*0.4);
}

function setEQ(btn, side){
  const key=btn.id.replace(/^[hl]eq-/,'');
  const p=PRESETS[key]; if(!p) return;
  applyPreset(p, side==='h'?hChain:lChain);
  currentEQ[side]=key;
  document.querySelectorAll(`[id^="${side}eq-"]`).forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  const df=G(side+'-depth'), dv=G(side+'-depth-val');
  if(df){ df.style.width=(p.depth||0)+'%'; dv.textContent=(p.depth||0)+'%'; }
  toast('âœ¦ '+p.label);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initSock(){
  if(sock&&sock.connected) return;
  sock=io({transports:['websocket','polling'],reconnectionAttempts:20,reconnectionDelay:1000,timeout:20000});

  sock.on('connect',()=>{
    console.log('[WS] connected',sock.id);
    setConn(true); doNTP();
    clearInterval(window._ka);
    window._ka=setInterval(()=>{ if(sock?.connected) sock.emit('keepalive'); }, 15000);
  });
  sock.on('disconnect',()=>{ setConn(false); if(roomCode) toast('âš ï¸ Reconnecting...'); });
  sock.on('reconnect', ()=>{ setConn(true); toast('âœ… Reconnected'); doNTP(); });
  sock.on('connect_error',()=>setConn(false));

  sock.on('ntp:pong',({clientTime,serverTime})=>{
    const now=Date.now(), rtt=now-clientTime;
    ntpSamples.push({rtt, offset: now-(serverTime+rtt/2)});
    if(ntpSamples.length<NTP_ROUNDS) setTimeout(()=>sock.emit('ntp:ping',{clientTime:Date.now()}),40);
    else finishNTP();
  });

  // â”€â”€ HOST EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sock.on('room:listener_joined',({id})=>{
    listeners[id]={}; renderListeners();
    // Push current state to new joiner after small delay
    setTimeout(()=>{
      if(currentTrack?.isYT && sock){
        sock.emit('yt:load',{videoId:currentTrack.videoId, title:currentTrack.title});
        setTimeout(()=>{
          if(!ytPlayer||!ytReady) return;
          const state=ytPlayer.getPlayerState();
          if(state===1){ // playing
            sock.emit('yt:play',{position:ytPlayer.getCurrentTime(), serverPlayAt:srvNow()+SCHED_LEAD});
          } else {
            sock.emit('yt:pause',{position:ytPlayer.getCurrentTime()||0});
          }
        }, 1200);
      } else if(currentMode==='url'&&currentTrack&&!currentTrack.isLocal&&sock){
        sock.emit('track:set',{streamUrl:currentTrack.streamUrl,title:currentTrack.title,originalUrl:currentTrack.originalUrl});
        const a=G('h-audio');
        setTimeout(()=>{
          if(!a.paused) sock.emit('audio:play',{position:a.currentTime, serverPlayAt:srvNow()+SCHED_LEAD});
          else          sock.emit('audio:pause',{position:a.currentTime});
        }, 1000);
      }
    }, 300);
  });
  sock.on('room:listener_left',({id})=>{ delete listeners[id]; renderListeners(); });
  sock.on('room:count',n=>G('h-lcnt').textContent=n);

  // â”€â”€ LISTENER URL EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // KEY FIX: track:set â†’ load audio â†’ wait for canplay â†’ THEN apply any pending play
  sock.on('track:set',({streamUrl,title})=>{
    console.log('[L] track:set',title);
    G('l-stream-panel').style.display='none';
    G('l-url-panel').style.display='block';
    lPendingSchedPlay=null;
    loadListenerTrack(streamUrl, title);
  });

  // YouTube IFrame sync events (listener side)
  sock.on('yt:load',({videoId, title})=>{
    console.log('[L] yt:load',videoId);
    G('l-stream-panel').style.display='none';
    G('l-url-panel').style.display='block';
    currentTrack={isYT:true, videoId, title};
    G('l-tname').textContent=title||'YouTube Video';
    setSyncInfo('<span class="spin">âŸ³</span> Loading YouTube player...');
    // Show listener player in URL pane
    switchSrc('yt');
    initListenerYt(videoId, ()=>{
      setSyncInfo('âœ… Ready â€” waiting for host to play...');
      G('l-stats').style.display='flex';
      if(G('l-mode-val'))G('l-mode-val').textContent='YT';
    });
  });
  sock.on('yt:play',({position,serverPlayAt})=>{
    console.log('[L] yt:play pos='+position.toFixed(2));
    if(!ytListenerReady){ setTimeout(()=>schedYtPlay(position,serverPlayAt), 1500); return; }
    schedYtPlay(position, serverPlayAt);
  });
  sock.on('yt:pause',({position})=>{
    console.log('[L] yt:pause');
    clearInterval(driftTimer);
    if(ytListenerPlayer&&ytListenerReady){
      ytListenerPlayer.pauseVideo();
      try{ ytListenerPlayer.seekTo(position,true); }catch(e){}
    }
    G('l-art').classList.remove('spin');
    setPill('l-pill','pw','dm','Paused');
    setSyncInfo('Host paused.');
  });
  sock.on('yt:seek',({position,playing,serverPlayAt})=>{
    if(!ytListenerPlayer&&!ytListenerReady) return;
    try{ ytListenerPlayer.seekTo(position,true); }catch(e){}
    if(playing) schedYtPlay(position,serverPlayAt);
    else{ try{ytListenerPlayer.pauseVideo();}catch(e){} G('l-art').classList.remove('spin'); }
  });

  sock.on('audio:play',({position,serverPlayAt})=>{
    console.log('[L] audio:play pos='+position.toFixed(2));
    if(!lAudioReady){
      // Audio not ready yet â€” store the command, fire when canplay triggers
      console.log('[L] audio not ready yet, queuing play command');
      lPendingSchedPlay={position, serverPlayAt};
    } else {
      schedPlay(position, serverPlayAt);
    }
  });

  sock.on('audio:pause',({position})=>{
    console.log('[L] audio:pause');
    lPendingSchedPlay=null;
    cancelSched(); clearInterval(driftTimer);
    const a=G('l-audio'); if(!a.src) return;
    a.pause();
    if(Math.abs(a.currentTime-position)>0.5) a.currentTime=position;
    G('l-art').classList.remove('spin');
    setPill('l-pill','pw','dm','Paused');
    setSyncInfo('Host paused.');
  });

  sock.on('audio:seek',({position,playing,serverPlayAt})=>{
    lPendingSchedPlay=null;
    cancelSched();
    const a=G('l-audio'); if(!a.src) return;
    a.currentTime=position;
    if(playing) schedPlay(position, serverPlayAt);
    else { a.pause(); G('l-art').classList.remove('spin'); }
  });

  // â”€â”€ LISTENER STREAM EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sock.on('stream:start',({title,mime})=>{
    console.log('[L] stream:start mime='+mime);
    const useMime=mime||'audio/webm;codecs=opus';
    G('l-stream-panel').style.display='block';
    G('l-url-panel').style.display='none';
    G('l-stream-title').textContent=title||'Live Stream';
    setPill('l-pill','po','do','â— Live');
    setSyncInfo('ğŸ”´ Receiving live audio from host...');
    if(G('l-stats'))G('l-stats').style.display='flex';
    if(G('l-mode-val'))G('l-mode-val').textContent='LIVE';
    initMSE(useMime);
  });

  sock.on('stream:chunk',({seq,mime,data})=>{
    if(mime&&mime!==lMime){ lMime=mime; initMSE(mime); }
    pushStreamChunk(data);
  });

  sock.on('stream:stop',()=>{
    console.log('[L] stream:stop');
    G('l-stream-panel').style.display='none';
    G('l-url-panel').style.display='block';
    setPill('l-pill','pw','dm','Stream ended');
    setSyncInfo('Host stopped streaming.');
    lPlaying=false; lChunks=[];
    try{ if(lMS&&lMS.readyState==='open') lMS.endOfStream(); }catch(e){}
    toast('Stream ended');
  });

  sock.on('room:host_left',()=>{ toast('ğŸšª Host ended the session'); setTimeout(leave,1500); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD LISTENER TRACK
// The KEY fix: use canplay event properly, then fire pending schedPlay
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadListenerTrack(url, title, onReadyCb){
  lAudioReady=false;
  lPendingSchedPlay=null;

  // Kill previous audio chain
  if(lAudioCtx){ lAudioCtx.close().catch(()=>{}); lAudioCtx=null; lChain=null; }

  const a=G('l-audio');
  a.pause();
  a.src=''; a.load(); // fully reset src so new events fire
  G('l-tname').textContent=title||'Loading...';
  G('l-dur').textContent='0:00';
  setSyncInfo('<span class="spin">âŸ³</span> Loading track...');

  a.src=url;
  a.preload='auto';
  a.load();

  function onCanPlay(){
    a.removeEventListener('canplay',  onCanPlay);
    a.removeEventListener('error',    onError);
    lAudioReady=true;
    console.log('[L] canplay fired, duration=',a.duration);
    if(a.duration) G('l-dur').textContent=fmt(a.duration);
    setSyncInfo('âœ… Ready â€” waiting for host to play...');

    // Build audio chain now that media element has data
    if(!lAudioCtx) buildAudioChain(a,'l');

    if(onReadyCb) onReadyCb();

    // Fire any play command that arrived before we were ready
    if(lPendingSchedPlay){
      console.log('[L] firing queued play command');
      const {position,serverPlayAt}=lPendingSchedPlay;
      lPendingSchedPlay=null;
      schedPlay(position, serverPlayAt);
    }
  }

  function onError(){
    a.removeEventListener('canplay', onCanPlay);
    a.removeEventListener('error',   onError);
    lAudioReady=false;
    const codes=['','Aborted','Network error','Decode error','Not supported'];
    const msg=codes[a.error?.code]||'Load failed';
    console.error('[L] audio error:',msg);
    setSyncInfo('âŒ '+msg);
    toast('âŒ Audio error: '+msg, 4000);
  }

  a.addEventListener('canplay', onCanPlay);
  a.addEventListener('error',   onError);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCHEDULED PLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function schedPlay(position, serverPlayAt){
  cancelSched();
  const a=G('l-audio');
  if(!a.src){ console.warn('[sched] no src'); return; }
  if(!lAudioReady){ console.warn('[sched] audio not ready'); lPendingSchedPlay={position,serverPlayAt}; return; }

  const localPlayAt = serverPlayAt + clockOffset;
  const msLeft      = localPlayAt - Date.now();

  setPill('l-pill','pw','dm','Buffering...');
  setSyncInfo(`âŸ³ Syncing in ${Math.max(0,Math.round(msLeft))}ms...`);

  // Pre-seek
  const preSeekTarget = Math.max(0, position + Math.max(0, -msLeft/1000));
  if(Math.abs(a.currentTime - preSeekTarget) > DRIFT_TOL) a.currentTime=preSeekTarget;

  function execute(){
    const late  = Math.max(0,(Date.now()-localPlayAt))/1000;
    const target= Math.max(0, position+late);
    if(Math.abs(a.currentTime-target)>DRIFT_TOL) a.currentTime=target;

    a.play().then(()=>{
      console.log('[L] playing âœ… at',a.currentTime.toFixed(2));
      G('l-art').classList.add('spin');
      setPill('l-pill','ps','dc','â— In Sync');
      setSyncInfo('ğŸ§ Playing in sync');
      G('unlock').classList.add('gone');
      if(G('l-stats'))G('l-stats').style.display='flex';
      if(G('l-mode-val'))G('l-mode-val').textContent='URL';

      // Audio chain should already exist from canplay, but build if missing
      if(!lAudioCtx){ buildAudioChain(a,'l'); }
      if(lAudioCtx) lAudioCtx.resume();
      startProg(a,'l-fill','l-cur','l-dur');
      setTimeout(()=>startViz('l-viz'), 100);

      // Continuous drift correction
      clearInterval(driftTimer);
      driftTimer=setInterval(()=>{
        if(a.paused) return;
        const elapsed=(srvNow()-serverPlayAt)/1000;
        const expected=position+elapsed;
        const d=Math.abs(a.currentTime-expected);
        if(d>DRIFT_HARD){ a.currentTime=expected; console.warn('[SYNC] corrected',d.toFixed(3)+'s'); }
        if(G('l-drift')) G('l-drift').textContent=Math.round(d*1000)+'ms';
      }, 3000);
    }).catch(err=>{
      console.warn('[play] blocked:',err.message);
      G('unlock').classList.remove('gone');
      setSyncInfo('ğŸ‘† Tap to play');
      G('unlock').onclick=()=>{
        doUnlock();
        a.currentTime=Math.max(0,position+(srvNow()-serverPlayAt)/1000);
        a.play().then(()=>{
          G('l-art').classList.add('spin');
          setPill('l-pill','ps','dc','â— In Sync');
          if(!lAudioCtx) buildAudioChain(a,'l');
          if(lAudioCtx) lAudioCtx.resume();
          startViz('l-viz');
          startProg(a,'l-fill','l-cur','l-dur');
        });
      };
    });
  }

  if(msLeft>20) pendingPlay=setTimeout(execute, msLeft);
  else execute();
}

function cancelSched(){
  if(pendingPlay){ clearTimeout(pendingPlay); pendingPlay=null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CREATE / JOIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createRoom(){
  const name = G('rname-input').value.trim()||'Audio Room';
  const btn  = document.querySelector('#s-create .btn');
  if(btn){ btn.disabled=true; btn.textContent='Creating...'; }
  amHost = true;
  initSock();

  const doCreate = () => {
    sock.emit('room:create', {name}, res => {
      if(btn){ btn.disabled=false; btn.textContent='Create Room â†’'; }
      if(!res?.ok){ toast('âŒ Could not create room â€” try again'); return; }
      roomCode = res.code;
      G('h-rname').textContent = res.name;
      G('h-code').textContent  = res.code;
      show('s-host');
      toast('ğŸ‰ Room created! Share code: '+res.code);
    });
  };

  if(sock.connected){
    doCreate();
  } else {
    let connected = false;
    sock.once('connect', ()=>{
      connected = true;
      setTimeout(doCreate, 200);
    });
    setTimeout(()=>{
      if(!connected){
        if(btn){ btn.disabled=false; btn.textContent='Create Room â†’'; }
        toast('âŒ Cannot connect to server. Check your internet.');
      }
    }, 8000);
  }
}

async function joinRoom(){
  const code = G('join-code').value.trim().toUpperCase().replace(/[^A-Z0-9]/g,'');
  if(code.length < 6){ toast('Enter the full 6-letter code'); return; }

  const btn = document.querySelector('#s-join .btn');
  if(btn){ btn.disabled=true; btn.textContent='Joining...'; }
  G('join-err').classList.remove('on');

  // Step 1: HTTP pre-check â€” verify room exists before even connecting socket
  // This gives a clear error if server restarted and room was lost
  try{
    const check = await fetch('/room/'+code);
    const data  = await check.json();
    if(!data.exists){
      G('join-err').textContent = 'Room "'+code+'" not found. Check the code or ask the host to recreate the room.';
      G('join-err').classList.add('on');
      if(btn){ btn.disabled=false; btn.textContent='Join Room â†’'; }
      return;
    }
  } catch(e){
    // Server unreachable â€” still try socket in case HTTP is flaky
    console.warn('HTTP room check failed, trying socket anyway:', e.message);
  }

  // Step 2: Ensure socket connected THEN emit join
  amHost = false;
  initSock();

  const doJoin = () => {
    sock.emit('room:join', {code}, res => {
      if(btn){ btn.disabled=false; btn.textContent='Join Room â†’'; }
      if(!res?.ok){
        G('join-err').textContent = 'Room not found. The host may have left or the server restarted.';
        G('join-err').classList.add('on');
        return;
      }
      roomCode = code;
      G('l-rname').textContent = res.name;
      G('l-clabel').textContent = 'Room: '+code;
      show('s-listen');
      toast('ğŸ§ Joined "'+res.name+'"!');

      if(res.track?.isYT && res.track.videoId){
        currentTrack = {isYT:true, videoId:res.track.videoId, title:res.track.title};
        G('l-tname').textContent = res.track.title||'YouTube';
        setSyncInfo('<span class="spin">âŸ³</span> Loading YouTube player...');
        switchSrc('yt');
        initListenerYt(res.track.videoId, ()=>{
          setSyncInfo('âœ… Ready â€” waiting for host to play...');
          if(res.state?.playing && res.state.serverPlayAt){
            const elapsed=(srvNow()-res.state.serverPlayAt)/1000;
            schedYtPlay(Math.max(0,(res.state.position||0)+elapsed), srvNow()+SCHED_LEAD);
          }
        });
      } else if(res.track?.streamUrl){
        loadListenerTrack(res.track.streamUrl, res.track.title, ()=>{
          if(res.state?.playing && res.state.serverPlayAt){
            const elapsed=(srvNow()-res.state.serverPlayAt)/1000;
            schedPlay(Math.max(0,(res.state.position||0)+elapsed), srvNow()+SCHED_LEAD);
          } else {
            G('l-audio').currentTime = res.state?.position||0;
            setSyncInfo('Ready â€” waiting for host to play.');
          }
        });
      } else {
        setSyncInfo('âœ… Joined â€” waiting for host to load a track...');
      }
    });
  };

  // If already connected, join immediately. Otherwise wait for connect.
  if(sock.connected){
    doJoin();
  } else {
    setSyncInfo('<span class="spin">âŸ³</span> Connecting...');
    // Wait up to 8 seconds for connection
    let connected = false;
    sock.once('connect', ()=>{
      connected = true;
      setTimeout(doJoin, 200); // small delay to let NTP start
    });
    setTimeout(()=>{
      if(!connected){
        if(btn){ btn.disabled=false; btn.textContent='Join Room â†’'; }
        G('join-err').textContent = 'Could not connect to server. Check your internet and try again.';
        G('join-err').classList.add('on');
      }
    }, 8000);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOST CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hostPlay(){
  if(currentTrack?.isYT){ hostYtPlay(); return; }
  const a=G('h-audio'); if(!a.src){ toast('Load a track first'); return; }
  if(hAudioCtx) hAudioCtx.resume();
  const pos=a.currentTime, playAt=srvNow()+SCHED_LEAD;
  setTimeout(()=>a.play().catch(()=>{}), SCHED_LEAD);
  G('h-art').classList.add('spin');
  setPill('h-pill','pl','dg','â— Playing');
  sock.emit('audio:play',{position:pos, serverPlayAt:playAt});
}
function hostPause(){
  if(currentTrack?.isYT){ hostYtPause(); return; }
  const a=G('h-audio');
  a.pause(); G('h-art').classList.remove('spin');
  setPill('h-pill','pw','dm','Paused');
  sock.emit('audio:pause',{position:a.currentTime});
}
function hostRestart(){
  if(currentTrack?.isYT){ hostYtRestart(); return; }
  const a=G('h-audio'); if(!a.src) return;
  if(hAudioCtx) hAudioCtx.resume();
  a.currentTime=0;
  const playAt=srvNow()+SCHED_LEAD;
  setTimeout(()=>a.play().catch(()=>{}), SCHED_LEAD);
  G('h-art').classList.add('spin');
  setPill('h-pill','pl','dg','â— Playing');
  sock.emit('audio:play',{position:0, serverPlayAt:playAt});
}
function hostVol(v){
  const val=parseFloat(v);
  G('h-audio').volume=val;
  if(hChain) hChain.master.gain.value=val;
  G('h-vol-val').textContent=Math.round(val*100)+'%';
}
function listVol(v){
  const val=parseFloat(v);
  G('l-audio').volume=val;
  G('l-stream-audio').volume=val;
  if(lChain) lChain.master.gain.value=val;
  if(ytListenerPlayer&&ytListenerReady){ try{ytListenerPlayer.setVolume(val*100);}catch(e){} }
  G('l-vol-val').textContent=Math.round(val*100)+'%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function leave(){
  try{ if(mediaRec&&mediaRec.state!=='inactive') mediaRec.stop(); }catch(e){}
  try{ if(screenStream) screenStream.getTracks().forEach(t=>t.stop()); }catch(e){}
  try{ if(screenVizCtx){ screenVizCtx.close(); screenVizCtx=null; } }catch(e){}
  screenStream=null; mediaRec=null;
  cancelSched(); clearInterval(window._ka); clearInterval(driftTimer);
  if(progRaf){ cancelAnimationFrame(progRaf); progRaf=null; }
  if(vizRaf){  cancelAnimationFrame(vizRaf);  vizRaf=null; vizAnalyser=null; }
  ['h-audio','l-audio','l-stream-audio'].forEach(id=>{
    const a=G(id); if(a){ a.pause(); a.src=''; a.load(); }
  });
  try{ if(hAudioCtx){ hAudioCtx.close(); hAudioCtx=null; hChain=null; } }catch(e){}
  try{ if(lAudioCtx){ lAudioCtx.close(); lAudioCtx=null; lChain=null; } }catch(e){}
  try{ if(lMS&&lMS.readyState==='open') lMS.endOfStream(); }catch(e){}
  lMS=null; lSB=null; lChunks=[]; lPlaying=false; lAudioReady=false; lPendingSchedPlay=null;
  // Destroy YouTube players
  try{ if(ytPlayer){ ytPlayer.destroy(); ytPlayer=null; ytReady=false; } }catch(e){}
  try{ if(ytListenerPlayer){ ytListenerPlayer.destroy(); ytListenerPlayer=null; ytListenerReady=false; } }catch(e){}
  clearInterval(ytSyncInterval); ytSyncInterval=null; ytVideoId=null;
  if(sock){ sock.disconnect(); sock=null; }
  roomCode=null; listeners={}; currentTrack=null;
  setConn(false); show('s-home');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISUALIZER + PROGRESS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startProg(audio, fillId, curId, durId){
  if(progRaf){ cancelAnimationFrame(progRaf); progRaf=null; }
  function tick(){
    progRaf=requestAnimationFrame(tick);
    const p=audio.duration?(audio.currentTime/audio.duration*100):0;
    const f=G(fillId); if(f) f.style.width=p+'%';
    if(G(curId)) G(curId).textContent=fmt(audio.currentTime);
    if(G(durId)&&audio.duration) G(durId).textContent=fmt(audio.duration);
  }
  tick();
}

function startViz(cvId){
  if(vizRaf){ cancelAnimationFrame(vizRaf); vizRaf=null; }
  if(!vizAnalyser) return;
  const cv=G(cvId); if(!cv) return;
  const dpr=window.devicePixelRatio||1;
  const W=cv.offsetWidth||800, H=cv.offsetHeight||58;
  cv.width=W*dpr; cv.height=H*dpr;
  const ctx=cv.getContext('2d'); ctx.scale(dpr,dpr);
  const bins=vizAnalyser.frequencyBinCount;
  const buf=new Uint8Array(bins), peaks=new Float32Array(bins);
  const dec=0.984, bw=(W/bins)*2.2;
  function draw(){
    vizRaf=requestAnimationFrame(draw);
    vizAnalyser.getByteFrequencyData(buf);
    ctx.fillStyle='#06070c'; ctx.fillRect(0,0,W,H);
    let x=0;
    for(let i=0;i<bins;i++){
      const r=buf[i]/255, h=r*H*0.9;
      if(r>peaks[i]) peaks[i]=r; else peaks[i]*=dec;
      const hue=175+i/bins*100, al=0.6+r*0.4;
      ctx.fillStyle=`hsla(${hue},90%,60%,${al})`;
      ctx.fillRect(x, H-h, bw, h);
      if(peaks[i]>0.05){ ctx.fillStyle=`hsla(${hue},100%,85%,.7)`; ctx.fillRect(x,H-peaks[i]*H*0.9-1,bw,1.5); }
      x+=bw+0.5;
    }
  }
  draw();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
G('join-code').addEventListener('input',function(){ this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,''); });
G('join-code').addEventListener('keydown',e=>{ if(e.key==='Enter') joinRoom(); });
G('rname-input').addEventListener('keydown',e=>{ if(e.key==='Enter') createRoom(); });
window.addEventListener('load', ()=>{
  try{ initSock(); }
  catch(e){ console.error('initSock error:',e); }
});
</script>
</body>
</html>
