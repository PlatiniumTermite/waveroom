<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>WaveRoom â€” Spatial Sync Audio</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#06070c;--s:#0b0d17;--b:#161b2e;--c:#00e5ff;--p:#8b5cf6;--g:#00ff88;--r:#ff4466;--t:#e8edf8;--m:#4a5578;--gold:#ffd700}
html,body{background:var(--bg);color:var(--t);font-family:'Syne',sans-serif;min-height:100vh;overscroll-behavior:none;-webkit-tap-highlight-color:transparent}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(var(--b) 1px,transparent 1px),linear-gradient(90deg,var(--b) 1px,transparent 1px);background-size:48px 48px;opacity:.1;pointer-events:none;z-index:0}
#app{position:relative;z-index:1;max-width:820px;margin:0 auto;padding:24px 16px 60px}
.nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:44px}
.nav-left{display:flex;align-items:center;gap:10px}
.nav-icon{width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,var(--c),var(--p));display:flex;align-items:center;justify-content:center;font-size:18px}
.nav-name{font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--c),var(--p));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.nav-badge{font-family:'Space Mono',monospace;font-size:9px;color:var(--gold);border:1px solid rgba(255,215,0,.25);border-radius:20px;padding:3px 9px;background:rgba(255,215,0,.06)}
.nav-status{display:flex;align-items:center;gap:5px;font-family:'Space Mono',monospace;font-size:9px;color:var(--m)}
.nav-dot{width:6px;height:6px;border-radius:50%;background:var(--m);flex-shrink:0;transition:background .4s}
.nav-dot.online{background:var(--g);animation:blk 1.8s infinite}
@keyframes blk{0%,100%{opacity:1}50%{opacity:.3}}
.screen{display:none}.screen.on{display:block;animation:fadeUp .22s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.hero{text-align:center;padding:6px 0 32px}
.hero-chip{display:inline-flex;align-items:center;gap:5px;font-family:'Space Mono',monospace;font-size:10px;color:var(--c);border:1px solid rgba(0,229,255,.18);border-radius:20px;padding:3px 11px;margin-bottom:18px;background:rgba(0,229,255,.05)}
.hero h1{font-size:clamp(28px,6.5vw,62px);font-weight:800;letter-spacing:-2px;line-height:1.04;margin-bottom:14px}
.hero h1 em{font-style:normal;background:linear-gradient(135deg,var(--c),var(--p));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero-sub{font-family:'Space Mono',monospace;font-size:11.5px;color:var(--m);max-width:370px;margin:0 auto 32px;line-height:1.9}
.home-cards{display:grid;grid-template-columns:1fr 1fr;gap:12px;max-width:520px;margin:0 auto 24px}
@media(max-width:440px){.home-cards{grid-template-columns:1fr}}
.hcard{background:var(--s);border:1px solid var(--b);border-radius:14px;padding:22px 18px;cursor:pointer;text-align:left;transition:border-color .2s,transform .2s,box-shadow .2s;overflow:hidden}
.hcard:hover{border-color:rgba(0,229,255,.4);transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,229,255,.08)}
.hi{font-size:24px;margin-bottom:9px}.ht{font-size:15px;font-weight:700;margin-bottom:4px}
.hd{font-size:11px;color:var(--m);font-family:'Space Mono',monospace;line-height:1.55}
.feature-strip{display:flex;justify-content:center;gap:20px;flex-wrap:wrap;max-width:520px;margin:0 auto}
.feat{display:flex;align-items:center;gap:5px;font-family:'Space Mono',monospace;font-size:10px;color:var(--m)}
.fbox{max-width:400px;margin:0 auto}
.back{background:none;border:none;color:var(--m);font-family:'Space Mono',monospace;font-size:11px;cursor:pointer;margin-bottom:26px;padding:0;transition:color .2s}
.back:hover{color:var(--c)}
.ftitle{font-size:28px;font-weight:800;letter-spacing:-1px;margin-bottom:5px}
.fsub{font-family:'Space Mono',monospace;font-size:11px;color:var(--m);margin-bottom:22px;line-height:1.75}
.fl{display:block;font-size:9px;font-weight:700;letter-spacing:1.4px;text-transform:uppercase;color:var(--m);margin-bottom:6px}
.fi{width:100%;background:var(--s);border:1px solid var(--b);border-radius:9px;padding:12px 14px;color:var(--t);font-family:'Space Mono',monospace;font-size:13px;outline:none;transition:border-color .2s,box-shadow .2s;margin-bottom:13px}
.fi:focus{border-color:var(--c);box-shadow:0 0 0 2px rgba(0,229,255,.08)}
.fi::placeholder{color:var(--m)}
#join-code{letter-spacing:6px;font-size:22px;text-transform:uppercase;text-align:center;padding:14px}
.btn{width:100%;padding:13px;border-radius:9px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;border:none;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:7px;letter-spacing:.3px}
.bc{background:linear-gradient(135deg,var(--c),#00b8d9);color:#000}
.bc:hover{box-shadow:0 6px 24px rgba(0,229,255,.32);transform:translateY(-1px)}
.bp{background:linear-gradient(135deg,var(--p),#6d28d9);color:#fff}
.bp:hover{box-shadow:0 6px 24px rgba(139,92,246,.32);transform:translateY(-1px)}
.bg{background:var(--s);border:1px solid var(--b);color:var(--t)}
.bg:hover{border-color:rgba(0,229,255,.4);color:var(--c)}
.br{background:rgba(255,68,102,.12);border:1px solid rgba(255,68,102,.3);color:var(--r)}
.btn:disabled{opacity:.25;cursor:not-allowed;transform:none!important;box-shadow:none!important}
.brow{display:flex;gap:8px}.brow .btn{flex:1;padding:10px 6px;font-size:12px}
.ferr{background:rgba(255,68,102,.08);border:1px solid rgba(255,68,102,.25);border-radius:8px;padding:10px 13px;font-family:'Space Mono',monospace;font-size:11px;color:var(--r);margin-bottom:12px;display:none;line-height:1.6}
.ferr.on{display:block}
.rhead{display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:15px}
.rname{font-size:21px;font-weight:800;letter-spacing:-.5px}
.rcode{display:inline-flex;align-items:center;gap:7px;margin-top:5px;background:var(--s);border:1px solid var(--b);border-radius:8px;padding:6px 12px;font-family:'Space Mono',monospace;font-size:18px;font-weight:700;letter-spacing:5px;color:var(--c);cursor:pointer;transition:all .2s;user-select:none}
.rcode:hover{border-color:var(--c)}
.rcode small{font-size:9px;color:var(--m);letter-spacing:0;font-weight:400}
.pill{display:inline-flex;align-items:center;gap:6px;padding:5px 11px;border-radius:100px;font-family:'Space Mono',monospace;font-size:10px;font-weight:700;white-space:nowrap}
.pl{background:rgba(0,255,136,.08);color:var(--g);border:1px solid rgba(0,255,136,.2)}
.pw{background:rgba(74,85,120,.1);color:var(--m);border:1px solid var(--b)}
.ps{background:rgba(0,229,255,.08);color:var(--c);border:1px solid rgba(0,229,255,.2)}
.dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.dg{background:var(--g);animation:blk 1.3s infinite}.dm{background:var(--m)}.dc{background:var(--c);animation:blk 1.3s infinite}
.panel{background:var(--s);border:1px solid var(--b);border-radius:13px;padding:16px;margin-bottom:11px;position:relative;overflow:hidden}
.ptitle{font-size:9px;text-transform:uppercase;letter-spacing:1.3px;color:var(--m);font-family:'Space Mono',monospace;margin-bottom:11px}
.dbadge{position:absolute;top:13px;right:13px;font-family:'Space Mono',monospace;font-size:8px;font-weight:700;color:var(--gold);border:1px solid rgba(255,215,0,.2);border-radius:4px;padding:2px 6px;background:rgba(255,215,0,.05);letter-spacing:.8px}
.load-panel{background:var(--s);border:1px solid var(--b);border-radius:13px;padding:16px;margin-bottom:11px}
.src-tabs{display:flex;gap:6px;margin-bottom:13px}
.src-tab{flex:1;padding:8px 5px;border-radius:8px;font-family:'Space Mono',monospace;font-size:10px;font-weight:700;cursor:pointer;border:1px solid var(--b);background:transparent;color:var(--m);transition:all .18s;text-align:center}
.src-tab.active{background:rgba(0,229,255,.08);color:var(--c);border-color:rgba(0,229,255,.3)}
.src-pane{display:none}.src-pane.on{display:block}
.url-row{display:flex;gap:8px}.url-row .fi{margin-bottom:0;flex:1;font-size:11.5px}.url-row .btn{width:auto;padding:12px 16px;white-space:nowrap;font-size:12px}
.load-status{display:flex;align-items:center;gap:7px;margin-top:10px;font-family:'Space Mono',monospace;font-size:11px;min-height:22px;color:var(--m);line-height:1.5}
.spin{display:inline-block;animation:rot .7s linear infinite}
@keyframes rot{to{transform:rotate(360deg)}}
.tinfo{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.tart{width:44px;height:44px;border-radius:10px;flex-shrink:0;background:linear-gradient(135deg,var(--p),var(--c));display:flex;align-items:center;justify-content:center;font-size:20px;animation:rot 12s linear infinite;animation-play-state:paused}
.tart.spin{animation-play-state:running}
.tname{font-size:13.5px;font-weight:700;word-break:break-all;line-height:1.35}
.tsub{font-family:'Space Mono',monospace;font-size:10px;color:var(--m);margin-top:3px}
.seekbar{padding:6px 0;cursor:pointer;margin-bottom:5px;user-select:none;touch-action:none}
.seek-track{width:100%;height:5px;background:var(--b);border-radius:10px;position:relative}
.seek-fill{height:100%;width:0%;border-radius:10px;transition:width .18s linear;background:linear-gradient(90deg,var(--c),var(--p))}
.seek-times{display:flex;justify-content:space-between;font-family:'Space Mono',monospace;font-size:9px;color:var(--m);margin-top:5px}
.vol{display:flex;align-items:center;gap:8px;margin-top:11px}
.vol-lbl{font-family:'Space Mono',monospace;font-size:10px;color:var(--m);white-space:nowrap}
input[type=range]{flex:1;accent-color:var(--c);cursor:pointer;height:18px}
.eq-section{margin-top:13px;padding:11px 13px;background:rgba(0,0,0,.25);border:1px solid rgba(255,215,0,.1);border-radius:9px}
.eq-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.eq-title{font-family:'Space Mono',monospace;font-size:9px;color:var(--gold);text-transform:uppercase;letter-spacing:1px;display:flex;align-items:center;gap:5px}
.eq-ai-badge{font-family:'Space Mono',monospace;font-size:7px;background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.2);color:var(--gold);padding:1px 5px;border-radius:3px;letter-spacing:.8px}
.eq-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:5px}
.eq-btn{padding:7px 3px;border-radius:6px;font-family:'Space Mono',monospace;font-size:9px;font-weight:700;cursor:pointer;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.02);color:var(--m);transition:all .15s;text-align:center;line-height:1.4}
.eq-btn:hover,.eq-btn.on{background:rgba(255,215,0,.1);color:var(--gold);border-color:rgba(255,215,0,.3)}
.spatial-indicator{display:flex;align-items:center;gap:6px;margin-top:8px;font-family:'Space Mono',monospace;font-size:9px;color:var(--m)}
.spatial-bar{flex:1;height:3px;background:var(--b);border-radius:10px;overflow:hidden}
.spatial-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--c),var(--gold));transition:width .5s ease;border-radius:10px}
canvas{width:100%;height:62px;display:block;border-radius:8px;background:var(--bg)}
.lcnt{color:var(--c);font-weight:700}
.nol{font-family:'Space Mono',monospace;font-size:11px;color:var(--m);text-align:center;padding:13px 0;line-height:1.6}
.litem{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,.04);font-family:'Space Mono',monospace;font-size:11px}
.litem:last-child{border:none}
.lav{width:26px;height:26px;border-radius:6px;background:linear-gradient(135deg,var(--p),var(--c));display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
.sbox{background:rgba(0,229,255,.03);border:1px solid rgba(0,229,255,.1);border-radius:9px;padding:10px 13px;font-family:'Space Mono',monospace;font-size:11px;color:var(--m);line-height:1.9}
.sbox b{color:var(--c)}
.latency-row{display:flex;gap:16px;margin-top:10px;flex-wrap:wrap}
.latency-item{font-family:'Space Mono',monospace;font-size:9px;display:flex;flex-direction:column;gap:2px}
.latency-val{font-size:14px;font-weight:700;color:var(--c)}
.latency-lbl{color:var(--m);font-size:8px;letter-spacing:.5px;text-transform:uppercase}
.toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%) translateY(90px);background:#12161f;border:1px solid rgba(255,255,255,.1);border-radius:9px;padding:10px 18px;font-family:'Space Mono',monospace;font-size:11px;z-index:9999;transition:transform .28s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;max-width:92vw;text-align:center;pointer-events:none;box-shadow:0 8px 32px rgba(0,0,0,.5)}
.toast.on{transform:translateX(-50%) translateY(0)}
#unlock{position:fixed;inset:0;background:rgba(6,7,12,.97);z-index:1000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;cursor:pointer;backdrop-filter:blur(10px)}
#unlock.gone{display:none}
.ui{font-size:52px;animation:tapA 1.4s infinite ease-in-out}
@keyframes tapA{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}
.ut{font-size:20px;font-weight:800;letter-spacing:-.5px}
.us{font-family:'Space Mono',monospace;font-size:11px;color:var(--m);text-align:center;max-width:240px;line-height:1.7}
</style>
</head>
<body>

<div id="unlock" class="gone" onclick="doUnlock()">
  <div class="ui">ğŸ‘†</div>
  <div class="ut">Tap to Enable Audio</div>
  <div class="us">One tap needed before audio plays in your browser</div>
</div>

<div id="app">
  <div class="nav">
    <div class="nav-left">
      <div class="nav-icon">ğŸŒŠ</div>
      <div class="nav-name">WaveRoom</div>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="nav-status"><div class="nav-dot" id="conn-dot"></div><span id="conn-label">Offline</span></div>
      <div class="nav-badge">âœ¦ SPATIAL AI</div>
    </div>
  </div>

  <!-- HOME -->
  <div id="s-home" class="screen on">
    <div class="hero">
      <div class="hero-chip">âš¡ AI Spatial Audio Â· Zero-Lag Sync Â· All Devices</div>
      <h1>One Audio.<br><em>Every Device.</em><br>Same Second.</h1>
      <p class="hero-sub">Host loads any YouTube link or audio URL.<br>Every listener hears the exact same moment<br>â€” with AI-powered spatial surround sound.</p>
      <div class="home-cards">
        <div class="hcard" onclick="show('s-create')">
          <div class="hi">ğŸ™</div>
          <div class="ht">Host a Room</div>
          <div class="hd">Load any audio. Control play/pause for everyone in perfect sync.</div>
        </div>
        <div class="hcard" onclick="show('s-join')">
          <div class="hi">ğŸ§</div>
          <div class="ht">Join a Room</div>
          <div class="hd">Enter 6-letter code. Spatial audio syncs automatically.</div>
        </div>
      </div>
      <div class="feature-strip">
        <div class="feat">ğŸ”Š Spatial Surround</div>
        <div class="feat">âš¡ &lt;60ms Sync</div>
        <div class="feat">ğŸµ YouTube + URL</div>
        <div class="feat">ğŸ“¡ NTP Clock Sync</div>
      </div>
    </div>
  </div>

  <!-- CREATE -->
  <div id="s-create" class="screen">
    <div class="fbox">
      <button class="back" onclick="show('s-home')">â† Back</button>
      <div class="ftitle">Host a Room</div>
      <div class="fsub">Create a room. Load any audio source. You control playback for everyone.</div>
      <label class="fl">Room Name (optional)</label>
      <input class="fi" id="rname-input" type="text" placeholder="Friday Night Session" maxlength="40">
      <button class="btn bc" onclick="createRoom()">Create Room â†’</button>
    </div>
  </div>

  <!-- JOIN -->
  <div id="s-join" class="screen">
    <div class="fbox">
      <button class="back" onclick="show('s-home')">â† Back</button>
      <div class="ftitle">Join a Room</div>
      <div class="fsub">Enter the 6-letter code shared by the host.</div>
      <label class="fl">Room Code</label>
      <input class="fi" id="join-code" type="text" placeholder="ABC123" maxlength="6" autocomplete="off" spellcheck="false" inputmode="text">
      <div class="ferr" id="join-err">Room not found. Check the code and make sure the host is connected.</div>
      <button class="btn bp" onclick="joinRoom()">Join Room â†’</button>
    </div>
  </div>

  <!-- HOST ROOM -->
  <div id="s-host" class="screen">
    <div class="rhead">
      <div>
        <div class="rname" id="h-rname">Room</div>
        <div class="rcode" onclick="copyCode()">
          <span id="h-code">------</span>
          <small>tap to copy</small>
        </div>
      </div>
      <div id="h-pill" class="pill pw"><div class="dot dm"></div><span>Ready</span></div>
    </div>

    <div class="load-panel">
      <div class="ptitle">Load Audio for Everyone</div>
      <div class="src-tabs">
        <button class="src-tab active" id="tab-youtube" onclick="switchTab('youtube')">â–¶ YouTube</button>
        <button class="src-tab" id="tab-url" onclick="switchTab('url')">ğŸ”— Direct URL</button>
        <button class="src-tab" id="tab-file" onclick="switchTab('file')">ğŸ“ File</button>
      </div>
      <div class="src-pane on" id="pane-youtube">
        <div class="url-row">
          <input class="fi" id="yt-url" type="url" placeholder="Paste YouTube URL..." autocomplete="off">
          <button class="btn bc" id="yt-btn" onclick="loadYoutube()">Load</button>
        </div>
        <div class="load-status" id="yt-status"></div>
      </div>
      <div class="src-pane" id="pane-url">
        <div class="url-row">
          <input class="fi" id="direct-url" type="url" placeholder="https://example.com/audio.mp3" autocomplete="off">
          <button class="btn bc" onclick="loadDirectUrl()">Load</button>
        </div>
        <div class="load-status" id="url-status"></div>
      </div>
      <div class="src-pane" id="pane-file">
        <button class="btn bg" onclick="G('file-input').click()" style="margin-bottom:9px">ğŸ“ Choose Audio File</button>
        <input type="file" id="file-input" accept="audio/*,video/*" style="display:none" onchange="loadFile()">
        <div style="font-family:'Space Mono',monospace;font-size:10px;color:var(--m);line-height:1.65;padding:8px 0">âš ï¸ Local files only play on your device. Use YouTube or URL for shared listening.</div>
        <div class="load-status" id="file-status"></div>
      </div>
    </div>

    <div class="panel" id="h-player" style="display:none">
      <div class="dbadge">SPATIAL AI âœ¦</div>
      <div class="tinfo">
        <div class="tart" id="h-art">ğŸµ</div>
        <div style="flex:1;min-width:0">
          <div class="tname" id="h-tname">â€”</div>
          <div class="tsub" id="h-tsub">Loading...</div>
        </div>
      </div>
      <div class="seekbar" id="h-seekbar">
        <div class="seek-track"><div class="seek-fill" id="h-fill"></div></div>
        <div class="seek-times"><span id="h-cur">0:00</span><span id="h-dur">0:00</span></div>
      </div>
      <div class="brow" style="margin-top:11px">
        <button class="btn bc" id="h-play-btn" onclick="hostPlay()" disabled>â–¶ Play</button>
        <button class="btn bg" onclick="hostPause()">â¸ Pause</button>
        <button class="btn bg" onclick="hostRestart()">â® Restart</button>
      </div>
      <div class="vol">
        <span class="vol-lbl">ğŸ”Š</span>
        <input type="range" min="0" max="1" step="0.01" value="0.85" id="h-vol" oninput="hostVolChange(this.value)">
        <span style="font-family:'Space Mono',monospace;font-size:10px;color:var(--m)" id="h-vol-val">85%</span>
      </div>
      <div class="eq-section">
        <div class="eq-header">
          <div class="eq-title">ğŸ› AI Spatial Audio <span class="eq-ai-badge">AI POWERED</span></div>
        </div>
        <div class="eq-grid">
          <button class="eq-btn on" id="heq-flat"   onclick="setEQ(this,'h')">Flat<br><span style="font-size:7px;opacity:.5">Linear</span></button>
          <button class="eq-btn"    id="heq-atmos"  onclick="setEQ(this,'h')">Atmos<br><span style="font-size:7px;opacity:.5">3D</span></button>
          <button class="eq-btn"    id="heq-cinema" onclick="setEQ(this,'h')">Cinema<br><span style="font-size:7px;opacity:.5">Wide</span></button>
          <button class="eq-btn"    id="heq-bass"   onclick="setEQ(this,'h')">Bass+<br><span style="font-size:7px;opacity:.5">Deep</span></button>
          <button class="eq-btn"    id="heq-vocal"  onclick="setEQ(this,'h')">Vocal<br><span style="font-size:7px;opacity:.5">Clear</span></button>
        </div>
        <div class="spatial-indicator">
          <span style="font-size:9px;white-space:nowrap">Spatial Depth</span>
          <div class="spatial-bar"><div class="spatial-fill" id="h-spatial-fill"></div></div>
          <span style="font-family:'Space Mono',monospace;font-size:9px;min-width:28px;text-align:right" id="h-spatial-val">0%</span>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="ptitle">Live Frequency Spectrum</div>
      <canvas id="h-viz"></canvas>
    </div>

    <div class="panel">
      <div class="ptitle" style="display:flex;justify-content:space-between;align-items:center">
        <span>Connected Listeners</span><span class="lcnt" id="h-lcnt">0</span>
      </div>
      <div id="h-llist"><div class="nol">No one joined yet â€” share your code!</div></div>
    </div>

    <div style="margin-top:12px"><button class="btn br" onclick="leave()">ğŸšª End Room &amp; Leave</button></div>
    <audio id="h-audio" crossorigin="anonymous" style="display:none" preload="auto"></audio>
  </div>

  <!-- LISTENER ROOM -->
  <div id="s-listen" class="screen">
    <div class="rhead">
      <div>
        <div class="rname" id="l-rname">Room</div>
        <div style="font-family:'Space Mono',monospace;font-size:10px;color:var(--m);margin-top:4px" id="l-clabel"></div>
      </div>
      <div id="l-pill" class="pill pw"><div class="dot dm"></div><span>Connecting...</span></div>
    </div>

    <div class="panel">
      <div class="dbadge">SPATIAL AI âœ¦</div>
      <div class="tinfo">
        <div class="tart" id="l-art">ğŸµ</div>
        <div style="flex:1;min-width:0">
          <div class="tname" id="l-tname">Waiting for host...</div>
          <div class="tsub">Host controls playback Â· you control your volume</div>
        </div>
      </div>
      <div class="seekbar">
        <div class="seek-track"><div class="seek-fill" id="l-fill"></div></div>
        <div class="seek-times"><span id="l-cur">0:00</span><span id="l-dur">0:00</span></div>
      </div>
      <div class="vol" style="margin-top:11px">
        <span class="vol-lbl">ğŸ”Š</span>
        <input type="range" min="0" max="1" step="0.01" value="0.85" id="l-vol" oninput="listVolChange(this.value)">
        <span style="font-family:'Space Mono',monospace;font-size:10px;color:var(--m)" id="l-vol-val">85%</span>
      </div>
      <div class="eq-section">
        <div class="eq-header">
          <div class="eq-title">ğŸ› AI Spatial Audio <span class="eq-ai-badge">AI POWERED</span></div>
        </div>
        <div class="eq-grid">
          <button class="eq-btn on" id="leq-flat"   onclick="setEQ(this,'l')">Flat<br><span style="font-size:7px;opacity:.5">Linear</span></button>
          <button class="eq-btn"    id="leq-atmos"  onclick="setEQ(this,'l')">Atmos<br><span style="font-size:7px;opacity:.5">3D</span></button>
          <button class="eq-btn"    id="leq-cinema" onclick="setEQ(this,'l')">Cinema<br><span style="font-size:7px;opacity:.5">Wide</span></button>
          <button class="eq-btn"    id="leq-bass"   onclick="setEQ(this,'l')">Bass+<br><span style="font-size:7px;opacity:.5">Deep</span></button>
          <button class="eq-btn"    id="leq-vocal"  onclick="setEQ(this,'l')">Vocal<br><span style="font-size:7px;opacity:.5">Clear</span></button>
        </div>
        <div class="spatial-indicator">
          <span style="font-size:9px;white-space:nowrap">Spatial Depth</span>
          <div class="spatial-bar"><div class="spatial-fill" id="l-spatial-fill"></div></div>
          <span style="font-family:'Space Mono',monospace;font-size:9px;min-width:28px;text-align:right" id="l-spatial-val">0%</span>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="ptitle">Sync Status</div>
      <div class="sbox" id="l-sync"><b>Status:</b> Waiting for host to load a track...</div>
      <div class="latency-row" id="l-latency" style="display:none">
        <div class="latency-item"><div class="latency-val" id="l-drift-val">â€”</div><div class="latency-lbl">Drift</div></div>
        <div class="latency-item"><div class="latency-val" id="l-offset-val">â€”</div><div class="latency-lbl">Clock Offset</div></div>
        <div class="latency-item"><div class="latency-val" id="l-rtt-val">â€”</div><div class="latency-lbl">Best RTT</div></div>
      </div>
    </div>

    <div class="panel">
      <div class="ptitle">Live Frequency Spectrum</div>
      <canvas id="l-viz"></canvas>
    </div>

    <div style="margin-top:12px"><button class="btn bg" onclick="leave()">â† Leave Room</button></div>
    <audio id="l-audio" crossorigin="anonymous" style="display:none" preload="auto"></audio>
  </div>
</div>
<div id="toast" class="toast"></div>
<script src="/socket.io/socket.io.js"></script>
<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const NTP_ROUNDS = 12;
const SCHED_MS   = 700;
const DRIFT_TOL  = 0.05;
const DRIFT_HARD = 0.35;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sock=null, roomCode=null, amHost=false;
let clockOffset=0, ntpSamples=[], ntpDone=false, bestRTT=0;
let pendingPlay=null, progRaf=null;
let listeners={};
let hCtx=null, hChain=null;
let lCtx=null, lChain=null;
let vizAn=null, vizRaf=null;
let currentTrack=null;
let currentEQ={h:'flat',l:'flat'};
let driftWatcher=null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI SPATIAL AUDIO PRESETS
// Dolby Atmos-style surround simulation via Web Audio API:
// 7-band parametric EQ + Convolution Reverb (impulse response)
// + Dynamic Compression + Stereo Enhancement
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PRESETS = {
  flat:   {sub:0,  bass:0,  lo:0,  mid:0,  hi:0,  pres:0,  air:0,  ratio:2,  thresh:-24, knee:8,  rev:0,    depth:0,  label:'Flat'},
  atmos:  {sub:4,  bass:3,  lo:-2, mid:1,  hi:5,  pres:6,  air:7,  ratio:4,  thresh:-18, knee:10, rev:0.18, depth:85, label:'Atmos 3D'},
  cinema: {sub:6,  bass:5,  lo:1,  mid:2,  hi:4,  pres:5,  air:5,  ratio:5,  thresh:-20, knee:12, rev:0.28, depth:95, label:'Cinema'},
  bass:   {sub:10, bass:8,  lo:3,  mid:-2, hi:1,  pres:2,  air:1,  ratio:6,  thresh:-22, knee:8,  rev:0.06, depth:20, label:'Bass+'},
  vocal:  {sub:-3, bass:-2, lo:1,  mid:5,  hi:4,  pres:3,  air:2,  ratio:3,  thresh:-16, knee:6,  rev:0.12, depth:30, label:'Vocal'},
};

const G=id=>document.getElementById(id);

function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('on'));G(id).classList.add('on');}

function toast(msg,dur=3500){
  const t=G('toast');t.textContent=msg;t.classList.add('on');
  clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('on'),dur);
}

function fmt(s){
  if(!s||isNaN(s)||!isFinite(s))return'0:00';
  return Math.floor(s/60)+':'+(('0'+Math.floor(s%60)).slice(-2));
}

function srvNow(){return Date.now()-clockOffset;}

function setConn(online){
  G('conn-dot').className='nav-dot'+(online?' online':'');
  G('conn-label').textContent=online?'Online':'Offline';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UNLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doUnlock(){
  G('unlock').classList.add('gone');
  [lCtx,hCtx].forEach(c=>{if(c)c.resume();});
  ['l-audio','h-audio'].forEach(id=>{const a=G(id);if(a&&a.src&&a.paused)a.play().catch(()=>{});});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name){
  ['youtube','url','file'].forEach(n=>{
    G('tab-'+n).classList.toggle('active',n===name);
    G('pane-'+n).classList.toggle('on',n===name);
  });
}

function setStatus(id,html){const el=G(id);if(el)el.innerHTML=html;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadYoutube(){
  const raw=G('yt-url').value.trim();
  if(!raw){toast('Paste a YouTube URL first');return;}
  const btn=G('yt-btn');
  btn.disabled=true;btn.textContent='...';
  setStatus('yt-status','<span class="spin">âŸ³</span> Fetching YouTube audio...');
  try{
    const res=await fetch('/yt-info?url='+encodeURIComponent(raw));
    const data=await res.json();
    if(!res.ok||data.error){setStatus('yt-status','âŒ '+(data.error||'Error'));btn.disabled=false;btn.textContent='Load';return;}
    setStatus('yt-status','âœ… '+data.title);
    applyTrack('/yt-stream?url='+encodeURIComponent(raw),data.title,raw);
  }catch(e){setStatus('yt-status','âŒ '+e.message);}
  btn.disabled=false;btn.textContent='Load';
}

function loadDirectUrl(){
  const raw=G('direct-url').value.trim();
  if(!raw){toast('Enter a URL');return;}
  setStatus('url-status','<span class="spin">âŸ³</span> Loading...');
  const title=decodeURIComponent(raw.split('/').pop().split('?')[0].replace(/\.[^.]+$/,'')||'Audio');
  applyTrack('/proxy?url='+encodeURIComponent(raw),title,raw);
}

function loadFile(){
  const f=G('file-input').files[0];if(!f)return;
  const url=URL.createObjectURL(f);
  const title=f.name.replace(/\.[^.]+$/,'');
  setStatus('file-status','âš ï¸ Local file â€” only plays on your device');
  applyTrack(url,title,null,true);
}

function applyTrack(streamUrl,title,originalUrl,isLocal=false){
  const a=G('h-audio');
  teardown('h');
  currentTrack={streamUrl,title,originalUrl,isLocal};
  a.src=streamUrl;a.load();
  G('h-tname').textContent=title;
  G('h-tsub').textContent='Loading audio...';
  G('h-player').style.display='block';
  G('h-play-btn').disabled=true;

  function onMeta(){
    a.removeEventListener('loadedmetadata',onMeta);
    G('h-dur').textContent=fmt(a.duration);
    G('h-tsub').textContent=fmt(a.duration)+(isLocal?' Â· local only':' Â· ready');
    G('h-play-btn').disabled=false;
    buildChain(a,'h');
    startProg(a,'h-fill','h-cur','h-dur');
    startViz('h-viz');
    toast('âœ… Track loaded â€” press Play â–¶');
    setStatus('yt-status','âœ… Ready â€” press Play!');
    setStatus('url-status','âœ… Ready â€” press Play!');
  }

  function onErr(){
    a.removeEventListener('error',onErr);
    const codes=['','ABORTED','NETWORK','DECODE','NOT_SUPPORTED'];
    const msg=a.error?(codes[a.error.code]||'ERR_'+a.error.code):'UNKNOWN';
    console.error('Audio error:',msg);
    setStatus('yt-status','âŒ Load failed: '+msg);
    setStatus('url-status','âŒ Load failed: '+msg);
    toast('âŒ Audio error: '+msg,5000);
    G('h-play-btn').disabled=false;
  }

  a.addEventListener('loadedmetadata',onMeta);
  a.addEventListener('error',onErr);

  // Seekbar drag
  const bar=G('h-seekbar');
  let dragging=false;
  function getR(e){
    const tr=bar.querySelector('.seek-track');
    const rc=tr.getBoundingClientRect();
    const x=(e.touches?e.touches[0].clientX:e.clientX)-rc.left;
    return Math.max(0,Math.min(1,x/rc.width));
  }
  function doSeek(e){
    if(!a.duration)return;
    const r=getR(e),pos=r*a.duration;
    a.currentTime=pos;
    G('h-fill').style.width=(r*100)+'%';
    const playing=!a.paused,playAt=srvNow()+SCHED_MS;
    if(playing)setTimeout(()=>a.play().catch(()=>{}),SCHED_MS);
    sock.emit('audio:seek',{position:pos,playing,serverPlayAt:playAt});
  }
  // Remove old listeners by cloning
  const newBar=bar.cloneNode(true);
  bar.parentNode.replaceChild(newBar,bar);
  newBar.addEventListener('mousedown',e=>{dragging=true;doSeek(e);});
  newBar.addEventListener('touchstart',e=>{dragging=true;doSeek(e);},{passive:true});
  document.addEventListener('mousemove',e=>{if(dragging)doSeek(e);});
  document.addEventListener('touchmove',e=>{if(dragging)doSeek(e);},{passive:true});
  document.addEventListener('mouseup',()=>dragging=false);
  document.addEventListener('touchend',()=>dragging=false);

  if(!isLocal&&sock)sock.emit('track:set',{streamUrl,title,originalUrl});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI SPATIAL AUDIO ENGINE
// Full signal chain:
// Src â†’ 7-band EQ â†’ Stereo Enhancer â†’ Convolution Reverb
//     â†’ Dynamics Compressor â†’ Master Gain â†’ Analyser â†’ Out
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildChain(audioEl,side){
  teardown(side);
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)({sampleRate:48000,latencyHint:'playback'});
    const src=ctx.createMediaElementSource(audioEl);

    // 7-band parametric EQ
    const f_sub=mkF(ctx,'lowshelf',40);
    const f_bass=mkF(ctx,'peaking',120,1.0);
    const f_lo=mkF(ctx,'peaking',400,0.9);
    const f_mid=mkF(ctx,'peaking',1200,0.9);
    const f_hi=mkF(ctx,'peaking',4000,1.0);
    const f_pres=mkF(ctx,'peaking',8000,1.1);
    const f_air=mkF(ctx,'highshelf',16000);

    // Stereo widener: all-pass phase trick
    const apL=mkF(ctx,'allpass',200,0.7);
    const apR=mkF(ctx,'allpass',200,0.7);

    // Convolution reverb (synthetic impulse response)
    const reverb=ctx.createConvolver();
    reverb.buffer=makeIR(ctx,2.5,3);
    const revGain=ctx.createGain();
    revGain.gain.value=0;
    const dryGain=ctx.createGain();
    dryGain.gain.value=1;

    // Dynamics compressor
    const comp=ctx.createDynamicsCompressor();
    comp.threshold.value=-24;comp.knee.value=8;comp.ratio.value=2;
    comp.attack.value=0.003;comp.release.value=0.15;

    // Master gain
    const master=ctx.createGain();master.gain.value=0.85;

    // Analyser
    const an=ctx.createAnalyser();
    an.fftSize=1024;an.smoothingTimeConstant=0.82;

    // Routing: EQ chain â†’ split to dry/wet â†’ comp â†’ master â†’ analyser â†’ out
    src.connect(f_sub);f_sub.connect(f_bass);f_bass.connect(f_lo);
    f_lo.connect(f_mid);f_mid.connect(f_hi);f_hi.connect(f_pres);f_pres.connect(f_air);
    f_air.connect(dryGain);
    f_air.connect(reverb);reverb.connect(revGain);
    dryGain.connect(comp);revGain.connect(comp);
    comp.connect(master);master.connect(an);an.connect(ctx.destination);

    const chain={sub:f_sub,bass:f_bass,lo:f_lo,mid:f_mid,hi:f_hi,pres:f_pres,air:f_air,
                 comp,revGain,dryGain,master,an};

    if(side==='h'){hCtx=ctx;hChain=chain;vizAn=an;}
    else{lCtx=ctx;lChain=chain;vizAn=an;}

    // Apply current preset
    applyPreset(PRESETS[currentEQ[side]||'flat'],chain);
    ctx.resume();
    return chain;
  }catch(e){console.warn('Chain build error:',e);return null;}
}

// Synthetic Impulse Response for convolution reverb
function makeIR(ctx,dur,decay){
  const len=Math.floor(ctx.sampleRate*dur);
  const buf=ctx.createBuffer(2,len,ctx.sampleRate);
  for(let ch=0;ch<2;ch++){
    const d=buf.getChannelData(ch);
    for(let i=0;i<len;i++){
      const t=i/ctx.sampleRate;
      const env=Math.pow(Math.max(0,1-t/dur),decay);
      d[i]=(Math.random()*2-1)*env*0.4;
      // Early reflections boost
      if(i<ctx.sampleRate*0.04)d[i]*=1.8;
    }
  }
  return buf;
}

function mkF(ctx,type,freq,q){
  const f=ctx.createBiquadFilter();
  f.type=type;f.frequency.value=freq;
  if(q!==undefined)f.Q.value=q;
  return f;
}

function teardown(side){
  if(side==='h'&&hCtx){hCtx.close().catch(()=>{});hCtx=null;hChain=null;}
  if(side==='l'&&lCtx){lCtx.close().catch(()=>{});lCtx=null;lChain=null;}
  if(vizRaf){cancelAnimationFrame(vizRaf);vizRaf=null;vizAn=null;}
}

function applyPreset(p,chain){
  if(!chain)return;
  chain.sub.gain.value=p.sub;chain.bass.gain.value=p.bass;
  chain.lo.gain.value=p.lo;chain.mid.gain.value=p.mid;
  chain.hi.gain.value=p.hi;chain.pres.gain.value=p.pres;
  chain.air.gain.value=p.air;
  chain.comp.ratio.value=p.ratio;
  chain.comp.threshold.value=p.thresh;
  chain.comp.knee.value=p.knee;
  chain.revGain.gain.value=p.rev;
  chain.dryGain.gain.value=1-(p.rev*0.5);
}

function setEQ(btn,side){
  const preset=btn.id.replace(/^[hl]eq-/,'');
  const p=PRESETS[preset];if(!p)return;
  const chain=side==='h'?hChain:lChain;
  applyPreset(p,chain);
  currentEQ[side]=preset;
  document.querySelectorAll('[id^="'+side+'eq-"]').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  const sf=G(side+'-spatial-fill');
  const sv=G(side+'-spatial-val');
  if(sf){sf.style.width=(p.depth||0)+'%';sv.textContent=(p.depth||0)+'%';}
  toast('âœ¦ '+p.label+' mode activated');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initSock(){
  if(sock&&sock.connected)return;
  sock=io({
    transports:['websocket','polling'],
    reconnectionAttempts:20,
    reconnectionDelay:1000,
    reconnectionDelayMax:5000,
    timeout:20000,
  });

  sock.on('connect',()=>{
    console.log('[WS] Connected:',sock.id);
    setConn(true);doNTP();
    clearInterval(window._ka);
    window._ka=setInterval(()=>{if(sock&&sock.connected)sock.emit('keepalive');},15000);
  });

  sock.on('disconnect',reason=>{
    console.warn('[WS] Disconnected:',reason);
    setConn(false);
    if(roomCode)toast('âš ï¸ Reconnecting...');
  });

  sock.on('reconnect',()=>{setConn(true);toast('âœ… Reconnected!');doNTP();});
  sock.on('connect_error',e=>{console.error('[WS] Error:',e.message);setConn(false);});

  sock.on('ntp:pong',({clientTime,serverTime})=>{
    const now=Date.now(),rtt=now-clientTime;
    ntpSamples.push({rtt,offset:now-(serverTime+rtt/2)});
    if(ntpSamples.length<NTP_ROUNDS)setTimeout(()=>sock.emit('ntp:ping',{clientTime:Date.now()}),40);
    else finishNTP();
  });

  // HOST events
  sock.on('room:listener_joined',({id})=>{
    listeners[id]={t:Date.now()};renderListeners();
    if(currentTrack&&!currentTrack.isLocal){
      sock.emit('track:set',{streamUrl:currentTrack.streamUrl,title:currentTrack.title,originalUrl:currentTrack.originalUrl});
      const a=G('h-audio');
      if(a.src){
        setTimeout(()=>{
          if(!a.paused)sock.emit('audio:play',{position:a.currentTime,serverPlayAt:srvNow()+SCHED_MS});
          else sock.emit('audio:pause',{position:a.currentTime});
        },900);
      }
    }
  });
  sock.on('room:listener_left',({id})=>{delete listeners[id];renderListeners();});
  sock.on('room:count',n=>G('h-lcnt').textContent=n);

  // LISTENER events
  sock.on('track:set',({streamUrl,title})=>loadListenerTrack(streamUrl,title));
  sock.on('audio:play',({position,serverPlayAt})=>schedPlay(position,serverPlayAt));
  sock.on('audio:pause',({position})=>{
    cancelSched();clearInterval(driftWatcher);
    const a=G('l-audio');if(!a.src)return;
    a.pause();
    if(Math.abs(a.currentTime-position)>0.5)a.currentTime=position;
    G('l-art').classList.remove('spin');
    setPill('l-pill','pw','dm','Paused by Host');
    setSyncInfo('Host paused playback.');
  });
  sock.on('audio:seek',({position,playing,serverPlayAt})=>{
    cancelSched();
    const a=G('l-audio');if(!a.src)return;
    a.currentTime=position;
    if(playing)schedPlay(position,serverPlayAt);
    else{a.pause();G('l-art').classList.remove('spin');}
  });
  sock.on('room:host_left',()=>{toast('ğŸšª Host ended the session');setTimeout(leave,1500);});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NTP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doNTP(){ntpSamples=[];ntpDone=false;sock.emit('ntp:ping',{clientTime:Date.now()});}

function finishNTP(){
  ntpSamples.sort((a,b)=>a.rtt-b.rtt);
  const best=ntpSamples.slice(0,Math.ceil(NTP_ROUNDS/3));
  clockOffset=best.reduce((s,x)=>s+x.offset,0)/best.length;
  bestRTT=ntpSamples[0].rtt;
  ntpDone=true;
  if(G('l-offset-val'))G('l-offset-val').textContent=Math.round(Math.abs(clockOffset))+'ms';
  if(G('l-rtt-val'))G('l-rtt-val').textContent=bestRTT+'ms';
  console.log('[NTP] offset='+clockOffset.toFixed(1)+'ms RTT='+bestRTT+'ms');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCHEDULED PLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function schedPlay(position,serverPlayAt){
  cancelSched();
  const a=G('l-audio');
  if(!a.src){setSyncInfo('âš ï¸ Track not loaded yet...');return;}

  const localPlayAt=serverPlayAt+clockOffset;
  const msLeft=localPlayAt-Date.now();

  function execute(){
    const late=Math.max(0,(Date.now()-localPlayAt))/1000;
    const target=Math.max(0,position+late);
    const drift=Math.abs(a.currentTime-target);
    if(drift>DRIFT_TOL)a.currentTime=target;

    a.play().then(()=>{
      G('l-art').classList.add('spin');
      setPill('l-pill','ps','dc','â— In Sync');
      setSyncInfo('ğŸ§ Playing in sync');
      G('unlock').classList.add('gone');
      G('l-latency').style.display='flex';
      if(G('l-drift-val'))G('l-drift-val').textContent=Math.round(drift*1000)+'ms';

      if(!lCtx){buildChain(a,'l');setTimeout(()=>startViz('l-viz'),200);}
      if(lCtx)lCtx.resume();
      startProg(a,'l-fill','l-cur','l-dur');
      startViz('l-viz');

      // Continuous drift correction
      clearInterval(driftWatcher);
      driftWatcher=setInterval(()=>{
        if(a.paused)return;
        const elapsed=(srvNow()-serverPlayAt)/1000;
        const exp=position+elapsed;
        const d=Math.abs(a.currentTime-exp);
        if(d>DRIFT_HARD){
          console.warn('[SYNC] Correcting hard drift:',d.toFixed(3)+'s');
          a.currentTime=exp;
        }
        if(G('l-drift-val'))G('l-drift-val').textContent=Math.round(d*1000)+'ms';
      },3000);
    }).catch(()=>{
      G('unlock').classList.remove('gone');
      G('unlock').onclick=()=>{
        doUnlock();
        a.play().then(()=>{
          G('l-art').classList.add('spin');
          setPill('l-pill','ps','dc','â— In Sync');
          if(!lCtx){buildChain(a,'l');}
          if(lCtx)lCtx.resume();
          startViz('l-viz');
          startProg(a,'l-fill','l-cur','l-dur');
        });
      };
    });
  }

  if(msLeft>20){
    a.currentTime=Math.max(0,position);
    setPill('l-pill','pw','dm','Buffering...');
    setSyncInfo('âŸ³ Syncing...');
    pendingPlay=setTimeout(execute,msLeft);
  }else{
    a.currentTime=Math.max(0,position+Math.max(0,-msLeft/1000));
    execute();
  }
}

function cancelSched(){if(pendingPlay){clearTimeout(pendingPlay);pendingPlay=null;}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CREATE / JOIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createRoom(){
  const name=G('rname-input').value.trim()||'Audio Room';
  initSock();amHost=true;
  function go(){
    sock.emit('room:create',{name},res=>{
      if(!res||!res.ok){toast('âŒ Could not create room');return;}
      roomCode=res.code;
      G('h-rname').textContent=res.name;
      G('h-code').textContent=res.code;
      show('s-host');
      toast('ğŸ‰ Room created! Share: '+res.code);
    });
  }
  if(sock.connected)go();else{toast('Connecting...');sock.once('connect',()=>setTimeout(go,300));}
}

function joinRoom(){
  const code=G('join-code').value.trim().toUpperCase();
  if(code.length<6){toast('Enter the full 6-letter code');return;}
  G('join-err').classList.remove('on');
  initSock();amHost=false;
  function go(){
    sock.emit('room:join',{code},res=>{
      if(!res||!res.ok){G('join-err').classList.add('on');return;}
      roomCode=code;
      G('l-rname').textContent=res.name;
      G('l-clabel').textContent='Room: '+code;
      show('s-listen');
      toast('ğŸ§ Joined! Syncing...');
      if(res.track&&res.track.streamUrl){
        loadListenerTrack(res.track.streamUrl,res.track.title,()=>{
          if(res.state&&res.state.playing&&res.state.serverPlayAt){
            const elapsed=(srvNow()-res.state.serverPlayAt)/1000;
            schedPlay(Math.max(0,(res.state.position||0)+elapsed),srvNow()+SCHED_MS);
          }else if(res.state){
            G('l-audio').currentTime=res.state.position||0;
            setSyncInfo('Track loaded. Waiting for host to play.');
          }
        });
      }
    });
  }
  if(sock.connected)go();else{toast('Connecting...');sock.once('connect',()=>setTimeout(go,400));}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LISTENER TRACK LOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadListenerTrack(url,title,cb){
  const a=G('l-audio');
  teardown('l');
  a.src=url;a.load();
  G('l-tname').textContent=title||'Loading...';
  setSyncInfo('<span class="spin">âŸ³</span> Loading track...');
  setPill('l-pill','pw','dm','Loading...');

  function onReady(){
    a.removeEventListener('canplay',onReady);
    if(a.duration)G('l-dur').textContent=fmt(a.duration);
    setSyncInfo('âœ… Ready â€” waiting for host...');
    buildChain(a,'l');
    if(cb)cb();
  }
  function onErr(){
    a.removeEventListener('error',onErr);
    const c=a.error?a.error.code:0;
    const msgs=['','Aborted','Network error','Decode error','Not supported'];
    setSyncInfo('âŒ '+(msgs[c]||'Load failed'));
    toast('âŒ Track load failed',4000);
  }
  a.addEventListener('canplay',onReady);
  a.addEventListener('error',onErr);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOST CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hostPlay(){
  const a=G('h-audio');
  if(!a.src){toast('Load a track first');return;}
  if(hCtx)hCtx.resume();
  const pos=a.currentTime,playAt=srvNow()+SCHED_MS;
  setTimeout(()=>{a.play().catch(e=>console.warn(e));G('h-art').classList.add('spin');},SCHED_MS);
  setPill('h-pill','pl','dg','â— Playing');
  sock.emit('audio:play',{position:pos,serverPlayAt:playAt});
  startViz('h-viz');
}

function hostPause(){
  const a=G('h-audio');
  a.pause();G('h-art').classList.remove('spin');
  setPill('h-pill','pw','dm','Paused');
  sock.emit('audio:pause',{position:a.currentTime});
}

function hostRestart(){
  const a=G('h-audio');if(!a.src)return;
  if(hCtx)hCtx.resume();
  a.currentTime=0;
  const playAt=srvNow()+SCHED_MS;
  setTimeout(()=>{a.play().catch(()=>{});G('h-art').classList.add('spin');},SCHED_MS);
  setPill('h-pill','pl','dg','â— Playing');
  sock.emit('audio:play',{position:0,serverPlayAt:playAt});
}

function hostVolChange(v){
  const val=parseFloat(v);
  G('h-audio').volume=val;
  if(hChain)hChain.master.gain.value=val;
  G('h-vol-val').textContent=Math.round(val*100)+'%';
}

function listVolChange(v){
  const val=parseFloat(v);
  G('l-audio').volume=val;
  if(lChain)lChain.master.gain.value=val;
  G('l-vol-val').textContent=Math.round(val*100)+'%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function leave(){
  cancelSched();clearInterval(window._ka);clearInterval(driftWatcher);
  if(progRaf){cancelAnimationFrame(progRaf);progRaf=null;}
  if(vizRaf){cancelAnimationFrame(vizRaf);vizRaf=null;}
  ['h-audio','l-audio'].forEach(id=>{const a=G(id);if(a){a.pause();a.src='';a.load();}});
  teardown('h');teardown('l');
  if(sock){sock.disconnect();sock=null;}
  roomCode=null;listeners={};currentTrack=null;
  setConn(false);show('s-home');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyCode(){
  const code=G('h-code').textContent;
  if(navigator.clipboard){navigator.clipboard.writeText(code).then(()=>toast('ğŸ“‹ Copied: '+code));}
  else{const el=document.createElement('input');el.value=code;document.body.appendChild(el);el.select();document.execCommand('copy');document.body.removeChild(el);toast('ğŸ“‹ Copied: '+code);}
}

function setSyncInfo(html){G('l-sync').innerHTML='<b>Status:</b> '+html;}

function setPill(id,cls,dot,lbl){
  const el=G(id);if(!el)return;
  el.className='pill '+cls;
  el.innerHTML='<div class="dot '+dot+'"></div><span>'+lbl+'</span>';
}

function renderListeners(){
  const ids=Object.keys(listeners);
  G('h-lcnt').textContent=ids.length;
  const el=G('h-llist');
  if(!ids.length){el.innerHTML='<div class="nol">No one joined yet â€” share your code!</div>';return;}
  el.innerHTML=ids.map((id,i)=>
    '<div class="litem"><div class="lav">ğŸ§</div><span>Listener '+(i+1)+'</span>'+
    '<span style="margin-left:auto;font-family:\'Space Mono\',monospace;font-size:9px;color:var(--g)">â— synced</span></div>'
  ).join('');
}

function startProg(audio,fillId,curId,durId){
  if(progRaf){cancelAnimationFrame(progRaf);progRaf=null;}
  function tick(){
    progRaf=requestAnimationFrame(tick);
    const p=audio.duration?(audio.currentTime/audio.duration*100):0;
    const f=G(fillId);if(f)f.style.width=p+'%';
    if(G(curId))G(curId).textContent=fmt(audio.currentTime);
    if(G(durId)&&audio.duration)G(durId).textContent=fmt(audio.duration);
  }
  tick();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISUALIZER (frequency spectrum + peak hold)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startViz(canvasId){
  if(vizRaf){cancelAnimationFrame(vizRaf);vizRaf=null;}
  if(!vizAn)return;
  const cv=G(canvasId);if(!cv)return;
  const dpr=window.devicePixelRatio||1;
  const W=cv.offsetWidth||760,H=cv.offsetHeight||62;
  cv.width=W*dpr;cv.height=H*dpr;
  const ctx=cv.getContext('2d');ctx.scale(dpr,dpr);
  const bins=vizAn.frequencyBinCount;
  const buf=new Uint8Array(bins);
  const peaks=new Float32Array(bins);
  const peakDecay=0.984;
  const bw=(W/bins)*2.2;

  function draw(){
    vizRaf=requestAnimationFrame(draw);
    vizAn.getByteFrequencyData(buf);
    ctx.fillStyle='#06070c';ctx.fillRect(0,0,W,H);
    let x=0;
    for(let i=0;i<bins;i++){
      const r=buf[i]/255;
      const h=r*H*0.9;
      if(r>peaks[i])peaks[i]=r;else peaks[i]*=peakDecay;
      const hue=175+i/bins*100;
      const alpha=0.65+r*0.35;
      ctx.fillStyle='hsla('+hue+',90%,60%,'+alpha+')';
      ctx.fillRect(x,H-h,bw,h);
      // Peak hold line
      if(peaks[i]>0.05){
        ctx.fillStyle='hsla('+hue+',100%,85%,0.75)';
        ctx.fillRect(x,H-peaks[i]*H*0.9-1,bw,1.5);
      }
      // Glow on loud bins
      if(r>0.7){
        ctx.fillStyle='hsla('+hue+',100%,70%,0.15)';
        ctx.fillRect(x,H-h-3,bw,3);
      }
      x+=bw+0.5;
    }
  }
  draw();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT FORMATTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
G('join-code').addEventListener('input',function(){
  this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'');
});

// Init socket on load for faster connection
window.addEventListener('load',()=>{
  initSock();
  // Handle Enter key in join form
  G('join-code').addEventListener('keydown',e=>{if(e.key==='Enter')joinRoom();});
  G('rname-input').addEventListener('keydown',e=>{if(e.key==='Enter')createRoom();});
});
</script>
</body>
</html>
