<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WaveRoom ‚Äî Lag-Free Audio Sync</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #07080d; --surface: #0e1018; --border: #1c2030;
  --accent: #00e5ff; --purple: #8b5cf6; --green: #00ff88;
  --red: #ff4466; --text: #e2e8f0; --muted: #4a5578;
}
body { background: var(--bg); color: var(--text); font-family: 'Syne', sans-serif; min-height: 100vh; }
body::before {
  content: ''; position: fixed; inset: 0;
  background-image: linear-gradient(var(--border) 1px, transparent 1px), linear-gradient(90deg, var(--border) 1px, transparent 1px);
  background-size: 50px 50px; opacity: 0.2; pointer-events: none;
}
.wrap { position: relative; z-index: 1; max-width: 820px; margin: 0 auto; padding: 32px 20px; }
.logo { display: flex; align-items: center; gap: 10px; margin-bottom: 52px; }
.logo-icon { width: 38px; height: 38px; border-radius: 10px; background: linear-gradient(135deg, var(--accent), var(--purple)); display: flex; align-items: center; justify-content: center; font-size: 20px; }
.logo-name { font-size: 22px; font-weight: 800; background: linear-gradient(135deg, var(--accent), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.screen { display: none; }
.screen.active { display: block; animation: up 0.25s ease; }
@keyframes up { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
.hero { text-align: center; padding: 20px 0 40px; }
.hero h1 { font-size: clamp(36px, 6vw, 68px); font-weight: 800; letter-spacing: -2px; line-height: 1.05; margin-bottom: 16px; }
.hero h1 em { font-style: normal; background: linear-gradient(135deg, var(--accent), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.hero p { font-family: 'Space Mono', monospace; font-size: 14px; color: var(--muted); max-width: 400px; margin: 0 auto 40px; line-height: 1.75; }
.two { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; max-width: 560px; margin: 0 auto; }
@media(max-width:480px){ .two { grid-template-columns: 1fr; } }
.card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 26px 20px; text-align: left; cursor: pointer; transition: border-color 0.2s, transform 0.2s; }
.card:hover { border-color: rgba(0,229,255,0.35); transform: translateY(-3px); }
.card-icon { font-size: 26px; margin-bottom: 12px; }
.card-title { font-size: 17px; font-weight: 700; margin-bottom: 5px; }
.card-desc { font-size: 12px; color: var(--muted); font-family: 'Space Mono', monospace; line-height: 1.6; }
.how { max-width: 560px; margin: 28px auto 0; background: rgba(0,229,255,0.04); border: 1px solid rgba(0,229,255,0.1); border-radius: 14px; padding: 20px 24px; }
.how-title { font-size: 11px; text-transform: uppercase; letter-spacing: 1.2px; color: var(--accent); font-family: 'Space Mono', monospace; margin-bottom: 12px; }
.how p { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--muted); line-height: 1.9; }
.how strong { color: var(--text); }
.form-box { max-width: 440px; margin: 0 auto; }
.back { background: none; border: none; color: var(--muted); font-family: 'Space Mono', monospace; font-size: 13px; cursor: pointer; margin-bottom: 32px; padding: 0; transition: color 0.2s; }
.back:hover { color: var(--accent); }
.ftitle { font-size: 32px; font-weight: 800; letter-spacing: -1px; margin-bottom: 6px; }
.fsub { font-family: 'Space Mono', monospace; font-size: 13px; color: var(--muted); margin-bottom: 26px; line-height: 1.7; }
label { display: block; font-size: 11px; font-weight: 700; letter-spacing: 1.2px; text-transform: uppercase; color: var(--muted); margin-bottom: 7px; }
input[type="text"] { width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 13px 15px; color: var(--text); font-family: 'Space Mono', monospace; font-size: 15px; outline: none; transition: border-color 0.2s; margin-bottom: 18px; }
input[type="text"]:focus { border-color: var(--accent); }
input[type="text"]::placeholder { color: var(--muted); }
#code-input { letter-spacing: 5px; font-size: 20px; text-transform: uppercase; }
.upload-zone { width: 100%; border: 2px dashed var(--border); border-radius: 12px; padding: 32px 20px; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 18px; background: var(--surface); }
.upload-zone:hover, .upload-zone.drag { border-color: var(--accent); background: rgba(0,229,255,0.04); }
.upload-zone .uz-icon { font-size: 32px; margin-bottom: 10px; }
.upload-zone .uz-text { font-family: 'Space Mono', monospace; font-size: 13px; color: var(--muted); line-height: 1.7; }
.upload-zone .uz-text strong { color: var(--accent); }
.upload-zone input { display: none; }
.file-chosen { background: rgba(0,255,136,0.06); border: 1px solid rgba(0,255,136,0.2); border-radius: 10px; padding: 12px 16px; font-family: 'Space Mono', monospace; font-size: 13px; color: var(--green); margin-bottom: 18px; display: none; word-break: break-all; }
.file-chosen.show { display: block; }
.btn { width: 100%; padding: 13px; border-radius: 10px; font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700; cursor: pointer; border: none; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
.btn-cyan { background: linear-gradient(135deg, var(--accent), #0099bb); color: #000; }
.btn-cyan:hover { box-shadow: 0 8px 24px rgba(0,229,255,0.3); transform: translateY(-1px); }
.btn-purple { background: linear-gradient(135deg, var(--purple), #6d28d9); color: #fff; }
.btn-purple:hover { box-shadow: 0 8px 24px rgba(139,92,246,0.35); transform: translateY(-1px); }
.btn-ghost { background: var(--surface); border: 1px solid var(--border); color: var(--text); }
.btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
.btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
.err { background: rgba(255,68,102,0.1); border: 1px solid rgba(255,68,102,0.3); border-radius: 8px; padding: 11px 15px; font-family: 'Space Mono', monospace; font-size: 13px; color: var(--red); margin-bottom: 16px; display: none; }
.err.show { display: block; }
.room-top { display: flex; align-items: flex-start; justify-content: space-between; flex-wrap: wrap; gap: 12px; margin-bottom: 24px; }
.rname { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
.rcode { display: inline-flex; align-items: center; gap: 8px; margin-top: 6px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 7px 13px; font-family: 'Space Mono', monospace; font-size: 20px; font-weight: 700; letter-spacing: 4px; color: var(--accent); cursor: pointer; transition: border-color 0.2s; }
.rcode:hover { border-color: var(--accent); }
.rcode small { font-size: 11px; color: var(--muted); letter-spacing: 0; }
.pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 100px; font-family: 'Space Mono', monospace; font-size: 12px; font-weight: 700; }
.pill-live { background: rgba(0,255,136,0.1); color: var(--green); border: 1px solid rgba(0,255,136,0.25); }
.pill-wait { background: rgba(74,85,120,0.15); color: var(--muted); border: 1px solid var(--border); }
.pill-sync { background: rgba(0,229,255,0.1); color: var(--accent); border: 1px solid rgba(0,229,255,0.2); }
.dot { width: 7px; height: 7px; border-radius: 50%; }
.dot-g { background: var(--green); animation: blink 1.4s infinite; }
.dot-m { background: var(--muted); }
.dot-c { background: var(--accent); animation: blink 1.4s infinite; }
@keyframes blink { 0%,100%{opacity:1}50%{opacity:0.35} }
.panel { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 20px; margin-bottom: 14px; }
.panel-title { font-size: 11px; text-transform: uppercase; letter-spacing: 1.2px; color: var(--muted); font-family: 'Space Mono', monospace; margin-bottom: 14px; }
.track-info { display: flex; align-items: center; gap: 12px; margin-bottom: 18px; }
.track-icon { width: 44px; height: 44px; border-radius: 10px; background: linear-gradient(135deg, var(--purple), var(--accent)); display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
.track-name { font-size: 15px; font-weight: 700; word-break: break-all; }
.track-sub { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--muted); margin-top: 3px; }
.progress-wrap { margin-bottom: 10px; cursor: pointer; }
.progress-bar { width: 100%; height: 5px; background: var(--border); border-radius: 10px; overflow: hidden; }
.progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--purple)); border-radius: 10px; width: 0%; transition: width 0.3s linear; }
.time-row { display: flex; justify-content: space-between; font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); margin-top: 6px; }
.play-row { display: flex; gap: 10px; margin-top: 14px; }
.play-row .btn { width: auto; flex: 1; padding: 11px; }
.vol-row { display: flex; align-items: center; gap: 10px; margin-top: 14px; }
.vol-label { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--muted); white-space: nowrap; }
input[type="range"] { flex: 1; accent-color: var(--accent); cursor: pointer; }
.sync-box { background: rgba(0,229,255,0.04); border: 1px solid rgba(0,229,255,0.12); border-radius: 10px; padding: 12px 16px; font-family: 'Space Mono', monospace; font-size: 12px; color: var(--muted); line-height: 1.8; }
.sync-box strong { color: var(--accent); }
.lcount { color: var(--accent); }
.no-l { font-family: 'Space Mono', monospace; font-size: 13px; color: var(--muted); text-align: center; padding: 16px 0; }
.litem { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); font-family: 'Space Mono', monospace; font-size: 13px; }
.litem:last-child { border: none; }
.lavatar { width: 30px; height: 30px; border-radius: 7px; background: linear-gradient(135deg, var(--purple), var(--accent)); display: flex; align-items: center; justify-content: center; font-size: 13px; flex-shrink: 0; }
canvas { width: 100%; height: 60px; display: block; border-radius: 6px; background: var(--bg); }
.toast { position: fixed; bottom: 26px; left: 50%; transform: translateX(-50%) translateY(80px); background: #1a1f2e; border: 1px solid var(--border); border-radius: 10px; padding: 11px 20px; font-family: 'Space Mono', monospace; font-size: 13px; z-index: 999; transition: transform 0.3s ease; white-space: nowrap; }
.toast.show { transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>
<div class="wrap">
  <div class="logo">
    <div class="logo-icon">üåä</div>
    <div class="logo-name">WaveRoom</div>
  </div>

  <!-- HOME -->
  <div id="s-home" class="screen active">
    <div class="hero">
      <h1>Zero-Lag Audio<br><em>Sync</em> For Everyone</h1>
      <p>Upload a song. Create a room. Everyone hears the exact same moment ‚Äî perfectly in sync.</p>
      <div class="two">
        <div class="card" onclick="go('s-create')">
          <div class="card-icon">üéô</div>
          <div class="card-title">Host a Room</div>
          <div class="card-desc">Upload audio, control playback for everyone.</div>
        </div>
        <div class="card" onclick="go('s-join')">
          <div class="card-icon">üéß</div>
          <div class="card-title">Join a Room</div>
          <div class="card-desc">Enter code, upload same file, sync instantly.</div>
        </div>
      </div>
      <div class="how">
        <div class="how-title">How zero-lag sync works</div>
        <p>
          <strong>Host</strong> uploads an MP3/WAV and presses play<br>
          <strong>Listeners</strong> upload the exact same file on their device<br>
          <strong>Server</strong> sends precise playback position + timestamp<br>
          <strong>Result:</strong> All devices jump to same exact moment = <strong>no lag üéØ</strong>
        </p>
      </div>
    </div>
  </div>

  <!-- CREATE -->
  <div id="s-create" class="screen">
    <div class="form-box">
      <button class="back" onclick="go('s-home')">‚Üê Back</button>
      <div class="ftitle">Host a Room</div>
      <div class="fsub">Upload your audio file. Share the room code. Everyone syncs to your playback.</div>
      <label>Room Name</label>
      <input type="text" id="rname" placeholder="Friday Night Session" maxlength="40">
      <label>Audio File</label>
      <div class="upload-zone" onclick="document.getElementById('host-file').click()">
        <div class="uz-icon">üéµ</div>
        <div class="uz-text">Click to select your audio file<br><strong>MP3, WAV, OGG, FLAC supported</strong></div>
        <input type="file" id="host-file" accept="audio/*" onchange="fileChosen('host-file','host-chosen')">
      </div>
      <div class="file-chosen" id="host-chosen"></div>
      <button class="btn btn-cyan" onclick="createRoom()">Create Room ‚Üí</button>
    </div>
  </div>

  <!-- JOIN -->
  <div id="s-join" class="screen">
    <div class="form-box">
      <button class="back" onclick="go('s-home')">‚Üê Back</button>
      <div class="ftitle">Join a Room</div>
      <div class="fsub">Enter the code, then upload the <strong>same audio file</strong> as the host.</div>
      <label>Room Code</label>
      <input type="text" id="code-input" placeholder="ABC123" maxlength="6">
      <label>Same Audio File as Host</label>
      <div class="upload-zone" onclick="document.getElementById('join-file').click()">
        <div class="uz-icon">üéµ</div>
        <div class="uz-text">Upload the <strong>same file</strong> as the host<br>MP3, WAV, OGG, FLAC</div>
        <input type="file" id="join-file" accept="audio/*" onchange="fileChosen('join-file','join-chosen')">
      </div>
      <div class="file-chosen" id="join-chosen"></div>
      <div id="join-err" class="err">Room not found. Check the code and try again.</div>
      <button class="btn btn-purple" onclick="joinRoom()">Join Room ‚Üí</button>
    </div>
  </div>

  <!-- HOST ROOM -->
  <div id="s-host" class="screen">
    <div class="room-top">
      <div>
        <div class="rname" id="h-rname">Room</div>
        <div class="rcode" onclick="copyCode()">
          <span id="h-code-text">------</span>
          <small>copy</small>
        </div>
      </div>
      <div id="h-pill" class="pill pill-wait"><div class="dot dot-m"></div><span>Paused</span></div>
    </div>

    <div class="panel">
      <div class="track-info">
        <div class="track-icon">üéµ</div>
        <div>
          <div class="track-name" id="h-track-name">Loading...</div>
          <div class="track-sub" id="h-track-dur">--:--</div>
        </div>
      </div>
      <div class="progress-wrap" onclick="hostSeek(event)">
        <div class="progress-bar"><div class="progress-fill" id="h-progress"></div></div>
        <div class="time-row"><span id="h-cur">0:00</span><span id="h-dur">0:00</span></div>
      </div>
      <div class="play-row">
        <button class="btn btn-cyan" onclick="hostPlay()">‚ñ∂ Play</button>
        <button class="btn btn-ghost" onclick="hostPause()">‚è∏ Pause</button>
        <button class="btn btn-ghost" onclick="hostRestart()">‚èÆ Restart</button>
      </div>
      <div class="vol-row">
        <span class="vol-label">üîä Vol</span>
        <input type="range" min="0" max="1" step="0.01" value="1" oninput="setVol(this.value,'h-audio')">
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">Visualizer</div>
      <canvas id="h-canvas"></canvas>
    </div>

    <div class="panel">
      <div class="panel-title" style="display:flex;justify-content:space-between;">
        <span>Listeners</span><span class="lcount" id="h-lcount">0</span>
      </div>
      <div id="h-llist"><div class="no-l">No one joined yet ‚Äî share your code!</div></div>
    </div>

    <div style="margin-top:12px;">
      <button class="btn btn-ghost" onclick="leave()">Leave Room</button>
    </div>
    <audio id="h-audio" style="display:none"></audio>
  </div>

  <!-- LISTENER ROOM -->
  <div id="s-listener" class="screen">
    <div class="room-top">
      <div>
        <div class="rname" id="l-rname">Room</div>
        <div style="font-family:'Space Mono',monospace;font-size:13px;color:var(--muted);margin-top:5px;" id="l-code-label"></div>
      </div>
      <div id="l-pill" class="pill pill-wait"><div class="dot dot-m"></div><span>Waiting...</span></div>
    </div>

    <div class="panel">
      <div class="track-info">
        <div class="track-icon">üéµ</div>
        <div>
          <div class="track-name" id="l-track-name">Waiting for host...</div>
          <div class="track-sub">Sync will happen automatically when host plays</div>
        </div>
      </div>
      <div class="progress-wrap">
        <div class="progress-bar"><div class="progress-fill" id="l-progress"></div></div>
        <div class="time-row"><span id="l-cur">0:00</span><span id="l-dur">0:00</span></div>
      </div>
      <div class="vol-row" style="margin-top:14px;">
        <span class="vol-label">üîä Vol</span>
        <input type="range" min="0" max="1" step="0.01" value="1" oninput="setVol(this.value,'l-audio')">
      </div>
    </div>

    <div class="panel">
      <div class="sync-box" id="l-sync-info">
        <strong>Sync Status:</strong> Waiting for host to play...<br>
        Your audio will jump to the exact same position automatically.
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">Visualizer</div>
      <canvas id="l-canvas"></canvas>
    </div>

    <div style="margin-top:12px;">
      <button class="btn btn-ghost" onclick="leave()">Leave Room</button>
    </div>
    <audio id="l-audio" style="display:none"></audio>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
let socket = null, myCode = null, amHost = false;
let audioCtx = null, analyser = null, raf = null;
let listeners = {};
let clockOffset = 0, syncSamples = [], syncDone = false;
let vizConnected = false;

function go(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function fileChosen(inputId, chosenId) {
  const f = document.getElementById(inputId).files[0];
  if (!f) return;
  const el = document.getElementById(chosenId);
  el.textContent = '‚úÖ ' + f.name;
  el.classList.add('show');
}

function initSocket() {
  if (socket && socket.connected) return;
  socket = io({ transports: ['websocket', 'polling'] });

  socket.on('connect', () => {
    console.log('Connected:', socket.id);
    if (!amHost) startClockSync();
  });

  socket.on('connect_error', () => toast('Connection error ‚Äî refresh'));

  socket.on('pong-time', ({ serverTime, clientSendTime }) => {
    const now = Date.now();
    const rtt = now - clientSendTime;
    const offset = (now + clientSendTime) / 2 - serverTime;
    syncSamples.push({ rtt, offset });
    if (syncSamples.length < 6) {
      setTimeout(() => socket.emit('ping-time', { clientTime: Date.now() }), 80);
    } else {
      syncSamples.sort((a, b) => a.rtt - b.rtt);
      clockOffset = syncSamples[0].offset;
      syncDone = true;
      console.log('Clock sync done. Offset:', clockOffset.toFixed(1), 'ms');
    }
  });

  socket.on('listener-joined', ({ id }) => {
    listeners[id] = true;
    renderListeners();
    const audio = document.getElementById('h-audio');
    if (audio && audio.src) {
      socket.emit('sync-state', {
        playing: !audio.paused,
        currentTime: audio.currentTime,
        serverNow: Date.now()
      });
    }
  });

  socket.on('listener-left', ({ id }) => { delete listeners[id]; renderListeners(); });
  socket.on('listener-count', (n) => { document.getElementById('h-lcount').textContent = n; });

  socket.on('play-cmd', ({ currentTime, serverTime }) => {
    syncAndPlay(currentTime, serverTime);
  });

  socket.on('pause-cmd', ({ currentTime }) => {
    const audio = document.getElementById('l-audio');
    if (!audio.src) return;
    audio.currentTime = currentTime;
    audio.pause();
    setPill('l-pill', 'wait', 'Paused');
    updateSyncInfo('Host paused. Ready to resync when they play.');
  });

  socket.on('seek-cmd', ({ currentTime, playing, serverTime }) => {
    const audio = document.getElementById('l-audio');
    if (!audio.src) return;
    if (playing) syncAndPlay(currentTime, serverTime);
    else { audio.currentTime = currentTime; audio.pause(); }
  });

  socket.on('sync-state', ({ playing, currentTime, serverNow }) => {
    const audio = document.getElementById('l-audio');
    if (!audio.src) {
      updateSyncInfo('‚ö†Ô∏è Please upload the same audio file as the host!');
      return;
    }
    if (playing) syncAndPlay(currentTime, serverNow);
    else { audio.currentTime = currentTime; audio.pause(); }
  });

  socket.on('host-left', () => { toast('Host ended the session'); leave(); });
}

function startClockSync() {
  syncSamples = []; syncDone = false;
  socket.emit('ping-time', { clientTime: Date.now() });
}

function syncAndPlay(hostCurrentTime, serverTimestamp) {
  const audio = document.getElementById('l-audio');
  if (!audio.src) return;
  const elapsed = (Date.now() - clockOffset - serverTimestamp) / 1000;
  const targetTime = hostCurrentTime + elapsed;
  const diff = Math.abs(audio.currentTime - targetTime);
  if (diff > 0.05) audio.currentTime = Math.max(0, targetTime);

  audio.play().then(() => {
    setPill('l-pill', 'sync', '‚óè In Sync');
    updateSyncInfo('‚úÖ Synced! Drift corrected: <strong>' + (diff * 1000).toFixed(0) + 'ms</strong>');
    if (!vizConnected) { startViz(audio, 'l-canvas'); vizConnected = true; }
    updateListenerProgress();
  }).catch(() => {
    updateSyncInfo('‚ö†Ô∏è Tap anywhere on screen to start audio (browser rule)');
    document.addEventListener('click', () => { audio.play(); setPill('l-pill','sync','‚óè In Sync'); }, { once: true });
  });
}

function createRoom() {
  const name = document.getElementById('rname').value.trim() || 'Audio Room';
  const file = document.getElementById('host-file').files[0];
  if (!file) { toast('Please select an audio file first'); return; }
  initSocket();
  amHost = true;
  socket.emit('create-room', { name }, (res) => {
    if (!res || !res.ok) { toast('Failed to create room'); return; }
    myCode = res.code;
    document.getElementById('h-rname').textContent = res.name;
    document.getElementById('h-code-text').textContent = res.code;
    const audio = document.getElementById('h-audio');
    audio.src = URL.createObjectURL(file);
    audio.load();
    audio.addEventListener('loadedmetadata', () => {
      document.getElementById('h-track-name').textContent = file.name.replace(/\.[^/.]+$/, '');
      document.getElementById('h-track-dur').textContent = fmtTime(audio.duration);
      document.getElementById('h-dur').textContent = fmtTime(audio.duration);
      updateHostProgress();
    }, { once: true });
    go('s-host');
    toast('Room created! Code: ' + res.code + ' üéâ');
  });
}

function joinRoom() {
  const code = document.getElementById('code-input').value.trim().toUpperCase();
  const file = document.getElementById('join-file').files[0];
  if (!code) { toast('Enter a room code'); return; }
  if (!file) { toast('Upload the same audio file as the host'); return; }
  initSocket();
  amHost = false;
  socket.emit('join-room', { code }, (res) => {
    if (!res || !res.ok) { document.getElementById('join-err').classList.add('show'); return; }
    document.getElementById('join-err').classList.remove('show');
    myCode = code;
    document.getElementById('l-rname').textContent = res.name;
    document.getElementById('l-code-label').textContent = 'Code: ' + code;
    const audio = document.getElementById('l-audio');
    audio.src = URL.createObjectURL(file);
    audio.load();
    audio.addEventListener('loadedmetadata', () => {
      document.getElementById('l-track-name').textContent = file.name.replace(/\.[^/.]+$/, '');
      document.getElementById('l-dur').textContent = fmtTime(audio.duration);
      updateListenerProgress();
    }, { once: true });
    go('s-listener');
    toast('Joined! Waiting for host to play üéß');
  });
}

function hostPlay() {
  const audio = document.getElementById('h-audio');
  if (!audio.src) return;
  audio.play();
  socket.emit('play-cmd', { currentTime: audio.currentTime, serverTime: Date.now() });
  setPill('h-pill', 'live', 'Playing');
  if (!vizConnected) { startViz(audio, 'h-canvas'); vizConnected = true; }
}

function hostPause() {
  const audio = document.getElementById('h-audio');
  audio.pause();
  socket.emit('pause-cmd', { currentTime: audio.currentTime });
  setPill('h-pill', 'wait', 'Paused');
}

function hostRestart() {
  const audio = document.getElementById('h-audio');
  audio.currentTime = 0;
  audio.play();
  socket.emit('play-cmd', { currentTime: 0, serverTime: Date.now() });
  setPill('h-pill', 'live', 'Playing');
}

function hostSeek(e) {
  const audio = document.getElementById('h-audio');
  if (!audio.duration) return;
  const bar = e.currentTarget.querySelector('.progress-bar');
  const rect = bar.getBoundingClientRect();
  const ratio = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
  audio.currentTime = ratio * audio.duration;
  const playing = !audio.paused;
  socket.emit('seek-cmd', { currentTime: audio.currentTime, playing, serverTime: Date.now() });
}

function updateHostProgress() {
  const audio = document.getElementById('h-audio');
  if (!audio) return;
  const pct = audio.duration ? (audio.currentTime / audio.duration * 100) : 0;
  document.getElementById('h-progress').style.width = pct + '%';
  document.getElementById('h-cur').textContent = fmtTime(audio.currentTime);
  requestAnimationFrame(updateHostProgress);
}

function updateListenerProgress() {
  const audio = document.getElementById('l-audio');
  if (!audio) return;
  const pct = audio.duration ? (audio.currentTime / audio.duration * 100) : 0;
  document.getElementById('l-progress').style.width = pct + '%';
  document.getElementById('l-cur').textContent = fmtTime(audio.currentTime);
  requestAnimationFrame(updateListenerProgress);
}

function leave() {
  stopViz(); vizConnected = false;
  ['h-audio','l-audio'].forEach(id => { const a=document.getElementById(id); if(a){a.pause();a.src='';} });
  if (socket) { socket.disconnect(); socket = null; }
  myCode = null; listeners = {};
  go('s-home');
}

function setVol(v, id) { document.getElementById(id).volume = parseFloat(v); }

function copyCode() {
  navigator.clipboard.writeText(document.getElementById('h-code-text').textContent)
    .then(() => toast('Code copied! üìã'));
}

function updateSyncInfo(html) {
  document.getElementById('l-sync-info').innerHTML = '<strong>Sync Status:</strong> ' + html;
}

function fmtTime(s) {
  if (!s || isNaN(s)) return '0:00';
  const m = Math.floor(s / 60), sec = Math.floor(s % 60);
  return m + ':' + (sec < 10 ? '0' : '') + sec;
}

function setPill(id, type, label) {
  const el = document.getElementById(id);
  const cls = { live:'pill-live', wait:'pill-wait', sync:'pill-sync' };
  const dot = { live:'dot-g', wait:'dot-m', sync:'dot-c' };
  el.className = 'pill ' + cls[type];
  el.innerHTML = '<div class="dot ' + dot[type] + '"></div><span>' + label + '</span>';
}

function renderListeners() {
  const ids = Object.keys(listeners);
  const el = document.getElementById('h-llist');
  document.getElementById('h-lcount').textContent = ids.length;
  if (!ids.length) { el.innerHTML = '<div class="no-l">No one joined yet ‚Äî share your code!</div>'; return; }
  el.innerHTML = ids.map((id, i) => '<div class="litem"><div class="lavatar">üéß</div><span>Listener ' + (i+1) + '</span><span style="margin-left:auto;font-size:11px;color:var(--green);">‚óè synced</span></div>').join('');
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3500);
}

function startViz(audioEl, canvasId) {
  stopViz();
  try {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const src = audioCtx.createMediaElementSource(audioEl);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    src.connect(analyser);
    src.connect(audioCtx.destination);
    drawViz(canvasId);
  } catch(e) { console.warn('Viz:', e); }
}

function drawViz(canvasId) {
  const canvas = document.getElementById(canvasId);
  if (!canvas || !analyser) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth || 600, H = canvas.offsetHeight || 60;
  canvas.width = W; canvas.height = H;
  const buf = new Uint8Array(analyser.frequencyBinCount);
  function frame() {
    raf = requestAnimationFrame(frame);
    analyser.getByteFrequencyData(buf);
    ctx.fillStyle = '#07080d';
    ctx.fillRect(0, 0, W, H);
    const bw = (W / buf.length) * 2.2;
    let x = 0;
    for (let i = 0; i < buf.length; i++) {
      const h = (buf[i] / 255) * H;
      ctx.fillStyle = 'hsla(' + (160 + i/buf.length*100) + ',100%,60%,0.9)';
      ctx.fillRect(x, H - h, bw, h);
      x += bw + 1;
    }
  }
  frame();
}

function stopViz() {
  if (raf) { cancelAnimationFrame(raf); raf = null; }
  if (audioCtx) { audioCtx.close().catch(()=>{}); audioCtx = null; }
}

document.getElementById('code-input').addEventListener('input', function() {
  this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g,'');
});
</script>
</body>
</html>
