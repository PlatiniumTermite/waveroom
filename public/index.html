<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WaveRoom â€” Sync Audio Live</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #07080d;
  --surface: #0e1018;
  --border: #1c2030;
  --accent: #00e5ff;
  --purple: #8b5cf6;
  --green: #00ff88;
  --red: #ff4466;
  --text: #e2e8f0;
  --muted: #4a5578;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Syne', sans-serif;
  min-height: 100vh;
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: linear-gradient(var(--border) 1px, transparent 1px), linear-gradient(90deg, var(--border) 1px, transparent 1px);
  background-size: 50px 50px;
  opacity: 0.25;
  pointer-events: none;
}

.wrap {
  position: relative;
  z-index: 1;
  max-width: 860px;
  margin: 0 auto;
  padding: 32px 20px;
}

/* HEADER */
.logo { display: flex; align-items: center; gap: 10px; margin-bottom: 56px; }
.logo-icon {
  width: 38px; height: 38px; border-radius: 10px;
  background: linear-gradient(135deg, var(--accent), var(--purple));
  display: flex; align-items: center; justify-content: center; font-size: 20px;
}
.logo-name {
  font-size: 22px; font-weight: 800;
  background: linear-gradient(135deg, var(--accent), var(--purple));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}

/* SCREENS */
.screen { display: none; }
.screen.active { display: block; animation: up 0.25s ease; }
@keyframes up { from { opacity:0; transform:translateY(14px); } to { opacity:1; transform:translateY(0); } }

/* HOME */
.hero { text-align: center; padding: 30px 0 50px; }
.hero h1 { font-size: clamp(38px, 7vw, 76px); font-weight: 800; letter-spacing: -2px; line-height: 1.05; margin-bottom: 18px; }
.hero h1 em { font-style: normal; background: linear-gradient(135deg, var(--accent), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.hero p { font-family: 'Space Mono', monospace; font-size: 15px; color: var(--muted); max-width: 420px; margin: 0 auto 48px; line-height: 1.7; }

.two { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; max-width: 580px; margin: 0 auto; }
@media(max-width:500px){ .two { grid-template-columns: 1fr; } }

.card {
  background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
  padding: 28px 22px; text-align: left; cursor: pointer;
  transition: border-color 0.2s, transform 0.2s;
}
.card:hover { border-color: rgba(0,229,255,0.35); transform: translateY(-3px); }
.card-icon { font-size: 28px; margin-bottom: 14px; }
.card-title { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
.card-desc { font-size: 13px; color: var(--muted); font-family: 'Space Mono', monospace; line-height: 1.55; }

/* FORM */
.form-box { max-width: 460px; margin: 0 auto; }
.back { background: none; border: none; color: var(--muted); font-family: 'Space Mono', monospace; font-size: 13px; cursor: pointer; margin-bottom: 36px; padding: 0; transition: color 0.2s; }
.back:hover { color: var(--accent); }
.ftitle { font-size: 34px; font-weight: 800; letter-spacing: -1px; margin-bottom: 6px; }
.fsub { font-family: 'Space Mono', monospace; font-size: 13px; color: var(--muted); margin-bottom: 28px; line-height: 1.65; }
label { display: block; font-size: 11px; font-weight: 700; letter-spacing: 1.2px; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }

input {
  width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
  padding: 13px 15px; color: var(--text); font-family: 'Space Mono', monospace; font-size: 15px;
  outline: none; transition: border-color 0.2s; margin-bottom: 20px;
}
input:focus { border-color: var(--accent); }
input::placeholder { color: var(--muted); }
#code-input { letter-spacing: 5px; font-size: 20px; text-transform: uppercase; }

.btn {
  width: 100%; padding: 14px; border-radius: 10px; font-family: 'Syne', sans-serif;
  font-size: 15px; font-weight: 700; cursor: pointer; border: none; transition: all 0.2s;
  display: flex; align-items: center; justify-content: center; gap: 8px;
}
.btn-cyan { background: linear-gradient(135deg, var(--accent), #0099bb); color: #000; }
.btn-cyan:hover { box-shadow: 0 8px 24px rgba(0,229,255,0.3); transform: translateY(-1px); }
.btn-purple { background: linear-gradient(135deg, var(--purple), #6d28d9); color: #fff; }
.btn-purple:hover { box-shadow: 0 8px 24px rgba(139,92,246,0.35); transform: translateY(-1px); }
.btn-red { background: var(--red); color: #fff; }
.btn-red:hover { opacity: 0.85; }
.btn-ghost { background: var(--surface); border: 1px solid var(--border); color: var(--text); }
.btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
.btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

.err { background: rgba(255,68,102,0.1); border: 1px solid rgba(255,68,102,0.3); border-radius: 8px; padding: 12px 15px; font-family: 'Space Mono', monospace; font-size: 13px; color: var(--red); margin-bottom: 18px; display: none; }
.err.show { display: block; }

/* ROOM */
.room-top { display: flex; align-items: flex-start; justify-content: space-between; flex-wrap: wrap; gap: 12px; margin-bottom: 28px; }
.rname { font-size: 26px; font-weight: 800; letter-spacing: -0.5px; }
.rcode {
  display: inline-flex; align-items: center; gap: 8px; margin-top: 6px;
  background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
  padding: 7px 13px; font-family: 'Space Mono', monospace; font-size: 20px; font-weight: 700;
  letter-spacing: 4px; color: var(--accent); cursor: pointer; transition: border-color 0.2s;
}
.rcode:hover { border-color: var(--accent); }
.rcode small { font-size: 11px; color: var(--muted); letter-spacing: 0; }

.pill {
  display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 100px;
  font-family: 'Space Mono', monospace; font-size: 12px; font-weight: 700;
}
.pill-live { background: rgba(0,255,136,0.1); color: var(--green); border: 1px solid rgba(0,255,136,0.25); }
.pill-wait { background: rgba(74,85,120,0.15); color: var(--muted); border: 1px solid var(--border); }
.pill-ear { background: rgba(0,229,255,0.1); color: var(--accent); border: 1px solid rgba(0,229,255,0.2); }
.dot { width: 7px; height: 7px; border-radius: 50%; }
.dot-g { background: var(--green); animation: blink 1.4s infinite; }
.dot-m { background: var(--muted); }
.dot-c { background: var(--accent); animation: blink 1.4s infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.4} }

.panel { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 22px; margin-bottom: 16px; }
.panel-title { font-size: 11px; text-transform: uppercase; letter-spacing: 1.2px; color: var(--muted); font-family: 'Space Mono', monospace; margin-bottom: 16px; }

canvas { width: 100%; height: 72px; display: block; border-radius: 6px; background: var(--bg); }

.btn-row { display: flex; gap: 12px; }
.btn-row .btn { width: auto; flex: 1; }

.hint { background: rgba(0,229,255,0.04); border: 1px solid rgba(0,229,255,0.12); border-radius: 10px; padding: 14px 18px; margin-bottom: 16px; font-family: 'Space Mono', monospace; font-size: 12px; color: var(--muted); line-height: 1.9; }
.hint strong { color: var(--accent); }

.lcount { color: var(--accent); }
.no-l { font-family: 'Space Mono', monospace; font-size: 13px; color: var(--muted); text-align: center; padding: 18px 0; }
.litem { display: flex; align-items: center; gap: 10px; padding: 9px 0; border-bottom: 1px solid var(--border); font-family: 'Space Mono', monospace; font-size: 13px; }
.litem:last-child { border: none; }
.lavatar { width: 30px; height: 30px; border-radius: 7px; background: linear-gradient(135deg, var(--purple), var(--accent)); display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }

/* TOAST */
.toast {
  position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%) translateY(80px);
  background: #1a1f2e; border: 1px solid var(--border); border-radius: 10px;
  padding: 11px 20px; font-family: 'Space Mono', monospace; font-size: 13px;
  z-index: 999; transition: transform 0.3s ease; white-space: nowrap;
}
.toast.show { transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>
<div class="wrap">
  <div class="logo">
    <div class="logo-icon">ğŸŒŠ</div>
    <div class="logo-name">WaveRoom</div>
  </div>

  <!-- HOME -->
  <div id="s-home" class="screen active">
    <div class="hero">
      <h1>Sync Audio<br>With <em>Everyone</em></h1>
      <p>Create a room. Share your tab audio. Everyone hears the same thing live â€” no YouTube URL needed.</p>
      <div class="two">
        <div class="card" onclick="go('s-create')">
          <div class="card-icon">ğŸ™</div>
          <div class="card-title">Host a Room</div>
          <div class="card-desc">Share your audio. Others hear it live.</div>
        </div>
        <div class="card" onclick="go('s-join')">
          <div class="card-icon">ğŸ§</div>
          <div class="card-title">Join a Room</div>
          <div class="card-desc">Enter a code and listen in sync.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- CREATE -->
  <div id="s-create" class="screen">
    <div class="form-box">
      <button class="back" onclick="go('s-home')">â† Back</button>
      <div class="ftitle">Host a Room</div>
      <div class="fsub">You share tab audio â€” everyone who joins hears it instantly.</div>
      <label>Room Name</label>
      <input id="rname" type="text" placeholder="My Vibe Session" maxlength="40">
      <button class="btn btn-cyan" onclick="createRoom()">Create Room â†’</button>
    </div>
  </div>

  <!-- JOIN -->
  <div id="s-join" class="screen">
    <div class="form-box">
      <button class="back" onclick="go('s-home')">â† Back</button>
      <div class="ftitle">Join a Room</div>
      <div class="fsub">Type the 6-letter code your friend shared with you.</div>
      <label>Room Code</label>
      <input id="code-input" type="text" placeholder="ABC123" maxlength="6">
      <div id="join-err" class="err">Room not found. Check the code.</div>
      <button class="btn btn-purple" onclick="joinRoom()">Join Room â†’</button>
    </div>
  </div>

  <!-- HOST ROOM -->
  <div id="s-host" class="screen">
    <div class="room-top">
      <div>
        <div class="rname" id="h-rname">Room</div>
        <div class="rcode" id="h-code" onclick="copyCode()">
          <span id="h-code-text">------</span>
          <small>tap to copy</small>
        </div>
      </div>
      <div id="h-pill" class="pill pill-wait"><div class="dot dot-m"></div><span>Not streaming</span></div>
    </div>

    <div class="hint">
      <strong>How to share:</strong><br>
      1. Click <strong>Start Sharing</strong> below<br>
      2. Pick a <strong>Browser Tab</strong> (not screen)<br>
      3. âœ… Check <strong>"Share tab audio"</strong><br>
      4. Everyone hears it instantly ğŸ§
    </div>

    <div class="panel">
      <canvas id="h-canvas"></canvas>
    </div>

    <div class="panel">
      <div class="panel-title">Controls</div>
      <div class="btn-row">
        <button id="share-btn" class="btn btn-cyan" onclick="startShare()">ğŸ™ Start Sharing</button>
        <button id="stop-btn" class="btn btn-red" onclick="stopShare()" disabled>â¹ Stop</button>
      </div>
    </div>

    <div class="panel">
      <div class="panel-title" style="display:flex;justify-content:space-between;">
        <span>Listeners</span><span class="lcount" id="h-lcount">0</span>
      </div>
      <div id="h-llist"><div class="no-l">No one joined yet â€” share your code!</div></div>
    </div>

    <div style="margin-top:14px;">
      <button class="btn btn-ghost" onclick="leave()">Leave Room</button>
    </div>
  </div>

  <!-- LISTENER ROOM -->
  <div id="s-listener" class="screen">
    <div class="room-top">
      <div>
        <div class="rname" id="l-rname">Room</div>
        <div style="font-family:'Space Mono',monospace;font-size:13px;color:var(--muted);margin-top:6px;" id="l-code"></div>
      </div>
      <div id="l-pill" class="pill pill-wait"><div class="dot dot-m"></div><span>Waiting...</span></div>
    </div>

    <div class="panel">
      <canvas id="l-canvas"></canvas>
    </div>

    <div class="panel">
      <div class="panel-title">Status</div>
      <div style="font-family:'Space Mono',monospace;font-size:13px;color:var(--muted);line-height:1.8;" id="l-status-text">
        Waiting for host to start sharing audio... ğŸ§<br>
        Make sure your volume is on.
      </div>
    </div>

    <audio id="remote-audio" autoplay playsinline></audio>

    <div style="margin-top:14px;">
      <button class="btn btn-ghost" onclick="leave()">Leave Room</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- Load socket.io from the server itself -->
<script src="/socket.io/socket.io.js"></script>
<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let socket = null;
let myCode = null;
let amHost = false;
let localStream = null;
let peers = {};        // listenerId â†’ RTCPeerConnection  (host side)
let hostPeer = null;   // RTCPeerConnection  (listener side)
let audioCtx = null, analyser = null, raf = null;
let listeners = {};

const ICE = { iceServers: [
  { urls: 'stun:stun.l.google.com:19302' },
  { urls: 'stun:stun1.l.google.com:19302' }
]};

// â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function go(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// â”€â”€ SOCKET INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initSocket() {
  if (socket && socket.connected) return;

  // Connect to same origin â€” works on Render automatically
  socket = io({ transports: ['websocket', 'polling'] });

  socket.on('connect', () => {
    console.log('Socket connected:', socket.id);
    toast('Connected to server âœ…');
  });

  socket.on('connect_error', (e) => {
    console.error('Socket error:', e);
    toast('Connection error â€” refresh page');
  });

  // â”€â”€ HOST events â”€â”€
  socket.on('listener-joined', async ({ id }) => {
    addListener(id);
    if (localStream) await sendOffer(id);
  });

  socket.on('listener-left', ({ id }) => {
    removeListener(id);
    if (peers[id]) { peers[id].close(); delete peers[id]; }
  });

  socket.on('listener-count', (n) => {
    document.getElementById('h-lcount').textContent = n;
  });

  // â”€â”€ LISTENER events â”€â”€
  socket.on('offer', async ({ from, offer }) => {
    hostPeer = new RTCPeerConnection(ICE);

    hostPeer.ontrack = (e) => {
      console.log('Got remote track!', e.streams[0]);
      const audio = document.getElementById('remote-audio');
      audio.srcObject = e.streams[0];
      audio.play().catch(console.error);
      startViz(e.streams[0], 'l-canvas');
      setPill('l-pill', 'ear');
      document.getElementById('l-status-text').textContent = 'ğŸ§ Receiving audio from host...';
    };

    hostPeer.onicecandidate = (e) => {
      if (e.candidate) socket.emit('ice-candidate', { to: from, candidate: e.candidate });
    };

    await hostPeer.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await hostPeer.createAnswer();
    await hostPeer.setLocalDescription(answer);
    socket.emit('answer', { to: from, answer });
  });

  socket.on('answer', async ({ from, answer }) => {
    if (peers[from]) await peers[from].setRemoteDescription(new RTCSessionDescription(answer));
  });

  socket.on('ice-candidate', async ({ from, candidate }) => {
    const pc = amHost ? peers[from] : hostPeer;
    if (pc) await pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(console.error);
  });

  socket.on('host-left', () => {
    toast('Host ended the session');
    leave();
  });
}

// â”€â”€ CREATE ROOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createRoom() {
  const name = document.getElementById('rname').value.trim() || 'Audio Room';
  initSocket();
  amHost = true;

  socket.emit('create-room', { name }, (res) => {
    if (!res || !res.ok) { toast('Failed to create room'); return; }
    myCode = res.code;
    document.getElementById('h-rname').textContent = res.name;
    document.getElementById('h-code-text').textContent = res.code;
    go('s-host');
    toast('Room created! ğŸ‰ Share the code');
  });
}

// â”€â”€ JOIN ROOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function joinRoom() {
  const code = document.getElementById('code-input').value.trim().toUpperCase();
  if (!code || code.length < 4) return;
  initSocket();
  amHost = false;

  socket.emit('join-room', { code }, (res) => {
    if (!res || !res.ok) {
      document.getElementById('join-err').classList.add('show');
      return;
    }
    document.getElementById('join-err').classList.remove('show');
    myCode = code;
    document.getElementById('l-rname').textContent = res.name;
    document.getElementById('l-code').textContent = 'Code: ' + code;
    go('s-listener');
    toast('Joined! Waiting for host ğŸ§');
  });
}

// â”€â”€ START SHARING (HOST) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startShare() {
  try {
    const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });

    // We only want audio â€” stop video tracks
    stream.getVideoTracks().forEach(t => t.stop());

    if (!stream.getAudioTracks().length) {
      toast('âš ï¸ No audio track â€” did you check "Share tab audio"?');
      return;
    }

    localStream = stream;
    startViz(localStream, 'h-canvas');
    setPill('h-pill', 'live');

    document.getElementById('share-btn').disabled = true;
    document.getElementById('stop-btn').disabled = false;

    // If listeners already in room, send them offers
    for (const id of Object.keys(listeners)) {
      await sendOffer(id);
    }

    localStream.getTracks().forEach(t => { t.onended = () => stopShare(); });
    toast('ğŸ™ Streaming live!');
  } catch (e) {
    console.error(e);
    if (e.name !== 'NotAllowedError') toast('Could not capture audio');
  }
}

// â”€â”€ SEND OFFER TO LISTENER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendOffer(listenerId) {
  if (peers[listenerId]) { peers[listenerId].close(); }
  const pc = new RTCPeerConnection(ICE);
  peers[listenerId] = pc;

  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

  pc.onicecandidate = (e) => {
    if (e.candidate) socket.emit('ice-candidate', { to: listenerId, candidate: e.candidate });
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  socket.emit('offer', { to: listenerId, offer });
}

// â”€â”€ STOP SHARING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function stopShare() {
  if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
  Object.values(peers).forEach(pc => pc.close());
  peers = {};
  stopViz();
  setPill('h-pill', 'wait');
  document.getElementById('share-btn').disabled = false;
  document.getElementById('stop-btn').disabled = true;
  toast('â¹ Stopped streaming');
}

// â”€â”€ LEAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function leave() {
  stopShare();
  if (hostPeer) { hostPeer.close(); hostPeer = null; }
  stopViz();
  if (socket) { socket.disconnect(); socket = null; }
  myCode = null; listeners = {};
  go('s-home');
}

// â”€â”€ LISTENERS UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addListener(id) {
  listeners[id] = true;
  renderListeners();
}
function removeListener(id) {
  delete listeners[id];
  renderListeners();
}
function renderListeners() {
  const ids = Object.keys(listeners);
  const el = document.getElementById('h-llist');
  document.getElementById('h-lcount').textContent = ids.length;
  if (!ids.length) { el.innerHTML = '<div class="no-l">No one joined yet â€” share your code!</div>'; return; }
  el.innerHTML = ids.map((id, i) => `
    <div class="litem">
      <div class="lavatar">ğŸ§</div>
      <span>Listener ${i + 1}</span>
      <span style="margin-left:auto;font-size:11px;color:var(--green);">â— live</span>
    </div>`).join('');
}

// â”€â”€ COPY CODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyCode() {
  const code = document.getElementById('h-code-text').textContent;
  navigator.clipboard.writeText(code).then(() => toast('Code copied ğŸ“‹'));
}

// â”€â”€ PILLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setPill(id, state) {
  const el = document.getElementById(id);
  const map = {
    live: ['pill-live', '<div class="dot dot-g"></div><span>Live</span>'],
    wait: ['pill-wait', '<div class="dot dot-m"></div><span>Not streaming</span>'],
    ear:  ['pill-ear',  '<div class="dot dot-c"></div><span>Receiving audio</span>']
  };
  el.className = 'pill ' + map[state][0];
  el.innerHTML = map[state][1];
}

// â”€â”€ VISUALIZER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startViz(stream, canvasId) {
  stopViz();
  try {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const src = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    src.connect(analyser);
    drawViz(canvasId);
  } catch(e) { console.warn('Viz error', e); }
}

function drawViz(canvasId) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth || 600;
  const H = canvas.offsetHeight || 72;
  canvas.width = W; canvas.height = H;
  const buf = new Uint8Array(analyser.frequencyBinCount);

  function frame() {
    raf = requestAnimationFrame(frame);
    analyser.getByteFrequencyData(buf);
    ctx.fillStyle = '#07080d';
    ctx.fillRect(0, 0, W, H);
    const bw = (W / buf.length) * 2.2;
    let x = 0;
    for (let i = 0; i < buf.length; i++) {
      const h = (buf[i] / 255) * H;
      const hue = 160 + (i / buf.length) * 100;
      ctx.fillStyle = `hsla(${hue},100%,60%,0.9)`;
      ctx.fillRect(x, H - h, bw, h);
      x += bw + 1;
    }
  }
  frame();
}

function stopViz() {
  if (raf) { cancelAnimationFrame(raf); raf = null; }
  if (audioCtx) { audioCtx.close().catch(()=>{}); audioCtx = null; }
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// â”€â”€ INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('code-input').addEventListener('input', function() {
  this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
});
</script>
</body>
</html>
