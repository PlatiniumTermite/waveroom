<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>WaveRoom ‚Äî Sync Audio Live</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07080d;--surface:#0e1018;--border:#1c2030;
  --accent:#00e5ff;--purple:#8b5cf6;--green:#00ff88;
  --red:#ff4466;--text:#e2e8f0;--muted:#4a5578
}
body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;min-height:100vh;overscroll-behavior:none}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);background-size:50px 50px;opacity:.18;pointer-events:none}
.wrap{position:relative;z-index:1;max-width:820px;margin:0 auto;padding:28px 18px}
.logo{display:flex;align-items:center;gap:10px;margin-bottom:44px}
.logo-icon{width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-size:18px}
.logo-name{font-size:21px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.screen{display:none}
.screen.active{display:block;animation:up .22s ease}
@keyframes up{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* HOME */
.hero{text-align:center;padding:16px 0 36px}
.hero h1{font-size:clamp(34px,6vw,64px);font-weight:800;letter-spacing:-2px;line-height:1.05;margin-bottom:14px}
.hero h1 em{font-style:normal;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero p{font-family:'Space Mono',monospace;font-size:13px;color:var(--muted);max-width:380px;margin:0 auto 36px;line-height:1.8}
.two{display:grid;grid-template-columns:1fr 1fr;gap:12px;max-width:540px;margin:0 auto}
@media(max-width:460px){.two{grid-template-columns:1fr}}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px 18px;text-align:left;cursor:pointer;transition:border-color .2s,transform .2s;-webkit-tap-highlight-color:transparent}
.card:hover,.card:active{border-color:rgba(0,229,255,.35);transform:translateY(-2px)}
.card-icon{font-size:24px;margin-bottom:10px}
.card-title{font-size:16px;font-weight:700;margin-bottom:4px}
.card-desc{font-size:12px;color:var(--muted);font-family:'Space Mono',monospace;line-height:1.55}
.how{max-width:540px;margin:24px auto 0;background:rgba(0,229,255,.04);border:1px solid rgba(0,229,255,.1);border-radius:12px;padding:18px 20px}
.how-title{font-size:10px;text-transform:uppercase;letter-spacing:1.2px;color:var(--accent);font-family:'Space Mono',monospace;margin-bottom:10px}
.how p{font-family:'Space Mono',monospace;font-size:11px;color:var(--muted);line-height:1.95}
.how strong{color:var(--text)}

/* FORM */
.form-box{max-width:420px;margin:0 auto}
.back{background:none;border:none;color:var(--muted);font-family:'Space Mono',monospace;font-size:13px;cursor:pointer;margin-bottom:28px;padding:0;transition:color .2s}
.back:hover{color:var(--accent)}
.ftitle{font-size:30px;font-weight:800;letter-spacing:-1px;margin-bottom:6px}
.fsub{font-family:'Space Mono',monospace;font-size:12px;color:var(--muted);margin-bottom:24px;line-height:1.7}
label{display:block;font-size:10px;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px}
input[type="text"]{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:9px;padding:12px 14px;color:var(--text);font-family:'Space Mono',monospace;font-size:15px;outline:none;transition:border-color .2s;margin-bottom:16px}
input[type="text"]:focus{border-color:var(--accent)}
input[type="text"]::placeholder{color:var(--muted)}
#code-input{letter-spacing:5px;font-size:20px;text-transform:uppercase}

/* FILE UPLOAD */
.upload-zone{width:100%;border:2px dashed var(--border);border-radius:11px;padding:28px 18px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:16px;background:var(--surface);-webkit-tap-highlight-color:transparent}
.upload-zone:hover,.upload-zone.drag,.upload-zone:active{border-color:var(--accent);background:rgba(0,229,255,.04)}
.uz-icon{font-size:28px;margin-bottom:8px}
.uz-text{font-family:'Space Mono',monospace;font-size:12px;color:var(--muted);line-height:1.65}
.uz-text strong{color:var(--accent)}
.upload-zone input{display:none}
.file-chosen{background:rgba(0,255,136,.06);border:1px solid rgba(0,255,136,.2);border-radius:9px;padding:10px 14px;font-family:'Space Mono',monospace;font-size:12px;color:var(--green);margin-bottom:16px;display:none;word-break:break-all}
.file-chosen.show{display:block}

.btn{width:100%;padding:13px;border-radius:9px;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;cursor:pointer;border:none;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:7px;-webkit-tap-highlight-color:transparent}
.btn-cyan{background:linear-gradient(135deg,var(--accent),#0099bb);color:#000}
.btn-cyan:hover,.btn-cyan:active{box-shadow:0 6px 20px rgba(0,229,255,.3);transform:translateY(-1px)}
.btn-purple{background:linear-gradient(135deg,var(--purple),#6d28d9);color:#fff}
.btn-purple:hover,.btn-purple:active{box-shadow:0 6px 20px rgba(139,92,246,.35);transform:translateY(-1px)}
.btn-ghost{background:var(--surface);border:1px solid var(--border);color:var(--text)}
.btn-ghost:hover,.btn-ghost:active{border-color:var(--accent);color:var(--accent)}
.btn-red{background:var(--red);color:#fff}
.btn:disabled{opacity:.3;cursor:not-allowed;transform:none!important;box-shadow:none!important}
.err{background:rgba(255,68,102,.1);border:1px solid rgba(255,68,102,.3);border-radius:8px;padding:10px 14px;font-family:'Space Mono',monospace;font-size:12px;color:var(--red);margin-bottom:14px;display:none}
.err.show{display:block}

/* ROOM */
.room-top{display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:20px}
.rname{font-size:22px;font-weight:800;letter-spacing:-.5px}
.rcode{display:inline-flex;align-items:center;gap:7px;margin-top:5px;background:var(--surface);border:1px solid var(--border);border-radius:7px;padding:6px 12px;font-family:'Space Mono',monospace;font-size:18px;font-weight:700;letter-spacing:4px;color:var(--accent);cursor:pointer;transition:border-color .2s}
.rcode:hover,.rcode:active{border-color:var(--accent)}
.rcode small{font-size:10px;color:var(--muted);letter-spacing:0}
.pill{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:100px;font-family:'Space Mono',monospace;font-size:11px;font-weight:700}
.pill-live{background:rgba(0,255,136,.1);color:var(--green);border:1px solid rgba(0,255,136,.25)}
.pill-wait{background:rgba(74,85,120,.15);color:var(--muted);border:1px solid var(--border)}
.pill-sync{background:rgba(0,229,255,.1);color:var(--accent);border:1px solid rgba(0,229,255,.2)}
.dot{width:6px;height:6px;border-radius:50%}
.dot-g{background:var(--green);animation:blink 1.4s infinite}
.dot-m{background:var(--muted)}
.dot-c{background:var(--accent);animation:blink 1.4s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.35}}
.panel{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:12px}
.panel-title{font-size:10px;text-transform:uppercase;letter-spacing:1.2px;color:var(--muted);font-family:'Space Mono',monospace;margin-bottom:12px}
.track-info{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.track-icon{width:40px;height:40px;border-radius:9px;background:linear-gradient(135deg,var(--purple),var(--accent));display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.track-name{font-size:14px;font-weight:700;word-break:break-all}
.track-sub{font-family:'Space Mono',monospace;font-size:11px;color:var(--muted);margin-top:2px}
.progress-wrap{margin-bottom:8px;cursor:pointer;padding:6px 0}
.progress-bar{width:100%;height:4px;background:var(--border);border-radius:10px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--purple));border-radius:10px;width:0%;transition:width .3s linear}
.time-row{display:flex;justify-content:space-between;font-family:'Space Mono',monospace;font-size:10px;color:var(--muted);margin-top:5px}
.play-row{display:flex;gap:8px;margin-top:12px}
.play-row .btn{width:auto;flex:1;padding:10px 8px;font-size:13px}
.vol-row{display:flex;align-items:center;gap:8px;margin-top:12px}
.vol-label{font-family:'Space Mono',monospace;font-size:11px;color:var(--muted);white-space:nowrap}
input[type="range"]{flex:1;accent-color:var(--accent);cursor:pointer;height:20px}
.sync-box{background:rgba(0,229,255,.04);border:1px solid rgba(0,229,255,.12);border-radius:9px;padding:11px 14px;font-family:'Space Mono',monospace;font-size:11px;color:var(--muted);line-height:1.85}
.sync-box strong{color:var(--accent)}
.lcount{color:var(--accent)}
.no-l{font-family:'Space Mono',monospace;font-size:12px;color:var(--muted);text-align:center;padding:14px 0}
.litem{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border);font-family:'Space Mono',monospace;font-size:12px}
.litem:last-child{border:none}
.lavatar{width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,var(--purple),var(--accent));display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
canvas{width:100%;height:56px;display:block;border-radius:6px;background:var(--bg)}

/* TAP TO START OVERLAY */
#tap-overlay{position:fixed;inset:0;background:rgba(7,8,13,.92);z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;cursor:pointer;-webkit-tap-highlight-color:transparent}
#tap-overlay.hidden{display:none}
.tap-icon{font-size:56px;animation:tapPulse 1.5s infinite}
@keyframes tapPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.tap-title{font-size:22px;font-weight:800;color:var(--text)}
.tap-sub{font-family:'Space Mono',monospace;font-size:13px;color:var(--muted);text-align:center;max-width:260px;line-height:1.6}

.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:#1a1f2e;border:1px solid var(--border);border-radius:9px;padding:10px 18px;font-family:'Space Mono',monospace;font-size:12px;z-index:999;transition:transform .3s ease;white-space:nowrap;max-width:90vw;text-align:center}
.toast.show{transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>

<!-- Tap to unlock audio on mobile -->
<div id="tap-overlay" onclick="unlockAudio()">
  <div class="tap-icon">üéµ</div>
  <div class="tap-title">Tap to Start</div>
  <div class="tap-sub">Tap once to unlock audio on your device</div>
</div>

<div class="wrap">
  <div class="logo">
    <div class="logo-icon">üåä</div>
    <div class="logo-name">WaveRoom</div>
  </div>

  <!-- HOME -->
  <div id="s-home" class="screen active">
    <div class="hero">
      <h1>Hear The Same<br><em>Moment</em> Together</h1>
      <p>Host shares their tab audio via WebRTC. Everyone hears it live ‚Äî auto-synced with drift correction.</p>
      <div class="two">
        <div class="card" onclick="go('s-create')">
          <div class="card-icon">üéô</div>
          <div class="card-title">Host a Room</div>
          <div class="card-desc">Share any tab audio to everyone live.</div>
        </div>
        <div class="card" onclick="go('s-join')">
          <div class="card-icon">üéß</div>
          <div class="card-title">Join a Room</div>
          <div class="card-desc">Enter code and hear it instantly in sync.</div>
        </div>
      </div>
      <div class="how">
        <div class="how-title">Works on all devices ‚Äî no file upload needed</div>
        <p>
          <strong>Host</strong> selects a browser tab + checks "Share tab audio"<br>
          <strong>Stream</strong> goes via WebRTC to all listeners<br>
          <strong>Auto-sync</strong> corrects drift every 3 seconds<br>
          <strong>Mobile listeners</strong> just tap once to unlock audio ‚úÖ
        </p>
      </div>
    </div>
  </div>

  <!-- CREATE -->
  <div id="s-create" class="screen">
    <div class="form-box">
      <button class="back" onclick="go('s-home')">‚Üê Back</button>
      <div class="ftitle">Host a Room</div>
      <div class="fsub">You share tab audio ‚Äî works with YouTube, Spotify, anything playing in a tab.</div>
      <label>Room Name</label>
      <input type="text" id="rname" placeholder="Friday Night Session" maxlength="40">
      <button class="btn btn-cyan" onclick="createRoom()">Create Room ‚Üí</button>
    </div>
  </div>

  <!-- JOIN -->
  <div id="s-join" class="screen">
    <div class="form-box">
      <button class="back" onclick="go('s-home')">‚Üê Back</button>
      <div class="ftitle">Join a Room</div>
      <div class="fsub">Enter the 6-letter code. Audio streams directly to you ‚Äî nothing to upload.</div>
      <label>Room Code</label>
      <input type="text" id="code-input" placeholder="ABC123" maxlength="6">
      <div id="join-err" class="err">Room not found. Check the code.</div>
      <button class="btn btn-purple" onclick="joinRoom()">Join Room ‚Üí</button>
    </div>
  </div>

  <!-- HOST ROOM -->
  <div id="s-host" class="screen">
    <div class="room-top">
      <div>
        <div class="rname" id="h-rname">Room</div>
        <div class="rcode" onclick="copyCode()">
          <span id="h-code-text">------</span>
          <small>copy</small>
        </div>
      </div>
      <div id="h-pill" class="pill pill-wait"><div class="dot dot-m"></div><span>Not sharing</span></div>
    </div>

    <div class="panel" style="background:rgba(0,229,255,.04);border-color:rgba(0,229,255,.15)">
      <div style="font-family:'Space Mono',monospace;font-size:11px;color:var(--muted);line-height:1.9">
        <strong style="color:var(--accent)">How to share audio:</strong><br>
        1. Click <strong style="color:var(--text)">Start Sharing</strong> below<br>
        2. Pick a <strong style="color:var(--text)">Browser Tab</strong> (NOT screen/window)<br>
        3. ‚úÖ Check <strong style="color:var(--text)">"Share tab audio"</strong> checkbox<br>
        4. Everyone hears it instantly ‚Äî <strong style="color:var(--green)">Chrome only for hosting</strong>
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">Audio Visualizer</div>
      <canvas id="h-canvas"></canvas>
    </div>

    <div class="panel">
      <div class="panel-title">Controls</div>
      <div class="play-row">
        <button id="share-btn" class="btn btn-cyan" onclick="startShare()">üéô Start Sharing</button>
        <button id="stop-btn" class="btn btn-red" onclick="stopShare()" disabled>‚èπ Stop</button>
      </div>
    </div>

    <div class="panel">
      <div class="panel-title" style="display:flex;justify-content:space-between">
        <span>Listeners</span><span class="lcount" id="h-lcount">0</span>
      </div>
      <div id="h-llist"><div class="no-l">No one joined yet ‚Äî share your code!</div></div>
    </div>
    <div style="margin-top:10px"><button class="btn btn-ghost" onclick="leave()">Leave Room</button></div>
  </div>

  <!-- LISTENER ROOM -->
  <div id="s-listener" class="screen">
    <div class="room-top">
      <div>
        <div class="rname" id="l-rname">Room</div>
        <div style="font-family:'Space Mono',monospace;font-size:12px;color:var(--muted);margin-top:4px" id="l-code-label"></div>
      </div>
      <div id="l-pill" class="pill pill-wait"><div class="dot dot-m"></div><span>Waiting...</span></div>
    </div>

    <div class="panel">
      <div class="track-info">
        <div class="track-icon">üéµ</div>
        <div>
          <div class="track-name" id="l-track-name">Waiting for host...</div>
          <div class="track-sub">Audio will play automatically when host starts</div>
        </div>
      </div>
      <div class="vol-row">
        <span class="vol-label">üîä Vol</span>
        <input type="range" min="0" max="1" step="0.01" value="1" oninput="setVol(this.value)">
      </div>
    </div>

    <div class="panel">
      <div class="sync-box" id="l-sync-info">
        <strong>Sync Status:</strong> Waiting for host to start sharing...
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">Visualizer</div>
      <canvas id="l-canvas"></canvas>
    </div>

    <audio id="remote-audio" playsinline></audio>
    <div style="margin-top:10px"><button class="btn btn-ghost" onclick="leave()">Leave Room</button></div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
// ‚îÄ‚îÄ STATE
let socket=null, myCode=null, amHost=false;
let localStream=null, peers={}, hostPeer=null;
let audioCtx=null, analyser=null, raf=null, vizSrc=null;
let listeners={};
let audioUnlocked=false;
let clockOffset=0, syncSamples=[];

const ICE={iceServers:[
  {urls:'stun:stun.l.google.com:19302'},
  {urls:'stun:stun1.l.google.com:19302'},
  {urls:'stun:stun2.l.google.com:19302'}
]};

// ‚îÄ‚îÄ UNLOCK AUDIO (mobile fix)
function unlockAudio() {
  const overlay = document.getElementById('tap-overlay');
  // Create and immediately suspend a context to unlock audio
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const buf = ctx.createBuffer(1,1,22050);
  const src = ctx.createBufferSource();
  src.buffer = buf;
  src.connect(ctx.destination);
  src.start(0);
  ctx.resume();
  audioUnlocked = true;
  overlay.classList.add('hidden');

  // If we already have remote audio waiting, play it
  const audio = document.getElementById('remote-audio');
  if (audio.srcObject) {
    audio.play().catch(()=>{});
  }
}

// ‚îÄ‚îÄ SCREENS
function go(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// ‚îÄ‚îÄ SOCKET
function initSocket() {
  if (socket && socket.connected) return;
  socket = io({transports:['websocket','polling']});
  socket.on('connect', ()=>{
    console.log('Connected:', socket.id);
    if (!amHost) startClockSync();
  });
  socket.on('connect_error', ()=>toast('Connection error ‚Äî refresh'));

  socket.on('pong-time', ({serverTime, clientSendTime})=>{
    const now=Date.now(), rtt=now-clientSendTime;
    const offset=(now+clientSendTime)/2-serverTime;
    syncSamples.push({rtt,offset});
    if (syncSamples.length<6) {
      setTimeout(()=>socket.emit('ping-time',{clientTime:Date.now()}), 80);
    } else {
      syncSamples.sort((a,b)=>a.rtt-b.rtt);
      clockOffset=syncSamples[0].offset;
      console.log('Clock offset:',clockOffset.toFixed(1),'ms');
    }
  });

  // HOST: new listener joined ‚Üí send WebRTC offer
  socket.on('listener-joined', async ({id})=>{
    listeners[id]=true; renderListeners();
    if (localStream) await sendOffer(id);
  });
  socket.on('listener-left', ({id})=>{ delete listeners[id]; renderListeners(); });
  socket.on('listener-count', n=>{ document.getElementById('h-lcount').textContent=n; });

  // LISTENER: receive WebRTC offer from host
  socket.on('offer', async ({from, offer})=>{
    hostPeer = new RTCPeerConnection(ICE);
    hostPeer.ontrack = e => {
      console.log('Got remote track');
      const audio = document.getElementById('remote-audio');
      audio.srcObject = e.streams[0];
      // Try to play ‚Äî if blocked, show tap overlay
      audio.play().then(()=>{
        document.getElementById('tap-overlay').classList.add('hidden');
        audioUnlocked=true;
        onAudioPlaying(e.streams[0]);
      }).catch(()=>{
        // Show tap overlay ‚Äî will play on tap
        document.getElementById('tap-overlay').classList.remove('hidden');
        document.getElementById('tap-overlay').onclick = ()=>{
          audio.play().then(()=>{
            document.getElementById('tap-overlay').classList.add('hidden');
            audioUnlocked=true;
            onAudioPlaying(e.streams[0]);
          });
        };
      });
    };
    hostPeer.onicecandidate = e=>{
      if (e.candidate) socket.emit('ice-candidate',{to:from,candidate:e.candidate});
    };
    hostPeer.onconnectionstatechange = ()=>{
      console.log('Peer state:', hostPeer.connectionState);
      if (hostPeer.connectionState==='connected') updateSyncInfo('‚úÖ Connected to host ‚Äî audio streaming live');
      if (hostPeer.connectionState==='failed') updateSyncInfo('‚ùå Connection failed ‚Äî try refreshing');
    };
    await hostPeer.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await hostPeer.createAnswer();
    await hostPeer.setLocalDescription(answer);
    socket.emit('answer',{to:from,answer});
  });

  socket.on('answer', async ({from,answer})=>{
    if (peers[from]) await peers[from].setRemoteDescription(new RTCSessionDescription(answer));
  });
  socket.on('ice-candidate', async ({from,candidate})=>{
    const pc = amHost ? peers[from] : hostPeer;
    if (pc) await pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(()=>{});
  });

  socket.on('host-left', ()=>{ toast('Host ended the session'); leave(); });
}

function onAudioPlaying(stream) {
  setPill('l-pill','sync','‚óè Live & Synced');
  document.getElementById('l-track-name').textContent = 'Receiving audio from host';
  updateSyncInfo('üéß Audio streaming live ‚Äî auto-synced every 3 seconds');
  startViz(stream, 'l-canvas', true);
}

// ‚îÄ‚îÄ CLOCK SYNC
function startClockSync() {
  syncSamples=[];
  socket.emit('ping-time',{clientTime:Date.now()});
}

// ‚îÄ‚îÄ CREATE ROOM
function createRoom() {
  const name = document.getElementById('rname').value.trim() || 'Audio Room';
  initSocket(); amHost=true;
  socket.emit('create-room',{name},(res)=>{
    if (!res||!res.ok) { toast('Failed to create room'); return; }
    myCode=res.code;
    document.getElementById('h-rname').textContent=res.name;
    document.getElementById('h-code-text').textContent=res.code;
    go('s-host');
    toast('Room created! Code: '+res.code+' üéâ');
  });
}

// ‚îÄ‚îÄ JOIN ROOM
function joinRoom() {
  const code = document.getElementById('code-input').value.trim().toUpperCase();
  if (!code) { toast('Enter a room code'); return; }
  initSocket(); amHost=false;
  socket.emit('join-room',{code},(res)=>{
    if (!res||!res.ok) { document.getElementById('join-err').classList.add('show'); return; }
    document.getElementById('join-err').classList.remove('show');
    myCode=code;
    document.getElementById('l-rname').textContent=res.name;
    document.getElementById('l-code-label').textContent='Code: '+code;
    go('s-listener');
    toast('Joined! Waiting for host to share audio üéß');
  });
}

// ‚îÄ‚îÄ START SHARING (HOST)
async function startShare() {
  try {
    const stream = await navigator.mediaDevices.getDisplayMedia({video:true,audio:true});
    if (!stream.getAudioTracks().length) {
      stream.getTracks().forEach(t=>t.stop());
      toast('‚ö†Ô∏è No audio ‚Äî did you check "Share tab audio"?');
      return;
    }
    // Keep video off to save bandwidth
    stream.getVideoTracks().forEach(t=>t.stop());
    localStream=stream;

    startViz(localStream,'h-canvas',false);
    setPill('h-pill','live','‚óè Live');
    document.getElementById('share-btn').disabled=true;
    document.getElementById('stop-btn').disabled=false;

    // Send to all existing listeners
    for (const id of Object.keys(listeners)) await sendOffer(id);

    localStream.getTracks().forEach(t=>{ t.onended=()=>stopShare(); });
    toast('üéô Streaming live!');
  } catch(e) {
    if (e.name!=='NotAllowedError') toast('Could not capture audio ‚Äî use Chrome');
  }
}

// ‚îÄ‚îÄ SEND OFFER
async function sendOffer(listenerId) {
  if (peers[listenerId]) { peers[listenerId].close(); }
  const pc = new RTCPeerConnection(ICE);
  peers[listenerId]=pc;
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.onicecandidate=e=>{ if(e.candidate) socket.emit('ice-candidate',{to:listenerId,candidate:e.candidate}); };
  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  socket.emit('offer',{to:listenerId,offer});
}

// ‚îÄ‚îÄ STOP SHARING
function stopShare() {
  if (localStream) { localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
  Object.values(peers).forEach(pc=>pc.close()); peers={};
  stopViz();
  setPill('h-pill','wait','Not sharing');
  document.getElementById('share-btn').disabled=false;
  document.getElementById('stop-btn').disabled=true;
  toast('‚èπ Stopped');
}

// ‚îÄ‚îÄ LEAVE
function leave() {
  stopShare();
  if (hostPeer) { hostPeer.close(); hostPeer=null; }
  stopViz();
  const audio=document.getElementById('remote-audio');
  if (audio) { audio.pause(); audio.srcObject=null; }
  if (socket) { socket.disconnect(); socket=null; }
  myCode=null; listeners={};
  go('s-home');
}

// ‚îÄ‚îÄ HELPERS
function setVol(v) { document.getElementById('remote-audio').volume=parseFloat(v); }
function copyCode() {
  navigator.clipboard.writeText(document.getElementById('h-code-text').textContent)
    .then(()=>toast('Code copied! üìã'));
}
function updateSyncInfo(html) {
  document.getElementById('l-sync-info').innerHTML='<strong>Sync Status:</strong> '+html;
}
function setPill(id,type,label) {
  const el=document.getElementById(id);
  const cls={live:'pill-live',wait:'pill-wait',sync:'pill-sync'};
  const dot={live:'dot-g',wait:'dot-m',sync:'dot-c'};
  el.className='pill '+cls[type];
  el.innerHTML='<div class="dot '+dot[type]+'"></div><span>'+label+'</span>';
}
function renderListeners() {
  const ids=Object.keys(listeners);
  const el=document.getElementById('h-llist');
  document.getElementById('h-lcount').textContent=ids.length;
  if (!ids.length) { el.innerHTML='<div class="no-l">No one joined yet ‚Äî share your code!</div>'; return; }
  el.innerHTML=ids.map((id,i)=>'<div class="litem"><div class="lavatar">üéß</div><span>Listener '+(i+1)+'</span><span style="margin-left:auto;font-size:10px;color:var(--green);">‚óè live</span></div>').join('');
}
function toast(msg) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3500);
}

// ‚îÄ‚îÄ VISUALIZER
function startViz(streamOrElement, canvasId, isStream) {
  stopViz();
  try {
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    let src;
    if (isStream) {
      src=audioCtx.createMediaStreamSource(streamOrElement);
    } else {
      src=audioCtx.createMediaStreamSource(streamOrElement);
    }
    analyser=audioCtx.createAnalyser();
    analyser.fftSize=256;
    src.connect(analyser);
    // Don't reconnect to destination ‚Äî audio element handles output
    drawViz(canvasId);
  } catch(e) { console.warn('Viz:',e); }
}
function drawViz(canvasId) {
  const canvas=document.getElementById(canvasId);
  if (!canvas||!analyser) return;
  const ctx=canvas.getContext('2d');
  const W=canvas.offsetWidth||600, H=canvas.offsetHeight||56;
  canvas.width=W; canvas.height=H;
  const buf=new Uint8Array(analyser.frequencyBinCount);
  function frame() {
    raf=requestAnimationFrame(frame);
    analyser.getByteFrequencyData(buf);
    ctx.fillStyle='#07080d'; ctx.fillRect(0,0,W,H);
    const bw=(W/buf.length)*2.2; let x=0;
    for(let i=0;i<buf.length;i++){
      const h=(buf[i]/255)*H;
      ctx.fillStyle='hsla('+(160+i/buf.length*100)+',100%,60%,.9)';
      ctx.fillRect(x,H-h,bw,h); x+=bw+1;
    }
  }
  frame();
}
function stopViz() {
  if (raf){cancelAnimationFrame(raf);raf=null;}
  if (audioCtx){audioCtx.close().catch(()=>{});audioCtx=null;}
}

document.getElementById('code-input').addEventListener('input',function(){
  this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'');
});
</script>
</body>
</html>
