

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WaveRoom â€” Sync Audio With Anyone</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080a0f;
    --surface: #0f1219;
    --border: #1e2433;
    --accent: #00e5ff;
    --accent2: #7c3aed;
    --green: #00ff88;
    --red: #ff3b6b;
    --text: #e8eaf6;
    --muted: #4a5578;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 60px 60px;
    opacity: 0.3;
    pointer-events: none;
    z-index: 0;
  }

  .glow-orb {
    position: fixed;
    border-radius: 50%;
    filter: blur(120px);
    pointer-events: none;
    z-index: 0;
  }
  .glow-orb-1 { width: 500px; height: 500px; background: rgba(0,229,255,0.06); top: -200px; left: -100px; }
  .glow-orb-2 { width: 400px; height: 400px; background: rgba(124,58,237,0.08); bottom: -150px; right: -100px; }

  .container {
    position: relative;
    z-index: 1;
    max-width: 900px;
    margin: 0 auto;
    padding: 40px 24px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* Header */
  header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 60px;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo-icon {
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
  }

  .logo-text {
    font-size: 22px;
    font-weight: 800;
    letter-spacing: -0.5px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* Screens */
  .screen { display: none; }
  .screen.active { display: block; animation: fadeIn 0.3s ease; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Home screen */
  .hero {
    text-align: center;
    padding: 40px 0 60px;
  }

  .hero h1 {
    font-size: clamp(36px, 6vw, 72px);
    font-weight: 800;
    line-height: 1.1;
    letter-spacing: -2px;
    margin-bottom: 20px;
  }

  .hero h1 span {
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .hero p {
    font-size: 18px;
    color: var(--muted);
    max-width: 480px;
    margin: 0 auto 50px;
    line-height: 1.6;
    font-family: 'Space Mono', monospace;
  }

  .cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    max-width: 640px;
    margin: 0 auto;
  }

  @media (max-width: 540px) { .cards { grid-template-columns: 1fr; } }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px 24px;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
  }

  .card::before {
    content: '';
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 0.2s;
    border-radius: 16px;
  }

  .card.host-card::before { background: radial-gradient(circle at 30% 30%, rgba(0,229,255,0.08), transparent 70%); }
  .card.join-card::before { background: radial-gradient(circle at 30% 30%, rgba(124,58,237,0.08), transparent 70%); }

  .card:hover { border-color: rgba(0,229,255,0.3); transform: translateY(-2px); }
  .card:hover::before { opacity: 1; }

  .card-icon { font-size: 32px; margin-bottom: 16px; }
  .card-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
  .card-desc { font-size: 14px; color: var(--muted); font-family: 'Space Mono', monospace; line-height: 1.5; }

  .card-arrow {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 20px;
    color: var(--muted);
    transition: all 0.2s;
  }
  .card:hover .card-arrow { color: var(--accent); transform: translateY(-50%) translateX(4px); }

  /* Forms */
  .form-screen {
    max-width: 480px;
    margin: 0 auto;
  }

  .back-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    cursor: pointer;
    margin-bottom: 40px;
    background: none;
    border: none;
    padding: 0;
    transition: color 0.2s;
  }
  .back-btn:hover { color: var(--accent); }

  .form-title { font-size: 32px; font-weight: 800; margin-bottom: 8px; letter-spacing: -1px; }
  .form-sub { font-size: 14px; color: var(--muted); font-family: 'Space Mono', monospace; margin-bottom: 32px; line-height: 1.6; }

  label { display: block; font-size: 12px; font-weight: 700; letter-spacing: 1px; color: var(--muted); margin-bottom: 8px; text-transform: uppercase; }

  input[type="text"] {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 16px;
    outline: none;
    transition: border-color 0.2s;
    margin-bottom: 24px;
  }
  input[type="text"]:focus { border-color: var(--accent); }
  input[type="text"]::placeholder { color: var(--muted); }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 28px;
    border-radius: 10px;
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    border: none;
    transition: all 0.2s ease;
    width: 100%;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent), #0099bb);
    color: #000;
  }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(0,229,255,0.3); }

  .btn-purple {
    background: linear-gradient(135deg, var(--accent2), #9333ea);
    color: #fff;
  }
  .btn-purple:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(124,58,237,0.4); }

  .btn-danger { background: var(--red); color: #fff; }
  .btn-danger:hover { opacity: 0.85; }

  .btn-ghost {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
  }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }

  .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

  /* Room screen */
  .room-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 32px;
  }

  .room-info { }
  .room-name { font-size: 28px; font-weight: 800; letter-spacing: -0.5px; }
  .room-code-label { font-size: 13px; color: var(--muted); font-family: 'Space Mono', monospace; margin-top: 4px; }

  .room-code-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 14px;
    font-family: 'Space Mono', monospace;
    font-size: 22px;
    font-weight: 700;
    letter-spacing: 4px;
    color: var(--accent);
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 8px;
  }
  .room-code-badge:hover { border-color: var(--accent); }
  .room-code-badge .copy-hint { font-size: 11px; color: var(--muted); letter-spacing: 0; }

  .status-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border-radius: 100px;
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    font-weight: 700;
  }
  .status-pill.streaming { background: rgba(0,255,136,0.1); color: var(--green); border: 1px solid rgba(0,255,136,0.2); }
  .status-pill.waiting { background: rgba(74,85,120,0.2); color: var(--muted); border: 1px solid var(--border); }
  .status-pill.listening { background: rgba(0,229,255,0.1); color: var(--accent); border: 1px solid rgba(0,229,255,0.2); }

  .dot { width: 8px; height: 8px; border-radius: 50%; }
  .dot.green { background: var(--green); animation: pulse 1.5s infinite; }
  .dot.muted { background: var(--muted); }
  .dot.cyan { background: var(--accent); animation: pulse 1.5s infinite; }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }

  /* Waveform visualizer */
  .visualizer-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
  }

  #visualizer {
    width: 100%;
    height: 80px;
    display: block;
  }

  /* Controls */
  .controls-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 20px;
  }

  .controls-title {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted);
    margin-bottom: 16px;
    font-family: 'Space Mono', monospace;
  }

  .controls-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .controls-row .btn { width: auto; flex: 1; min-width: 120px; }

  /* Listeners panel */
  .listeners-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
  }

  .listeners-title {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted);
    margin-bottom: 16px;
    font-family: 'Space Mono', monospace;
    display: flex;
    justify-content: space-between;
  }

  .listener-count { color: var(--accent); }

  .listener-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
    font-family: 'Space Mono', monospace;
    font-size: 13px;
  }
  .listener-item:last-child { border-bottom: none; }

  .listener-avatar {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: linear-gradient(135deg, var(--accent2), var(--accent));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
  }

  .no-listeners {
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    text-align: center;
    padding: 20px 0;
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 32px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 20px;
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    color: var(--text);
    z-index: 999;
    transition: transform 0.3s ease;
    white-space: nowrap;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  /* Error */
  .error-msg {
    background: rgba(255,59,107,0.1);
    border: 1px solid rgba(255,59,107,0.3);
    border-radius: 8px;
    padding: 12px 16px;
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    color: var(--red);
    margin-bottom: 20px;
    display: none;
  }
  .error-msg.show { display: block; }

  /* Instructions */
  .instructions {
    background: rgba(0,229,255,0.05);
    border: 1px solid rgba(0,229,255,0.15);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 20px;
  }
  .instructions p {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    color: var(--muted);
    line-height: 1.8;
  }
  .instructions strong { color: var(--accent); }
</style>
</head>
<body>
<div class="glow-orb glow-orb-1"></div>
<div class="glow-orb glow-orb-2"></div>

<div class="container">
  <header>
    <div class="logo">
      <div class="logo-icon">ğŸŒŠ</div>
      <div class="logo-text">WaveRoom</div>
    </div>
  </header>

  <!-- HOME -->
  <div id="screen-home" class="screen active">
    <div class="hero">
      <h1>Share Audio<br>With <span>Everyone</span></h1>
      <p>Create a room. Share your tab audio. Everyone hears the same thing at the same moment.</p>
      <div class="cards">
        <div class="card host-card" onclick="showScreen('screen-create')">
          <div class="card-icon">ğŸ™</div>
          <div class="card-title">Host a Room</div>
          <div class="card-desc">Share your audio with everyone in the room</div>
          <div class="card-arrow">â†’</div>
        </div>
        <div class="card join-card" onclick="showScreen('screen-join')">
          <div class="card-icon">ğŸ§</div>
          <div class="card-title">Join a Room</div>
          <div class="card-desc">Enter a room code to listen in sync</div>
          <div class="card-arrow">â†’</div>
        </div>
      </div>
    </div>
  </div>

  <!-- CREATE ROOM -->
  <div id="screen-create" class="screen">
    <div class="form-screen">
      <button class="back-btn" onclick="showScreen('screen-home')">â† Back</button>
      <div class="form-title">Host a Room</div>
      <div class="form-sub">You'll share your tab's audio and everyone who joins will hear it live.</div>
      <label>Room Name</label>
      <input type="text" id="room-name-input" placeholder="My Vibe Session" maxlength="40">
      <button class="btn btn-primary" onclick="createRoom()">Create Room â†’</button>
    </div>
  </div>

  <!-- JOIN ROOM -->
  <div id="screen-join" class="screen">
    <div class="form-screen">
      <button class="back-btn" onclick="showScreen('screen-home')">â† Back</button>
      <div class="form-title">Join a Room</div>
      <div class="form-sub">Enter the 6-character room code from your friend.</div>
      <label>Room Code</label>
      <input type="text" id="join-code-input" placeholder="ABC123" maxlength="6" style="text-transform:uppercase;letter-spacing:4px;">
      <div id="join-error" class="error-msg">Room not found. Check the code and try again.</div>
      <button class="btn btn-purple" onclick="joinRoom()">Join Room â†’</button>
    </div>
  </div>

  <!-- HOST ROOM -->
  <div id="screen-host-room" class="screen">
    <div class="room-header">
      <div class="room-info">
        <div class="room-name" id="host-room-name">Room</div>
        <div class="room-code-badge" id="host-room-code" onclick="copyCode()" title="Click to copy">
          <span id="host-code-text">------</span>
          <span class="copy-hint">copy</span>
        </div>
      </div>
      <div id="host-status" class="status-pill waiting">
        <div class="dot muted"></div>
        <span>Not Streaming</span>
      </div>
    </div>

    <div class="instructions">
      <p>
        <strong>How to share audio:</strong><br>
        1. Click <strong>Start Sharing</strong> below<br>
        2. A browser dialog appears â€” select a <strong>Browser Tab</strong><br>
        3. âœ… Check <strong>"Share tab audio"</strong><br>
        4. Everyone in the room hears it instantly
      </p>
    </div>

    <div class="visualizer-wrap">
      <canvas id="visualizer"></canvas>
    </div>

    <div class="controls-panel">
      <div class="controls-title">Audio Controls</div>
      <div class="controls-row">
        <button id="share-btn" class="btn btn-primary" onclick="startSharing()">ğŸ™ Start Sharing</button>
        <button id="stop-btn" class="btn btn-danger" onclick="stopSharing()" disabled>â¹ Stop</button>
      </div>
    </div>

    <div class="listeners-panel">
      <div class="listeners-title">
        <span>Connected Listeners</span>
        <span class="listener-count" id="listener-count">0</span>
      </div>
      <div id="listeners-list">
        <div class="no-listeners">No one has joined yet. Share your room code!</div>
      </div>
    </div>

    <div style="margin-top:20px;">
      <button class="btn btn-ghost" onclick="leaveRoom()">Leave Room</button>
    </div>
  </div>

  <!-- LISTENER ROOM -->
  <div id="screen-listener-room" class="screen">
    <div class="room-header">
      <div class="room-info">
        <div class="room-name" id="listener-room-name">Room</div>
        <div class="room-code-label" id="listener-room-code" style="font-family:'Space Mono';color:var(--muted);"></div>
      </div>
      <div id="listener-status" class="status-pill waiting">
        <div class="dot muted"></div>
        <span>Waiting for host...</span>
      </div>
    </div>

    <div class="visualizer-wrap">
      <canvas id="visualizer-listener"></canvas>
    </div>

    <div style="margin-top:20px;">
      <audio id="remote-audio" autoplay></audio>
    </div>

    <div class="controls-panel">
      <div class="controls-title">You are listening</div>
      <div style="font-family:'Space Mono';font-size:13px;color:var(--muted);line-height:1.8;">
        Audio from the host will play automatically when they start sharing.<br>
        Make sure your device volume is on. ğŸ”Š
      </div>
    </div>

    <div style="margin-top:20px;">
      <button class="btn btn-ghost" onclick="leaveRoom()">Leave Room</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STUN = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let socket, currentRoom, isHost;
let localStream = null;
let peerConnections = {}; // listenerId â†’ RTCPeerConnection (host)
let hostConnection = null; // RTCPeerConnection (listener)
let audioCtx, analyser, animFrame;

// â”€â”€â”€ SOCKET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initSocket() {
  if (socket && socket.connected) return;
  socket = io();

  socket.on('listener-joined', async ({ listenerId }) => {
    addListenerToUI(listenerId);
    if (localStream) {
      await sendOfferToListener(listenerId);
    }
  });

  socket.on('listener-left', ({ listenerId }) => {
    removeListenerFromUI(listenerId);
    if (peerConnections[listenerId]) {
      peerConnections[listenerId].close();
      delete peerConnections[listenerId];
    }
  });

  socket.on('offer', async ({ from, offer }) => {
    // Listener receives offer from host
    hostConnection = new RTCPeerConnection(STUN);
    hostConnection.ontrack = (e) => {
      const audio = document.getElementById('remote-audio');
      audio.srcObject = e.streams[0];
      startListenerVisualizer(e.streams[0]);
      setListenerStatus('listening');
    };
    hostConnection.onicecandidate = (e) => {
      if (e.candidate) socket.emit('ice-candidate', { to: from, candidate: e.candidate });
    };
    await hostConnection.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await hostConnection.createAnswer();
    await hostConnection.setLocalDescription(answer);
    socket.emit('answer', { to: from, answer });
  });

  socket.on('answer', async ({ from, answer }) => {
    if (peerConnections[from]) {
      await peerConnections[from].setRemoteDescription(new RTCSessionDescription(answer));
    }
  });

  socket.on('ice-candidate', async ({ from, candidate }) => {
    if (isHost && peerConnections[from]) {
      await peerConnections[from].addIceCandidate(new RTCIceCandidate(candidate));
    } else if (!isHost && hostConnection) {
      await hostConnection.addIceCandidate(new RTCIceCandidate(candidate));
    }
  });

  socket.on('host-left', () => {
    showToast('Host ended the session');
    leaveRoom();
  });
}

// â”€â”€â”€ HOST: Send offer to new listener â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendOfferToListener(listenerId) {
  const pc = new RTCPeerConnection(STUN);
  peerConnections[listenerId] = pc;

  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  pc.onicecandidate = (e) => {
    if (e.candidate) socket.emit('ice-candidate', { to: listenerId, candidate: e.candidate });
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  socket.emit('offer', { to: listenerId, offer });
}

// â”€â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// â”€â”€â”€ CREATE ROOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createRoom() {
  const name = document.getElementById('room-name-input').value.trim() || 'Audio Room';
  initSocket();
  isHost = true;
  socket.emit('create-room', { name }, ({ code, room }) => {
    currentRoom = code;
    document.getElementById('host-room-name').textContent = room.name;
    document.getElementById('host-code-text').textContent = code;
    showScreen('screen-host-room');
    showToast('Room created! Share the code ğŸ‰');
  });
}

// â”€â”€â”€ JOIN ROOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function joinRoom() {
  const code = document.getElementById('join-code-input').value.trim().toUpperCase();
  if (!code) return;
  initSocket();
  isHost = false;
  socket.emit('join-room', { code }, ({ error, room }) => {
    if (error) {
      document.getElementById('join-error').classList.add('show');
      return;
    }
    document.getElementById('join-error').classList.remove('show');
    currentRoom = code;
    document.getElementById('listener-room-name').textContent = room.name;
    document.getElementById('listener-room-code').textContent = `Room code: ${code}`;
    showScreen('screen-listener-room');
    showToast('Joined! Waiting for host to share... ğŸ§');
  });
}

// â”€â”€â”€ START SHARING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startSharing() {
  try {
    localStream = await navigator.mediaDevices.getDisplayMedia({
      video: true,
      audio: true
    });

    // Remove video tracks â€” audio only
    localStream.getVideoTracks().forEach(t => t.stop());

    // Start visualizer
    startHostVisualizer(localStream);

    // Update UI
    document.getElementById('share-btn').disabled = true;
    document.getElementById('stop-btn').disabled = false;
    setHostStatus('streaming');

    // Send to existing listeners
    for (const lid of Object.keys(peerConnections)) {
      peerConnections[lid].close();
      delete peerConnections[lid];
    }

    // Re-emit offer to all current listeners (they'll re-request via server)
    socket.emit('host-streaming', { code: currentRoom });

    localStream.getTracks()[0].onended = () => stopSharing();

    showToast('ğŸ™ Streaming started!');
  } catch (e) {
    if (e.name !== 'NotAllowedError') {
      showToast('Could not capture audio. Try again.');
    }
  }
}

// â”€â”€â”€ STOP SHARING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function stopSharing() {
  if (localStream) {
    localStream.getTracks().forEach(t => t.stop());
    localStream = null;
  }
  Object.values(peerConnections).forEach(pc => pc.close());
  peerConnections = {};
  stopVisualizer();
  document.getElementById('share-btn').disabled = false;
  document.getElementById('stop-btn').disabled = true;
  setHostStatus('waiting');
  showToast('â¹ Streaming stopped');
}

// â”€â”€â”€ LEAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function leaveRoom() {
  stopSharing();
  if (hostConnection) { hostConnection.close(); hostConnection = null; }
  if (socket) socket.disconnect();
  socket = null;
  currentRoom = null;
  stopVisualizer();
  showScreen('screen-home');
}

// â”€â”€â”€ UI HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setHostStatus(state) {
  const el = document.getElementById('host-status');
  if (state === 'streaming') {
    el.className = 'status-pill streaming';
    el.innerHTML = '<div class="dot green"></div><span>Live</span>';
  } else {
    el.className = 'status-pill waiting';
    el.innerHTML = '<div class="dot muted"></div><span>Not Streaming</span>';
  }
}

function setListenerStatus(state) {
  const el = document.getElementById('listener-status');
  if (state === 'listening') {
    el.className = 'status-pill listening';
    el.innerHTML = '<div class="dot cyan"></div><span>Receiving audio</span>';
  } else {
    el.className = 'status-pill waiting';
    el.innerHTML = '<div class="dot muted"></div><span>Waiting for host...</span>';
  }
}

let listeners = {};
function addListenerToUI(id) {
  listeners[id] = true;
  renderListeners();
}
function removeListenerFromUI(id) {
  delete listeners[id];
  renderListeners();
}
function renderListeners() {
  const count = Object.keys(listeners).length;
  document.getElementById('listener-count').textContent = count;
  const el = document.getElementById('listeners-list');
  if (count === 0) {
    el.innerHTML = '<div class="no-listeners">No one has joined yet. Share your room code!</div>';
  } else {
    el.innerHTML = Object.keys(listeners).map((id, i) => `
      <div class="listener-item">
        <div class="listener-avatar">ğŸ§</div>
        <span>Listener ${i + 1}</span>
        <span style="margin-left:auto;font-size:11px;color:var(--green);">â— Connected</span>
      </div>
    `).join('');
  }
}

function copyCode() {
  const code = document.getElementById('host-code-text').textContent;
  navigator.clipboard.writeText(code).then(() => showToast('Code copied! ğŸ“‹'));
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// â”€â”€â”€ VISUALIZER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startHostVisualizer(stream) {
  setupVisualizer(stream, document.getElementById('visualizer'));
}
function startListenerVisualizer(stream) {
  setupVisualizer(stream, document.getElementById('visualizer-listener'));
}

function setupVisualizer(stream, canvas) {
  if (audioCtx) audioCtx.close();
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const source = audioCtx.createMediaStreamSource(stream);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  source.connect(analyser);
  drawVisualizer(canvas);
}

function drawVisualizer(canvas) {
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth;
  const H = canvas.offsetHeight;
  canvas.width = W;
  canvas.height = H;
  const bufLen = analyser.frequencyBinCount;
  const dataArr = new Uint8Array(bufLen);

  function draw() {
    animFrame = requestAnimationFrame(draw);
    analyser.getByteFrequencyData(dataArr);
    ctx.fillStyle = '#0f1219';
    ctx.fillRect(0, 0, W, H);
    const barW = (W / bufLen) * 2.5;
    let x = 0;
    for (let i = 0; i < bufLen; i++) {
      const barH = (dataArr[i] / 255) * H;
      const hue = (i / bufLen) * 180 + 160; // cyan to purple
      ctx.fillStyle = `hsla(${hue},100%,60%,0.85)`;
      ctx.fillRect(x, H - barH, barW, barH);
      x += barW + 1;
    }
  }
  draw();
}

function stopVisualizer() {
  if (animFrame) cancelAnimationFrame(animFrame);
  if (audioCtx) { audioCtx.close(); audioCtx = null; }
}

// Input uppercase for code
document.getElementById('join-code-input').addEventListener('input', function() {
  this.value = this.value.toUpperCase();
});
</script>
</body>
</html>
