<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>WaveRoom â€” AI Spatial Sync Audio</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#06070c;--s:#0b0d17;--b:#161b2e;--c:#00e5ff;--p:#8b5cf6;--g:#00ff88;--r:#ff4466;--t:#e8edf8;--m:#4a5578;--gold:#ffd700;--warn:#ff9800}
html,body{background:var(--bg);color:var(--t);font-family:'Syne',sans-serif;min-height:100vh;overscroll-behavior:none;-webkit-tap-highlight-color:transparent}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(var(--b) 1px,transparent 1px),linear-gradient(90deg,var(--b) 1px,transparent 1px);background-size:48px 48px;opacity:.08;pointer-events:none;z-index:0}
#app{position:relative;z-index:1;max-width:820px;margin:0 auto;padding:24px 16px 80px}
.nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:40px}
.nav-left{display:flex;align-items:center;gap:10px}
.nav-icon{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,var(--c),var(--p));display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 0 20px rgba(0,229,255,.15)}
.nav-name{font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--c),var(--p));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.nav-badge{font-family:'Space Mono',monospace;font-size:8px;color:var(--gold);border:1px solid rgba(255,215,0,.25);border-radius:20px;padding:3px 9px;background:rgba(255,215,0,.06);letter-spacing:.5px}
.nav-status{display:flex;align-items:center;gap:5px;font-family:'Space Mono',monospace;font-size:9px;color:var(--m)}
.nav-dot{width:7px;height:7px;border-radius:50%;background:var(--m);flex-shrink:0;transition:background .4s}
.nav-dot.online{background:var(--g);box-shadow:0 0 8px rgba(0,255,136,.4);animation:blk 1.8s infinite}
@keyframes blk{0%,100%{opacity:1}50%{opacity:.3}}
.screen{display:none}.screen.on{display:block;animation:fadeUp .25s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.hero{text-align:center;padding:8px 0 32px}
.hero-chip{display:inline-flex;align-items:center;gap:6px;font-family:'Space Mono',monospace;font-size:10px;color:var(--c);border:1px solid rgba(0,229,255,.18);border-radius:20px;padding:4px 13px;margin-bottom:18px;background:rgba(0,229,255,.05)}
.hero h1{font-size:clamp(28px,6.5vw,58px);font-weight:800;letter-spacing:-2px;line-height:1.05;margin-bottom:14px}
.hero h1 em{font-style:normal;background:linear-gradient(135deg,var(--c),var(--p));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero-sub{font-family:'Space Mono',monospace;font-size:11.5px;color:var(--m);max-width:400px;margin:0 auto 32px;line-height:1.9}
.home-cards{display:grid;grid-template-columns:1fr 1fr;gap:12px;max-width:520px;margin:0 auto 28px}
@media(max-width:440px){.home-cards{grid-template-columns:1fr}}
.hcard{background:var(--s);border:1px solid var(--b);border-radius:14px;padding:22px 18px;cursor:pointer;text-align:left;transition:all .25s;overflow:hidden;position:relative}
.hcard:hover{border-color:rgba(0,229,255,.4);transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,229,255,.08)}
.hi{font-size:26px;margin-bottom:10px}.ht{font-size:15px;font-weight:700;margin-bottom:5px}
.hd{font-size:11px;color:var(--m);font-family:'Space Mono',monospace;line-height:1.6}
.feature-strip{display:flex;justify-content:center;gap:18px;flex-wrap:wrap;max-width:520px;margin:0 auto}
.feat{display:flex;align-items:center;gap:5px;font-family:'Space Mono',monospace;font-size:10px;color:var(--m)}
.ai-features{margin:24px auto 0;max-width:520px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media(max-width:440px){.ai-features{grid-template-columns:1fr}}
.ai-feat{background:rgba(255,215,0,.03);border:1px solid rgba(255,215,0,.1);border-radius:10px;padding:14px 12px;text-align:center}
.ai-feat-icon{font-size:20px;margin-bottom:6px}
.ai-feat-title{font-family:'Space Mono',monospace;font-size:10px;font-weight:700;color:var(--gold);margin-bottom:3px}
.ai-feat-desc{font-family:'Space Mono',monospace;font-size:9px;color:var(--m);line-height:1.5}
.fbox{max-width:400px;margin:0 auto}
.back{background:none;border:none;color:var(--m);font-family:'Space Mono',monospace;font-size:11px;cursor:pointer;margin-bottom:26px;padding:0;transition:color .2s}
.back:hover{color:var(--c)}
.ftitle{font-size:28px;font-weight:800;letter-spacing:-1px;margin-bottom:5px}
.fsub{font-family:'Space Mono',monospace;font-size:11px;color:var(--m);margin-bottom:22px;line-height:1.75}
.fl{display:block;font-size:9px;font-weight:700;letter-spacing:1.4px;text-transform:uppercase;color:var(--m);margin-bottom:6px}
.fi{width:100%;background:var(--s);border:1px solid var(--b);border-radius:9px;padding:12px 14px;color:var(--t);font-family:'Space Mono',monospace;font-size:13px;outline:none;transition:border-color .2s,box-shadow .2s;margin-bottom:13px}
.fi:focus{border-color:var(--c);box-shadow:0 0 0 3px rgba(0,229,255,.08)}
.fi::placeholder{color:var(--m)}
#join-code{letter-spacing:6px;font-size:22px;text-transform:uppercase;text-align:center;padding:14px}
.btn{width:100%;padding:13px;border-radius:9px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;border:none;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:7px;letter-spacing:.3px}
.bc{background:linear-gradient(135deg,var(--c),#00b8d9);color:#000}
.bc:hover{box-shadow:0 6px 24px rgba(0,229,255,.32);transform:translateY(-1px)}
.bp{background:linear-gradient(135deg,var(--p),#6d28d9);color:#fff}
.bp:hover{box-shadow:0 6px 24px rgba(139,92,246,.32);transform:translateY(-1px)}
.bg{background:var(--s);border:1px solid var(--b);color:var(--t)}
.bg:hover{border-color:rgba(0,229,255,.4);color:var(--c)}
.br{background:rgba(255,68,102,.1);border:1px solid rgba(255,68,102,.25);color:var(--r)}
.btn:disabled{opacity:.25;cursor:not-allowed;transform:none!important;box-shadow:none!important}
.brow{display:flex;gap:8px}.brow .btn{flex:1;padding:10px 6px;font-size:12px}
.ferr{background:rgba(255,68,102,.08);border:1px solid rgba(255,68,102,.25);border-radius:8px;padding:10px 13px;font-family:'Space Mono',monospace;font-size:11px;color:var(--r);margin-bottom:12px;display:none;line-height:1.6}
.ferr.on{display:block}
.rhead{display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:15px}
.rname{font-size:21px;font-weight:800;letter-spacing:-.5px}
.rcode{display:inline-flex;align-items:center;gap:7px;margin-top:5px;background:var(--s);border:1px solid var(--b);border-radius:8px;padding:6px 12px;font-family:'Space Mono',monospace;font-size:18px;font-weight:700;letter-spacing:5px;color:var(--c);cursor:pointer;transition:all .2s;user-select:none}
.rcode:hover{border-color:var(--c)}
.rcode small{font-size:9px;color:var(--m);letter-spacing:0;font-weight:400}
.pill{display:inline-flex;align-items:center;gap:6px;padding:5px 11px;border-radius:100px;font-family:'Space Mono',monospace;font-size:10px;font-weight:700;white-space:nowrap}
.pl{background:rgba(0,255,136,.08);color:var(--g);border:1px solid rgba(0,255,136,.2)}
.pw{background:rgba(74,85,120,.1);color:var(--m);border:1px solid var(--b)}
.ps{background:rgba(0,229,255,.08);color:var(--c);border:1px solid rgba(0,229,255,.2)}
.pai{background:rgba(255,215,0,.08);color:var(--gold);border:1px solid rgba(255,215,0,.2)}
.dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.dg{background:var(--g);animation:blk 1.3s infinite}.dm{background:var(--m)}.dc{background:var(--c);animation:blk 1.3s infinite}.dgold{background:var(--gold);animation:blk 1.3s infinite}
.panel{background:var(--s);border:1px solid var(--b);border-radius:13px;padding:16px;margin-bottom:11px;position:relative;overflow:hidden}
.ptitle{font-size:9px;text-transform:uppercase;letter-spacing:1.3px;color:var(--m);font-family:'Space Mono',monospace;margin-bottom:11px}
.dbadge{position:absolute;top:13px;right:13px;font-family:'Space Mono',monospace;font-size:8px;font-weight:700;color:var(--gold);border:1px solid rgba(255,215,0,.2);border-radius:4px;padding:2px 6px;background:rgba(255,215,0,.05);letter-spacing:.8px}
.load-panel{background:var(--s);border:1px solid var(--b);border-radius:13px;padding:16px;margin-bottom:11px}
.src-tabs{display:flex;gap:6px;margin-bottom:13px}
.src-tab{flex:1;padding:8px 5px;border-radius:8px;font-family:'Space Mono',monospace;font-size:10px;font-weight:700;cursor:pointer;border:1px solid var(--b);background:transparent;color:var(--m);transition:all .18s;text-align:center}
.src-tab.active{background:rgba(0,229,255,.08);color:var(--c);border-color:rgba(0,229,255,.3)}
.src-pane{display:none}.src-pane.on{display:block}
.url-row{display:flex;gap:8px}.url-row .fi{margin-bottom:0;flex:1;font-size:11.5px}.url-row .btn{width:auto;padding:12px 16px;white-space:nowrap;font-size:12px}
.load-status{display:flex;align-items:center;gap:7px;margin-top:10px;font-family:'Space Mono',monospace;font-size:11px;min-height:22px;color:var(--m);line-height:1.5}
.spin{display:inline-block;animation:rot .7s linear infinite}
@keyframes rot{to{transform:rotate(360deg)}}
.tinfo{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.tart{width:48px;height:48px;border-radius:12px;flex-shrink:0;background:linear-gradient(135deg,var(--p),var(--c));display:flex;align-items:center;justify-content:center;font-size:22px;animation:rot 12s linear infinite;animation-play-state:paused}
.tart.spinning{animation-play-state:running}
.tname{font-size:13.5px;font-weight:700;word-break:break-word;line-height:1.35}
.tsub{font-family:'Space Mono',monospace;font-size:10px;color:var(--m);margin-top:3px}
.seekbar{padding:6px 0;cursor:pointer;margin-bottom:5px;user-select:none;touch-action:none}
.seek-track{width:100%;height:5px;background:var(--b);border-radius:10px;position:relative;overflow:hidden}
.seek-fill{height:100%;width:0%;border-radius:10px;transition:width .15s linear;background:linear-gradient(90deg,var(--c),var(--p))}
.seek-buffer{position:absolute;top:0;left:0;height:100%;background:rgba(255,255,255,.05);border-radius:10px;transition:width .3s}
.seek-times{display:flex;justify-content:space-between;font-family:'Space Mono',monospace;font-size:9px;color:var(--m);margin-top:5px}
.vol{display:flex;align-items:center;gap:8px;margin-top:11px}
.vol-lbl{font-family:'Space Mono',monospace;font-size:10px;color:var(--m);white-space:nowrap}
input[type=range]{flex:1;accent-color:var(--c);cursor:pointer;height:18px}
.eq-section{margin-top:13px;padding:12px 13px;background:rgba(0,0,0,.25);border:1px solid rgba(255,215,0,.1);border-radius:9px}
.eq-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:6px}
.eq-title{font-family:'Space Mono',monospace;font-size:9px;color:var(--gold);text-transform:uppercase;letter-spacing:1px;display:flex;align-items:center;gap:5px}
.eq-ai-badge{font-family:'Space Mono',monospace;font-size:7px;background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.2);color:var(--gold);padding:1px 5px;border-radius:3px;letter-spacing:.8px}
.eq-auto-toggle{display:flex;align-items:center;gap:6px;cursor:pointer;font-family:'Space Mono',monospace;font-size:9px;color:var(--m);transition:color .2s}
.eq-auto-toggle:hover{color:var(--gold)}
.eq-auto-toggle.active{color:var(--gold)}
.eq-auto-toggle .toggle-track{width:28px;height:14px;border-radius:7px;background:var(--b);position:relative;transition:background .2s}
.eq-auto-toggle.active .toggle-track{background:rgba(255,215,0,.3)}
.eq-auto-toggle .toggle-thumb{width:10px;height:10px;border-radius:50%;background:var(--m);position:absolute;top:2px;left:2px;transition:all .2s}
.eq-auto-toggle.active .toggle-thumb{background:var(--gold);left:16px}
.eq-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:5px;margin-bottom:8px}
.eq-btn{padding:7px 3px;border-radius:6px;font-family:'Space Mono',monospace;font-size:9px;font-weight:700;cursor:pointer;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.02);color:var(--m);transition:all .15s;text-align:center;line-height:1.4}
.eq-btn:hover,.eq-btn.on{background:rgba(255,215,0,.1);color:var(--gold);border-color:rgba(255,215,0,.3)}
.eq-btn.ai-selected{box-shadow:0 0 8px rgba(0,229,255,.15)}
.spatial-indicator{display:flex;align-items:center;gap:6px;margin-top:8px;font-family:'Space Mono',monospace;font-size:9px;color:var(--m)}
.spatial-bar{flex:1;height:3px;background:var(--b);border-radius:10px;overflow:hidden}
.spatial-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--c),var(--gold));transition:width .5s ease;border-radius:10px}
.ai-analysis{margin-top:10px;padding:8px 10px;background:rgba(0,229,255,.03);border:1px solid rgba(0,229,255,.08);border-radius:7px;display:none}
.ai-analysis.on{display:block}
.ai-row{display:flex;justify-content:space-between;align-items:center;font-family:'Space Mono',monospace;font-size:9px;padding:2px 0}
.ai-label{color:var(--m)}.ai-value{color:var(--c);font-weight:700}.ai-value.gold{color:var(--gold)}
canvas{width:100%;height:68px;display:block;border-radius:8px;background:var(--bg)}
.lcnt{color:var(--c);font-weight:700}
.nol{font-family:'Space Mono',monospace;font-size:11px;color:var(--m);text-align:center;padding:13px 0;line-height:1.6}
.litem{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,.04);font-family:'Space Mono',monospace;font-size:11px}
.litem:last-child{border:none}
.lav{width:26px;height:26px;border-radius:6px;background:linear-gradient(135deg,var(--p),var(--c));display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
.sbox{background:rgba(0,229,255,.03);border:1px solid rgba(0,229,255,.1);border-radius:9px;padding:10px 13px;font-family:'Space Mono',monospace;font-size:11px;color:var(--m);line-height:1.9}
.sbox b{color:var(--c)}
.latency-row{display:flex;gap:14px;margin-top:10px;flex-wrap:wrap}
.latency-item{font-family:'Space Mono',monospace;font-size:9px;display:flex;flex-direction:column;gap:2px}
.latency-val{font-size:14px;font-weight:700;color:var(--c)}
.latency-lbl{color:var(--m);font-size:8px;letter-spacing:.5px;text-transform:uppercase}
.toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%) translateY(90px);background:#12161f;border:1px solid rgba(255,255,255,.1);border-radius:9px;padding:10px 18px;font-family:'Space Mono',monospace;font-size:11px;z-index:9999;transition:transform .28s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;max-width:92vw;text-align:center;pointer-events:none;box-shadow:0 8px 32px rgba(0,0,0,.5)}
.toast.on{transform:translateX(-50%) translateY(0)}
#unlock{position:fixed;inset:0;background:rgba(6,7,12,.97);z-index:1000;display:none;flex-direction:column;align-items:center;justify-content:center;gap:14px;cursor:pointer;backdrop-filter:blur(12px)}
#unlock.show{display:flex}
.ui{font-size:56px;animation:tapA 1.4s infinite ease-in-out}
@keyframes tapA{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
.ut{font-size:22px;font-weight:800}.us{font-family:'Space Mono',monospace;font-size:11px;color:var(--m);text-align:center;max-width:260px;line-height:1.7}
</style>
</head>
<body>

<div id="unlock">
  <div class="ui">ğŸ§</div>
  <div class="ut">Tap to Enable Audio</div>
  <div class="us">Your browser needs a tap before audio can play</div>
</div>

<div id="app">
  <div class="nav">
    <div class="nav-left">
      <div class="nav-icon">ğŸŒŠ</div>
      <div class="nav-name">WaveRoom</div>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="nav-status"><div class="nav-dot" id="conn-dot"></div><span id="conn-label">Offline</span></div>
      <div class="nav-badge">âœ¦ NEURAL AI</div>
    </div>
  </div>

  <div id="s-home" class="screen on">
    <div class="hero">
      <div class="hero-chip">ğŸ§  Neural Audio Engine Â· Zero-Lag Sync</div>
      <h1>One Audio.<br><em>Every Device.</em><br>Same Moment.</h1>
      <p class="hero-sub">AI analyzes your music in real-time, auto-tunes spatial audio, and keeps every listener perfectly synced.</p>
      <div class="home-cards">
        <div class="hcard" onclick="show('s-create')"><div class="hi">ğŸ™</div><div class="ht">Host a Room</div><div class="hd">Load YouTube or any audio. AI optimizes sound for everyone.</div></div>
        <div class="hcard" onclick="show('s-join')"><div class="hi">ğŸ§</div><div class="ht">Join a Room</div><div class="hd">Enter 6-letter code. Neural spatial audio syncs automatically.</div></div>
      </div>
      <div class="feature-strip">
        <div class="feat">ğŸ§  Neural EQ</div><div class="feat">âš¡ &lt;50ms Sync</div><div class="feat">ğŸµ YouTube</div><div class="feat">ğŸ”Š 3D Spatial</div>
      </div>
      <div class="ai-features">
        <div class="ai-feat"><div class="ai-feat-icon">ğŸ§ </div><div class="ai-feat-title">Genre Detection</div><div class="ai-feat-desc">Neural net identifies genre in real-time</div></div>
        <div class="ai-feat"><div class="ai-feat-icon">ğŸ›</div><div class="ai-feat-title">Auto EQ</div><div class="ai-feat-desc">AI selects optimal spatial preset</div></div>
        <div class="ai-feat"><div class="ai-feat-icon">ğŸ“Š</div><div class="ai-feat-title">Live Analysis</div><div class="ai-feat-desc">Spectral analysis with peak detection</div></div>
      </div>
    </div>
  </div>

  <div id="s-create" class="screen">
    <div class="fbox">
      <button class="back" onclick="show('s-home')">â† Back</button>
      <div class="ftitle">Host a Room</div>
      <div class="fsub">Create a room. Load any audio. AI optimizes sound for everyone.</div>
      <label class="fl">Room Name (optional)</label>
      <input class="fi" id="rname-input" type="text" placeholder="Friday Night Session" maxlength="40">
      <button class="btn bc" onclick="createRoom()">Create Room â†’</button>
    </div>
  </div>

  <div id="s-join" class="screen">
    <div class="fbox">
      <button class="back" onclick="show('s-home')">â† Back</button>
      <div class="ftitle">Join a Room</div>
      <div class="fsub">Enter the 6-letter code from the host.</div>
      <label class="fl">Room Code</label>
      <input class="fi" id="join-code" type="text" placeholder="ABC123" maxlength="6" autocomplete="off" spellcheck="false">
      <div class="ferr" id="join-err"></div>
      <button class="btn bp" onclick="joinRoom()">Join Room â†’</button>
    </div>
  </div>

  <div id="s-host" class="screen">
    <div class="rhead">
      <div>
        <div class="rname" id="h-rname">Room</div>
        <div class="rcode" onclick="copyCode()"><span id="h-code">------</span><small>tap to copy</small></div>
      </div>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
        <div id="h-pill" class="pill pw"><div class="dot dm"></div><span>Ready</span></div>
        <div id="h-ai-pill" class="pill pai" style="display:none"><div class="dot dgold"></div><span>AI Active</span></div>
      </div>
    </div>

    <div class="load-panel">
      <div class="ptitle">Load Audio</div>
      <div class="src-tabs">
        <button class="src-tab active" id="tab-youtube" onclick="switchTab('youtube')">â–¶ YouTube</button>
        <button class="src-tab" id="tab-url" onclick="switchTab('url')">ğŸ”— URL</button>
        <button class="src-tab" id="tab-file" onclick="switchTab('file')">ğŸ“ File</button>
      </div>
      <div class="src-pane on" id="pane-youtube">
        <div class="url-row">
          <input class="fi" id="yt-url" type="url" placeholder="Paste YouTube URL..." autocomplete="off">
          <button class="btn bc" id="yt-btn" onclick="loadYoutube()">Load</button>
        </div>
        <div class="load-status" id="yt-status"></div>
      </div>
      <div class="src-pane" id="pane-url">
        <div class="url-row">
          <input class="fi" id="direct-url" type="url" placeholder="https://example.com/audio.mp3">
          <button class="btn bc" onclick="loadDirectUrl()">Load</button>
        </div>
        <div class="load-status" id="url-status"></div>
      </div>
      <div class="src-pane" id="pane-file">
        <button class="btn bg" onclick="$('file-input').click()" style="margin-bottom:9px">ğŸ“ Choose File</button>
        <input type="file" id="file-input" accept="audio/*,video/*" style="display:none" onchange="loadFile()">
        <div style="font-family:'Space Mono',monospace;font-size:10px;color:var(--m);line-height:1.65;padding:8px 0">âš ï¸ Local files only play on your device.</div>
        <div class="load-status" id="file-status"></div>
      </div>
    </div>

    <div class="panel" id="h-player" style="display:none">
      <div class="dbadge">NEURAL AI âœ¦</div>
      <div class="tinfo">
        <div class="tart" id="h-art">ğŸµ</div>
        <div style="flex:1;min-width:0">
          <div class="tname" id="h-tname">â€”</div>
          <div class="tsub" id="h-tsub">Loading...</div>
        </div>
      </div>
      <div class="seekbar" id="h-seekbar">
        <div class="seek-track"><div class="seek-buffer" id="h-buffer"></div><div class="seek-fill" id="h-fill"></div></div>
        <div class="seek-times"><span id="h-cur">0:00</span><span id="h-dur">0:00</span></div>
      </div>
      <div class="brow" style="margin-top:11px">
        <button class="btn bc" id="h-play-btn" onclick="hostPlay()" disabled>â–¶ Play</button>
        <button class="btn bg" onclick="hostPause()">â¸ Pause</button>
        <button class="btn bg" onclick="hostRestart()">â® Start</button>
      </div>
      <div class="vol">
        <span class="vol-lbl">ğŸ”Š</span>
        <input type="range" min="0" max="1" step="0.01" value="0.85" id="h-vol" oninput="setVol('h',this.value)">
        <span style="font-family:'Space Mono',monospace;font-size:10px;color:var(--m)" id="h-vol-val">85%</span>
      </div>
      <div class="eq-section">
        <div class="eq-header">
          <div class="eq-title">ğŸ§  Neural Spatial <span class="eq-ai-badge">AI</span></div>
          <div class="eq-auto-toggle" id="h-auto-eq" onclick="toggleAutoEQ('h')"><span>Auto</span><div class="toggle-track"><div class="toggle-thumb"></div></div></div>
        </div>
        <div class="eq-grid">
          <button class="eq-btn on" id="heq-flat" onclick="manualEQ(this,'h')">Flat</button>
          <button class="eq-btn" id="heq-atmos" onclick="manualEQ(this,'h')">Atmos</button>
          <button class="eq-btn" id="heq-cinema" onclick="manualEQ(this,'h')">Cinema</button>
          <button class="eq-btn" id="heq-bass" onclick="manualEQ(this,'h')">Bass+</button>
          <button class="eq-btn" id="heq-vocal" onclick="manualEQ(this,'h')">Vocal</button>
        </div>
        <div class="spatial-indicator">
          <span>Spatial Depth</span>
          <div class="spatial-bar"><div class="spatial-fill" id="h-spatial-fill"></div></div>
          <span id="h-spatial-val">0%</span>
        </div>
        <div class="ai-analysis" id="h-ai-info">
          <div class="ai-row"><span class="ai-label">Genre</span><span class="ai-value" id="h-ai-genre">â€”</span></div>
          <div class="ai-row"><span class="ai-label">Mood</span><span class="ai-value" id="h-ai-mood">â€”</span></div>
          <div class="ai-row"><span class="ai-label">Confidence</span><span class="ai-value gold" id="h-ai-conf">â€”</span></div>
          <div class="ai-row"><span class="ai-label">Suggested</span><span class="ai-value gold" id="h-ai-preset">â€”</span></div>
          <div class="ai-row"><span class="ai-label">Centroid</span><span class="ai-value" id="h-ai-centroid">â€”</span></div>
          <div class="ai-row"><span class="ai-label">Energy</span><span class="ai-value" id="h-ai-rms">â€”</span></div>
          <div class="ai-row"><span class="ai-label">Tempo</span><span class="ai-value" id="h-ai-tempo">â€”</span></div>
        </div>
      </div>
    </div>
    <div class="panel"><div class="ptitle">Spectrum</div><canvas id="h-viz"></canvas></div>
    <div class="panel">
      <div class="ptitle" style="display:flex;justify-content:space-between"><span>Listeners</span><span class="lcnt" id="h-lcnt">0</span></div>
      <div id="h-llist"><div class="nol">No one joined yet â€” share your code!</div></div>
    </div>
    <div style="margin-top:12px"><button class="btn br" onclick="leave()">ğŸšª End Room</button></div>
    <audio id="h-audio" crossorigin="anonymous" style="display:none" preload="auto"></audio>
  </div>

  <div id="s-listen" class="screen">
    <div class="rhead">
      <div>
        <div class="rname" id="l-rname">Room</div>
        <div style="font-family:'Space Mono',monospace;font-size:10px;color:var(--m);margin-top:4px" id="l-clabel"></div>
      </div>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
        <div id="l-pill" class="pill pw"><div class="dot dm"></div><span>Connecting...</span></div>
        <div id="l-ai-pill" class="pill pai" style="display:none"><div class="dot dgold"></div><span>AI</span></div>
      </div>
    </div>
    <div class="panel">
      <div class="dbadge">NEURAL AI âœ¦</div>
      <div class="tinfo">
        <div class="tart" id="l-art">ğŸµ</div>
        <div style="flex:1;min-width:0">
          <div class="tname" id="l-tname">Waiting for host...</div>
          <div class="tsub">Host controls playback</div>
        </div>
      </div>
      <div class="seekbar">
        <div class="seek-track"><div class="seek-buffer" id="l-buffer"></div><div class="seek-fill" id="l-fill"></div></div>
        <div class="seek-times"><span id="l-cur">0:00</span><span id="l-dur">0:00</span></div>
      </div>
      <div class="vol" style="margin-top:11px">
        <span class="vol-lbl">ğŸ”Š</span>
        <input type="range" min="0" max="1" step="0.01" value="0.85" id="l-vol" oninput="setVol('l',this.value)">
        <span style="font-family:'Space Mono',monospace;font-size:10px;color:var(--m)" id="l-vol-val">85%</span>
      </div>
      <div class="eq-section">
        <div class="eq-header">
          <div class="eq-title">ğŸ§  Neural Spatial <span class="eq-ai-badge">AI</span></div>
          <div class="eq-auto-toggle" id="l-auto-eq" onclick="toggleAutoEQ('l')"><span>Auto</span><div class="toggle-track"><div class="toggle-thumb"></div></div></div>
        </div>
        <div class="eq-grid">
          <button class="eq-btn on" id="leq-flat" onclick="manualEQ(this,'l')">Flat</button>
          <button class="eq-btn" id="leq-atmos" onclick="manualEQ(this,'l')">Atmos</button>
          <button class="eq-btn" id="leq-cinema" onclick="manualEQ(this,'l')">Cinema</button>
          <button class="eq-btn" id="leq-bass" onclick="manualEQ(this,'l')">Bass+</button>
          <button class="eq-btn" id="leq-vocal" onclick="manualEQ(this,'l')">Vocal</button>
        </div>
        <div class="spatial-indicator">
          <span>Spatial Depth</span>
          <div class="spatial-bar"><div class="spatial-fill" id="l-spatial-fill"></div></div>
          <span id="l-spatial-val">0%</span>
        </div>
        <div class="ai-analysis" id="l-ai-info">
          <div class="ai-row"><span class="ai-label">Genre</span><span class="ai-value" id="l-ai-genre">â€”</span></div>
          <div class="ai-row"><span class="ai-label">Mood</span><span class="ai-value" id="l-ai-mood">â€”</span></div>
          <div class="ai-row"><span class="ai-label">Confidence</span><span class="ai-value gold" id="l-ai-conf">â€”</span></div>
        </div>
      </div>
    </div>
    <div class="panel">
      <div class="ptitle">Sync Status</div>
      <div class="sbox" id="l-sync"><b>Status:</b> Waiting for host...</div>
      <div class="latency-row" id="l-latency" style="display:none">
        <div class="latency-item"><div class="latency-val" id="l-drift-val">â€”</div><div class="latency-lbl">Drift</div></div>
        <div class="latency-item"><div class="latency-val" id="l-offset-val">â€”</div><div class="latency-lbl">Offset</div></div>
        <div class="latency-item"><div class="latency-val" id="l-rtt-val">â€”</div><div class="latency-lbl">RTT</div></div>
        <div class="latency-item"><div class="latency-val" id="l-corrections">0</div><div class="latency-lbl">Corrections</div></div>
      </div>
    </div>
    <div class="panel"><div class="ptitle">Spectrum</div><canvas id="l-viz"></canvas></div>
    <div style="margin-top:12px"><button class="btn bg" onclick="leave()">â† Leave Room</button></div>
    <audio id="l-audio" crossorigin="anonymous" style="display:none" preload="auto"></audio>
  </div>
</div>
<div id="toast" class="toast"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const NTP_ROUNDS=15,SCHED_MS=600,DRIFT_SOFT=.035,DRIFT_HARD=.25,AI_INTERVAL=2200;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sock=null,roomCode=null,amHost=false;
let clockOffset=0,ntpSamples=[],ntpDone=false,bestRTT=Infinity;
let pendingPlay=null,progRaf=null;
let listeners={};
let hCtx=null,hChain=null,lCtx=null,lChain=null;
let vizAn=null,vizRaf=null;
let currentTrack=null;
let currentEQ={h:'flat',l:'flat'};
let autoEQ={h:false,l:false};
let driftWatcher=null,aiInterval=null;
let driftCorrections=0,audioUnlocked=false;
let kalman={x:0,p:1000,q:.5,r:50};
let energyHistory=[];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRESETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PRESETS={
  flat:{sub:0,bass:0,lo:0,mid:0,hi:0,pres:0,air:0,ratio:2,thresh:-24,knee:8,rev:0,depth:0,label:'Flat'},
  atmos:{sub:4,bass:3,lo:-2,mid:1,hi:5,pres:6,air:7,ratio:4,thresh:-18,knee:10,rev:.2,depth:85,label:'Atmos 3D'},
  cinema:{sub:6,bass:5,lo:1,mid:2,hi:4,pres:5,air:5,ratio:5,thresh:-20,knee:12,rev:.3,depth:95,label:'Cinema'},
  bass:{sub:10,bass:8,lo:3,mid:-2,hi:1,pres:2,air:1,ratio:6,thresh:-22,knee:8,rev:.06,depth:20,label:'Bass+'},
  vocal:{sub:-3,bass:-2,lo:1,mid:5,hi:4,pres:3,air:2,ratio:3,thresh:-16,knee:6,rev:.14,depth:30,label:'Vocal'},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEURAL NETWORK (genre classification)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GENRES=['electronic','rock','ambient','pop','hip-hop','classical','jazz'];
const GENRE_PRESETS={electronic:'bass',rock:'cinema',ambient:'atmos',pop:'vocal','hip-hop':'bass',classical:'cinema',jazz:'vocal'};
const GENRE_MOODS={electronic:'energetic',rock:'intense',ambient:'calm',pop:'upbeat','hip-hop':'groovy',classical:'serene',jazz:'smooth'};

const W1=[[.82,-.31,.15,.92,-.45,.28,.67,-.22],[-.55,.73,.41,-.18,.65,-.38,.12,.54],[.33,-.67,-.29,.44,-.12,.88,-.55,.21],[-.41,.22,.78,-.33,.55,.11,-.67,.43],[.65,.45,-.52,.71,-.28,-.44,.33,-.18],[-.28,-.55,.63,-.72,.82,.35,-.21,.66],[.15,.88,-.38,.26,-.59,.72,.44,-.31],[-.72,.35,.55,-.41,.18,-.62,.81,.27],[.48,-.22,-.71,.58,.33,.45,-.38,.72],[.27,.61,.32,-.55,-.42,.28,.55,-.45]];
const B1=[.12,-.08,.15,-.05,.22,-.11,.08,-.15,.18,-.06];
const W2=[[.55,-.32,.71,-.45,.28,.62,-.38,.44,-.22,.51],[-.41,.68,-.25,.52,-.58,.31,.45,-.62,.38,-.28],[.32,-.55,.45,.72,-.31,-.48,.62,.28,-.42,.55],[-.62,.42,-.38,-.22,.72,.55,-.31,.48,-.58,.35],[.45,.28,-.62,.35,.48,-.72,.52,-.35,.62,-.41],[-.28,.55,.38,-.62,-.42,.45,-.55,.72,.31,-.48],[.72,-.45,.28,.42,.55,-.31,-.62,.38,.45,.22]];
const B2=[.08,-.12,.05,-.08,.15,-.05,.1];

function relu(x){return Math.max(0,x)}
function softmax(a){const m=Math.max(...a);const e=a.map(x=>Math.exp(x-m));const s=e.reduce((a,b)=>a+b,0);return e.map(x=>x/s)}
function nnForward(inp){
  const h=new Array(10);
  for(let i=0;i<10;i++){let s=B1[i];for(let j=0;j<8;j++)s+=W1[i][j]*inp[j];h[i]=relu(s);}
  const o=new Array(7);
  for(let i=0;i<7;i++){let s=B2[i];for(let j=0;j<10;j++)s+=W2[i][j]*h[j];o[i]=s;}
  return softmax(o);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $=id=>document.getElementById(id);
function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('on'));$(id).classList.add('on');}
function toast(m,d=3500){const t=$('toast');t.textContent=m;t.classList.add('on');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('on'),d);}
function fmt(s){if(!s||isNaN(s)||!isFinite(s))return'0:00';return Math.floor(s/60)+':'+(('0'+Math.floor(s%60)).slice(-2));}
function srvNow(){return Date.now()-clockOffset}
function setConn(on){$('conn-dot').className='nav-dot'+(on?' online':'');$('conn-label').textContent=on?'Online':'Offline';}
function setPill(id,c,d,l){const e=$(id);if(!e)return;e.className='pill '+c;e.innerHTML='<div class="dot '+d+'"></div><span>'+l+'</span>';}
function setSyncInfo(h){$('l-sync').innerHTML='<b>Status:</b> '+h}
function setStatus(id,h){const e=$(id);if(e)e.innerHTML=h}
function switchTab(n){['youtube','url','file'].forEach(t=>{$('tab-'+t).classList.toggle('active',t===n);$('pane-'+t).classList.toggle('on',t===n);})}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO UNLOCK (proactive)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupUnlock(){
  const evts=['click','touchstart','touchend','keydown'];
  function tryUnlock(){
    if(audioUnlocked)return;
    audioUnlocked=true;
    [hCtx,lCtx].forEach(c=>{if(c&&c.state==='suspended')c.resume()});
    try{
      const c=new(window.AudioContext||window.webkitAudioContext)();
      const o=c.createOscillator();const g=c.createGain();g.gain.value=0;
      o.connect(g);g.connect(c.destination);o.start(0);o.stop(c.currentTime+.001);
      c.resume().then(()=>setTimeout(()=>c.close(),50));
    }catch(e){}
    $('unlock').classList.remove('show');
    evts.forEach(ev=>document.removeEventListener(ev,tryUnlock,true));
    console.log('[AUDIO] Unlocked');
  }
  evts.forEach(ev=>document.addEventListener(ev,tryUnlock,{once:false,capture:true,passive:true}));
}

function showUnlock(){$('unlock').classList.add('show')}

$('unlock').addEventListener('click',function(){
  audioUnlocked=true;
  $('unlock').classList.remove('show');
  [hCtx,lCtx].forEach(c=>{if(c&&c.state==='suspended')c.resume()});
  ['l-audio','h-audio'].forEach(id=>{const a=$(id);if(a&&a.src&&a.paused&&a.readyState>=2)a.play().catch(()=>{})});
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE EXTRACTION + AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function extractFeatures(an){
  if(!an)return null;
  const bins=an.frequencyBinCount;
  const freq=new Uint8Array(bins);
  const time=new Float32Array(an.fftSize);
  an.getByteFrequencyData(freq);
  an.getFloatTimeDomainData(time);

  let rmsSum=0;for(let i=0;i<time.length;i++)rmsSum+=time[i]*time[i];
  const rms=Math.sqrt(rmsSum/time.length);

  let zc=0;for(let i=1;i<time.length;i++)if((time[i]>=0)!==(time[i-1]>=0))zc++;
  const zcr=zc/time.length;

  let wSum=0,tMag=0;
  for(let i=0;i<bins;i++){const m=freq[i]/255;const f=(i*24000)/bins;wSum+=f*m;tMag+=m;}
  const centroid=tMag>0?wSum/tMag:0;

  const bassEnd=Math.floor(bins*250/24000),midEnd=Math.floor(bins*4000/24000);
  let bE=0,mE=0,hE=0;
  for(let i=0;i<bins;i++){const e=(freq[i]/255)**2;if(i<bassEnd)bE+=e;else if(i<midEnd)mE+=e;else hE+=e;}
  const tot=bE+mE+hE+.0001;

  const flux=tMag/bins;
  let peak=0;for(let i=0;i<time.length;i++)peak=Math.max(peak,Math.abs(time[i]));
  const crest=rms>.001?peak/rms:1;

  return{
    spectralCentroid:Math.min(centroid/12000,1),
    rms:Math.min(rms*3,1),
    zeroCrossings:Math.min(zcr*5,1),
    bassRatio:bE/tot,midRatio:mE/tot,highRatio:hE/tot,
    spectralFlux:Math.min(flux*2,1),
    crest:Math.min(crest/10,1),
  };
}

function estimateTempo(rms){
  energyHistory.push(rms);
  if(energyHistory.length>200)energyHistory.shift();
  if(energyHistory.length<80)return 0;
  const onsets=[];
  for(let i=2;i<energyHistory.length;i++){
    if(energyHistory[i]>energyHistory[i-1]*1.3&&energyHistory[i]>energyHistory[i-2]*1.2&&energyHistory[i]>.15)onsets.push(i);
  }
  if(onsets.length<3)return 0;
  let total=0,cnt=0;
  for(let i=1;i<onsets.length;i++){const g=onsets[i]-onsets[i-1];if(g>2&&g<60){total+=g;cnt++;}}
  if(!cnt)return 0;
  const avg=total/cnt;
  const bpm=60000/(avg*(AI_INTERVAL/1000)*1000/AI_INTERVAL);
  return Math.round(Math.max(60,Math.min(200,bpm)));
}

function startAI(side){
  stopAI();
  const chain=side==='h'?hChain:lChain;
  if(!chain||!chain.an)return;
  $(side+'-ai-info').classList.add('on');
  $(side+'-ai-pill').style.display='inline-flex';

  let smoothed=new Float32Array(7).fill(1/7);
  const SM=.7;

  aiInterval=setInterval(()=>{
    const f=extractFeatures(chain.an);if(!f)return;
    const inp=[f.spectralCentroid,f.rms,f.zeroCrossings,f.bassRatio,f.midRatio,f.highRatio,f.spectralFlux,f.crest];
    const probs=nnForward(inp);
    for(let i=0;i<7;i++)smoothed[i]=SM*smoothed[i]+(1-SM)*probs[i];
    const sum=smoothed.reduce((a,b)=>a+b,0);
    const norm=Array.from(smoothed).map(x=>x/sum);
    let mi=0;for(let i=1;i<norm.length;i++)if(norm[i]>norm[mi])mi=i;

    const genre=GENRES[mi],conf=norm[mi],mood=GENRE_MOODS[genre],preset=GENRE_PRESETS[genre];
    const tempo=estimateTempo(f.rms);
    const p=side==='h'?'h':'l';

    if($(p+'-ai-genre'))$(p+'-ai-genre').textContent=genre[0].toUpperCase()+genre.slice(1);
    if($(p+'-ai-mood'))$(p+'-ai-mood').textContent=mood[0].toUpperCase()+mood.slice(1);
    if($(p+'-ai-conf'))$(p+'-ai-conf').textContent=(conf*100).toFixed(0)+'%';
    if($(p+'-ai-preset'))$(p+'-ai-preset').textContent=PRESETS[preset]?.label||'â€”';
    if($(p+'-ai-centroid'))$(p+'-ai-centroid').textContent=Math.round(f.spectralCentroid*12000)+' Hz';
    if($(p+'-ai-rms'))$(p+'-ai-rms').textContent=(f.rms*100).toFixed(0)+'%';
    if($(p+'-ai-tempo'))$(p+'-ai-tempo').textContent=tempo>0?tempo+' BPM':'analyzing...';

    if(autoEQ[side]&&conf>.25&&currentEQ[side]!==preset){
      applyPresetByName(preset,side);
      document.querySelectorAll(`[id^="${side}eq-"]`).forEach(b=>b.classList.remove('on','ai-selected'));
      const btn=$(side+'eq-'+preset);if(btn)btn.classList.add('on','ai-selected');
    }

    if(side==='h'&&amHost&&sock?.connected){
      sock.emit('ai:state',{genre,mood,preset,confidence:+conf.toFixed(2)});
    }
  },AI_INTERVAL);
}

function stopAI(){if(aiInterval){clearInterval(aiInterval);aiInterval=null}energyHistory=[];}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPATIAL AUDIO ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildChain(el,side){
  teardownChain(side);
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)({sampleRate:48000,latencyHint:'playback'});
    if(ctx.state==='suspended')ctx.resume();
    const src=ctx.createMediaElementSource(el);
    const sub=mkF(ctx,'lowshelf',40),bass=mkF(ctx,'peaking',120,1),lo=mkF(ctx,'peaking',400,.9),mid=mkF(ctx,'peaking',1200,.9),hi=mkF(ctx,'peaking',4000,1),pres=mkF(ctx,'peaking',8000,1.1),air=mkF(ctx,'highshelf',16000);
    const reverb=ctx.createConvolver();reverb.buffer=makeIR(ctx,2.8,3.5);
    const revG=ctx.createGain();revG.gain.value=0;
    const dryG=ctx.createGain();dryG.gain.value=1;
    const comp=ctx.createDynamicsCompressor();comp.threshold.value=-24;comp.knee.value=8;comp.ratio.value=2;comp.attack.value=.003;comp.release.value=.15;
    const lim=ctx.createDynamicsCompressor();lim.threshold.value=-1;lim.knee.value=0;lim.ratio.value=20;lim.attack.value=.001;lim.release.value=.05;
    const master=ctx.createGain();master.gain.value=parseFloat($(side+'-vol')?.value||.85);
    const an=ctx.createAnalyser();an.fftSize=2048;an.smoothingTimeConstant=.82;

    src.connect(sub);sub.connect(bass);bass.connect(lo);lo.connect(mid);mid.connect(hi);hi.connect(pres);pres.connect(air);
    air.connect(dryG);air.connect(reverb);reverb.connect(revG);
    dryG.connect(comp);revG.connect(comp);comp.connect(lim);lim.connect(master);master.connect(an);an.connect(ctx.destination);

    const chain={sub,bass,lo,mid,hi,pres,air,comp,lim,revGain:revG,dryGain:dryG,master,an,ctx};
    if(side==='h'){hCtx=ctx;hChain=chain;vizAn=an}else{lCtx=ctx;lChain=chain;vizAn=an}
    applyPreset(PRESETS[currentEQ[side]||'flat'],chain);
    return chain;
  }catch(e){console.warn('[CHAIN]',e);return null}
}

function makeIR(ctx,dur,decay){
  const len=Math.floor(ctx.sampleRate*dur),buf=ctx.createBuffer(2,len,ctx.sampleRate);
  for(let ch=0;ch<2;ch++){const d=buf.getChannelData(ch);for(let i=0;i<len;i++){
    const t=i/ctx.sampleRate;let env;
    if(t<.02)env=t<.005?.1:.8*Math.pow(1-(t-.005)/.015,.5);
    else if(t<.08){env=.5*Math.pow(1-(t-.02)/.06,1.5);if(Math.random()<.15)env+=.3*Math.random()}
    else env=.35*Math.pow(Math.max(0,1-t/dur),decay);
    d[i]=(Math.random()*2-1+((ch===0?Math.sin(t*200):Math.cos(t*180))*.05))*env*.4;
  }}return buf;
}

function mkF(ctx,type,freq,q){const f=ctx.createBiquadFilter();f.type=type;f.frequency.value=freq;if(q!==undefined)f.Q.value=q;return f}

function teardownChain(s){
  if(s==='h'&&hCtx){try{hCtx.close()}catch(e){}hCtx=null;hChain=null}
  if(s==='l'&&lCtx){try{lCtx.close()}catch(e){}lCtx=null;lChain=null}
  if(vizRaf){cancelAnimationFrame(vizRaf);vizRaf=null;vizAn=null}
}

function applyPreset(p,ch){
  if(!ch||!p)return;
  const t=(ch.ctx?.currentTime||0)+.05;
  ch.sub.gain.linearRampToValueAtTime(p.sub,t);ch.bass.gain.linearRampToValueAtTime(p.bass,t);
  ch.lo.gain.linearRampToValueAtTime(p.lo,t);ch.mid.gain.linearRampToValueAtTime(p.mid,t);
  ch.hi.gain.linearRampToValueAtTime(p.hi,t);ch.pres.gain.linearRampToValueAtTime(p.pres,t);
  ch.air.gain.linearRampToValueAtTime(p.air,t);
  ch.comp.ratio.linearRampToValueAtTime(p.ratio,t);ch.comp.threshold.linearRampToValueAtTime(p.thresh,t);ch.comp.knee.linearRampToValueAtTime(p.knee,t);
  ch.revGain.gain.linearRampToValueAtTime(p.rev,t);ch.dryGain.gain.linearRampToValueAtTime(1-p.rev*.5,t);
}

function applyPresetByName(name,side){
  const p=PRESETS[name];if(!p)return;
  applyPreset(p,side==='h'?hChain:lChain);
  currentEQ[side]=name;
  const sf=$(side+'-spatial-fill'),sv=$(side+'-spatial-val');
  if(sf)sf.style.width=(p.depth||0)+'%';if(sv)sv.textContent=(p.depth||0)+'%';
}

function manualEQ(btn,side){
  autoEQ[side]=false;$(side+'-auto-eq').classList.remove('active');
  const preset=btn.id.replace(/^[hl]eq-/,'');
  applyPresetByName(preset,side);
  document.querySelectorAll('[id^="'+side+'eq-"]').forEach(b=>b.classList.remove('on','ai-selected'));
  btn.classList.add('on');
  toast('âœ¦ '+PRESETS[preset]?.label+' activated');
}

function toggleAutoEQ(s){autoEQ[s]=!autoEQ[s];$(s+'-auto-eq').classList.toggle('active',autoEQ[s]);toast(autoEQ[s]?'ğŸ§  AI Auto-EQ on':'ğŸ› Manual EQ')}
function setVol(s,v){const val=+v;const a=$(s+'-audio');if(a)a.volume=val;const ch=s==='h'?hChain:lChain;if(ch){const t=(ch.ctx?.currentTime||0)+.02;ch.master.gain.linearRampToValueAtTime(val,t)}$(s+'-vol-val').textContent=Math.round(val*100)+'%'}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOCKET.IO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initSock(){
  if(sock&&sock.connected)return;
  sock=io({transports:['websocket','polling'],reconnectionAttempts:30,reconnectionDelay:1000,reconnectionDelayMax:5000,timeout:20000});

  sock.on('connect',()=>{console.log('[WS] Connected:',sock.id);setConn(true);doNTP();clearInterval(window._ka);window._ka=setInterval(()=>{if(sock?.connected)sock.emit('keepalive')},15000)});
  sock.on('disconnect',r=>{console.warn('[WS] Disconnected:',r);setConn(false);if(roomCode)toast('âš ï¸ Reconnecting...')});
  sock.on('reconnect',()=>{setConn(true);toast('âœ… Reconnected!');doNTP()});
  sock.on('connect_error',e=>{console.error('[WS] Error:',e.message);setConn(false)});

  sock.on('ntp:pong',({clientTime,serverTime})=>{
    const now=Date.now(),rtt=now-clientTime,offset=now-(serverTime+rtt/2);
    ntpSamples.push({rtt,offset});
    if(ntpSamples.length<NTP_ROUNDS)setTimeout(()=>sock.emit('ntp:ping',{clientTime:Date.now()}),30);
    else finishNTP();
  });

  // HOST
  sock.on('room:listener_joined',({id})=>{
    listeners[id]={t:Date.now()};renderListeners();
    if(currentTrack&&!currentTrack.isLocal){
      sock.emit('track:set',{streamUrl:currentTrack.streamUrl,title:currentTrack.title,originalUrl:currentTrack.originalUrl});
      const a=$('h-audio');
      setTimeout(()=>{if(a&&!a.paused)sock.emit('audio:play',{position:a.currentTime,serverPlayAt:srvNow()+SCHED_MS})},500);
    }
  });
  sock.on('room:listener_left',({id})=>{delete listeners[id];renderListeners()});
  sock.on('room:count',n=>$('h-lcnt').textContent=n);

  // LISTENER
  sock.on('track:set',({streamUrl,title})=>loadListenerTrack(streamUrl,title));
  sock.on('audio:play',({position,serverPlayAt})=>schedPlay(position,serverPlayAt));
  sock.on('audio:pause',({position})=>{
    cancelSched();clearInterval(driftWatcher);
    const a=$('l-audio');if(!a.src)return;a.pause();
    if(isFinite(position)&&Math.abs(a.currentTime-position)>.5)a.currentTime=position;
    $('l-art').classList.remove('spinning');setPill('l-pill','pw','dm','Paused');setSyncInfo('Host paused.')
  });
  sock.on('audio:seek',({position,playing,serverPlayAt})=>{
    cancelSched();const a=$('l-audio');if(!a.src)return;
    a.currentTime=position;if(playing)schedPlay(position,serverPlayAt);else{a.pause();$('l-art').classList.remove('spinning')}
  });
  sock.on('ai:state',({genre,mood,preset,confidence})=>{
    if($('l-ai-genre'))$('l-ai-genre').textContent=genre?genre[0].toUpperCase()+genre.slice(1):'â€”';
    if($('l-ai-mood'))$('l-ai-mood').textContent=mood?mood[0].toUpperCase()+mood.slice(1):'â€”';
    if($('l-ai-conf'))$('l-ai-conf').textContent=confidence?(confidence*100).toFixed(0)+'%':'â€”';
    $('l-ai-info').classList.add('on');$('l-ai-pill').style.display='inline-flex';
    if(autoEQ.l&&preset&&PRESETS[preset]){
      applyPresetByName(preset,'l');
      document.querySelectorAll('[id^="leq-"]').forEach(b=>b.classList.remove('on','ai-selected'));
      const btn=$('leq-'+preset);if(btn)btn.classList.add('on','ai-selected');
    }
  });
  sock.on('room:host_left',()=>{toast('ğŸšª Host ended session');setTimeout(leave,1500)});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NTP + KALMAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doNTP(){ntpSamples=[];ntpDone=false;kalman={x:0,p:1000,q:.5,r:50};sock.emit('ntp:ping',{clientTime:Date.now()})}

function finishNTP(){
  ntpSamples.sort((a,b)=>a.rtt-b.rtt);
  const best=ntpSamples.slice(0,Math.ceil(NTP_ROUNDS/3));
  bestRTT=ntpSamples[0].rtt;
  for(const s of best){kalman.p+=kalman.q;const k=kalman.p/(kalman.p+kalman.r);kalman.x+=k*(s.offset-kalman.x);kalman.p*=(1-k)}
  clockOffset=kalman.x;ntpDone=true;
  if($('l-offset-val'))$('l-offset-val').textContent=Math.round(Math.abs(clockOffset))+'ms';
  if($('l-rtt-val'))$('l-rtt-val').textContent=bestRTT+'ms';
  console.log(`[NTP] offset=${clockOffset.toFixed(1)}ms RTT=${bestRTT}ms`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCHEDULED PLAY + PID DRIFT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function schedPlay(pos,serverPlayAt){
  cancelSched();
  const a=$('l-audio');if(!a||!a.src){setSyncInfo('âš ï¸ Track not loaded');return}
  const localPlayAt=serverPlayAt+clockOffset,msLeft=localPlayAt-Date.now();

  function exec(){
    const late=Math.max(0,(Date.now()-localPlayAt))/1000;
    const target=Math.max(0,pos+late);
    const drift=Math.abs(a.currentTime-target);
    if(drift>DRIFT_SOFT){a.currentTime=target;driftCorrections++}

    a.play().then(()=>{
      $('l-art').classList.add('spinning');
      setPill('l-pill','ps','dc','â— In Sync');setSyncInfo('ğŸ§ Playing in sync');
      $('unlock').classList.remove('show');
      $('l-latency').style.display='flex';
      if($('l-drift-val'))$('l-drift-val').textContent=Math.round(drift*1000)+'ms';
      if($('l-corrections'))$('l-corrections').textContent=driftCorrections;

      if(!lCtx||!lChain){buildChain(a,'l');startAI('l')}
      if(lCtx&&lCtx.state==='suspended')lCtx.resume();
      startProg(a,'l');startViz('l-viz');

      clearInterval(driftWatcher);
      let intErr=0,lastErr=0;
      driftWatcher=setInterval(()=>{
        if(a.paused)return;
        const elapsed=(srvNow()-serverPlayAt)/1000,expected=pos+elapsed;
        const err=a.currentTime-expected,absErr=Math.abs(err);
        intErr+=err;intErr=Math.max(-5,Math.min(5,intErr));
        const deriv=err-lastErr;lastErr=err;

        if(absErr>DRIFT_HARD){a.currentTime=expected;driftCorrections++;intErr=0}
        else if(absErr>DRIFT_SOFT){
          const corr=.5*err+.01*intErr+.1*deriv;
          a.playbackRate=Math.max(.95,Math.min(1.05,1-corr*.1));
          setTimeout(()=>{if(!a.paused)a.playbackRate=1},500);
          driftCorrections++;
        }else a.playbackRate=1;

        if($('l-drift-val'))$('l-drift-val').textContent=Math.round(absErr*1000)+'ms';
        if($('l-corrections'))$('l-corrections').textContent=driftCorrections;
      },2000);
    }).catch(e=>{
      console.warn('[PLAY] Blocked:',e.message);
      showUnlock();setPill('l-pill','pw','dm','Tap to play');setSyncInfo('âš ï¸ Tap screen to enable audio');
    });
  }

  if(msLeft>20){
    a.currentTime=Math.max(0,pos);setPill('l-pill','pw','dm','Syncing...');
    setSyncInfo('<span class="spin">âŸ³</span> Synchronizing...');
    pendingPlay=setTimeout(exec,msLeft);
  }else exec();
}

function cancelSched(){if(pendingPlay){clearTimeout(pendingPlay);pendingPlay=null}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadYoutube(){
  const raw=$('yt-url').value.trim();
  if(!raw){toast('Paste a YouTube URL');return}
  const btn=$('yt-btn');btn.disabled=true;btn.textContent='...';
  setStatus('yt-status','<span class="spin">âŸ³</span> Connecting to YouTube...');

  try{
    const r=await fetch('/yt-info?url='+encodeURIComponent(raw));
    const d=await r.json();
    if(!r.ok||!d.ok||d.error){
      setStatus('yt-status','âŒ '+(d.error||'Failed'));
      btn.disabled=false;btn.textContent='Load';return;
    }
    setStatus('yt-status','<span class="spin">âŸ³</span> Loading: '+d.title);
    const streamUrl='/yt-stream?url='+encodeURIComponent(raw);
    setStatus('yt-status','âœ… '+d.title);
    applyTrack(streamUrl,d.title,raw);
  }catch(e){
    setStatus('yt-status','âŒ '+e.message);toast('âŒ '+e.message,5000);
  }
  btn.disabled=false;btn.textContent='Load';
}

function loadDirectUrl(){
  const raw=$('direct-url').value.trim();if(!raw){toast('Enter a URL');return}
  setStatus('url-status','<span class="spin">âŸ³</span> Loading...');
  const title=decodeURIComponent(raw.split('/').pop().split('?')[0].replace(/\.[^.]+$/,'')||'Audio');
  applyTrack('/proxy?url='+encodeURIComponent(raw),title,raw);
}

function loadFile(){
  const f=$('file-input').files[0];if(!f)return;
  const url=URL.createObjectURL(f);
  setStatus('file-status','âš ï¸ Local â€” your device only');
  applyTrack(url,f.name.replace(/\.[^.]+$/,''),null,true);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APPLY TRACK (HOST)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyTrack(streamUrl,title,originalUrl,isLocal=false){
  teardownChain('h');stopAI();
  if(progRaf){cancelAnimationFrame(progRaf);progRaf=null}
  currentTrack={streamUrl,title,originalUrl,isLocal};

  const a=$('h-audio');
  a.pause();a.removeAttribute('src');a.load();
  a.src=streamUrl;a.crossOrigin='anonymous';a.preload='auto';a.load();

  $('h-tname').textContent=title;$('h-tsub').textContent='Loading...';
  $('h-player').style.display='block';$('h-play-btn').disabled=true;

  let ready=false;

  function onReady(){
    if(ready)return;ready=true;
    a.removeEventListener('canplay',onReady);a.removeEventListener('loadedmetadata',onReady);a.removeEventListener('loadeddata',onReady);
    $('h-dur').textContent=isFinite(a.duration)?fmt(a.duration):'LIVE';
    $('h-tsub').textContent=(isFinite(a.duration)?fmt(a.duration):'Live')+(isLocal?' Â· local':' Â· ready');
    $('h-play-btn').disabled=false;
    buildChain(a,'h');startProg(a,'h');startViz('h-viz');startAI('h');
    setupSeekbar('h-seekbar',a);
    toast('âœ… Track loaded â€” press Play â–¶');
    setStatus('yt-status','âœ… Ready');setStatus('url-status','âœ… Ready');
  }

  function onErr(){
    a.removeEventListener('error',onErr);
    const codes=['','ABORTED','NETWORK','DECODE','NOT_SUPPORTED'];
    const c=a.error?a.error.code:0;
    const msg=codes[c]||'ERROR_'+c;
    console.error('[AUDIO] Error:',msg);

    if(c===2&&!a._retry){
      a._retry=true;
      setStatus('yt-status','<span class="spin">âŸ³</span> Retrying...');
      setTimeout(()=>{a.src=streamUrl;a.load();a.addEventListener('canplay',onReady,{once:true});a.addEventListener('error',()=>{
        setStatus('yt-status','âŒ '+msg);toast('âŒ '+msg,5000);$('h-play-btn').disabled=false;
      },{once:true})},2000);
      return;
    }
    setStatus('yt-status','âŒ '+msg);toast('âŒ '+msg,5000);$('h-play-btn').disabled=false;
  }

  a.addEventListener('canplay',onReady,{once:true});
  a.addEventListener('loadedmetadata',onReady,{once:true});
  a.addEventListener('loadeddata',onReady,{once:true});
  a.addEventListener('error',onErr,{once:true});
  a.addEventListener('progress',()=>{
    if(a.buffered.length>0&&isFinite(a.duration)){
      const p=(a.buffered.end(a.buffered.length-1)/a.duration)*100;
      const b=$('h-buffer');if(b)b.style.width=p+'%';
    }
  });

  if(!isLocal&&sock)sock.emit('track:set',{streamUrl,title,originalUrl});
}

function setupSeekbar(barId,audio){
  const bar=$(barId);if(!bar)return;
  const nb=bar.cloneNode(true);bar.parentNode.replaceChild(nb,bar);nb.id=barId;
  let drag=false;
  function getR(e){const t=nb.querySelector('.seek-track'),r=t.getBoundingClientRect(),x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;return Math.max(0,Math.min(1,x/r.width))}
  function doSeek(e){if(!audio.duration||!isFinite(audio.duration))return;const r=getR(e),pos=r*audio.duration;audio.currentTime=pos;const f=$(barId.replace('seekbar','fill'));if(f)f.style.width=(r*100)+'%';if(amHost){const playing=!audio.paused,playAt=srvNow()+SCHED_MS;if(playing)setTimeout(()=>audio.play().catch(()=>{}),SCHED_MS);sock.emit('audio:seek',{position:pos,playing,serverPlayAt:playAt})}}
  nb.addEventListener('mousedown',e=>{drag=true;doSeek(e)});
  nb.addEventListener('touchstart',e=>{drag=true;doSeek(e)},{passive:true});
  document.addEventListener('mousemove',e=>{if(drag)doSeek(e)});
  document.addEventListener('touchmove',e=>{if(drag)doSeek(e)},{passive:true});
  document.addEventListener('mouseup',()=>drag=false);
  document.addEventListener('touchend',()=>drag=false);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LISTENER TRACK LOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadListenerTrack(url,title,cb){
  const a=$('l-audio');teardownChain('l');stopAI();
  a.pause();a.removeAttribute('src');a.load();
  a.src=url;a.crossOrigin='anonymous';a.preload='auto';a.load();
  $('l-tname').textContent=title||'Loading...';
  setSyncInfo('<span class="spin">âŸ³</span> Loading...');setPill('l-pill','pw','dm','Loading...');

  let rdy=false;
  function onReady(){
    if(rdy)return;rdy=true;a.removeEventListener('canplay',onReady);a.removeEventListener('loadeddata',onReady);
    if(a.duration&&isFinite(a.duration))$('l-dur').textContent=fmt(a.duration);
    setSyncInfo('âœ… Ready â€” waiting for host...');setPill('l-pill','pw','dm','Ready');
    buildChain(a,'l');startAI('l');if(cb)cb();
  }
  function onErr(){
    a.removeEventListener('error',onErr);
    const c=a.error?a.error.code:0;
    const msgs=['','Aborted','Network','Decode','Not supported'];
    if(c===2&&!a._rtry){a._rtry=true;setSyncInfo('<span class="spin">âŸ³</span> Retrying...');setTimeout(()=>{a.load();a.addEventListener('canplay',onReady,{once:true});a.addEventListener('error',()=>{setSyncInfo('âŒ '+(msgs[c]||'Error'));toast('âŒ Load failed',4000)},{once:true})},2000);return}
    setSyncInfo('âŒ '+(msgs[c]||'Error'));toast('âŒ Load failed',4000);
  }
  a.addEventListener('canplay',onReady,{once:true});
  a.addEventListener('loadeddata',onReady,{once:true});
  a.addEventListener('error',onErr,{once:true});
  a.addEventListener('progress',()=>{if(a.buffered.length>0&&isFinite(a.duration)){const p=(a.buffered.end(a.buffered.length-1)/a.duration)*100;const b=$('l-buffer');if(b)b.style.width=p+'%'}});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOST CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hostPlay(){
  const a=$('h-audio');if(!a.src){toast('Load a track first');return}
  if(hCtx&&hCtx.state==='suspended')hCtx.resume();
  const pos=a.currentTime,playAt=srvNow()+SCHED_MS;
  setTimeout(()=>{a.play().then(()=>$('h-art').classList.add('spinning')).catch(e=>{console.warn(e);showUnlock()})},SCHED_MS);
  setPill('h-pill','pl','dg','â— Playing');
  sock.emit('audio:play',{position:pos,serverPlayAt:playAt});startViz('h-viz');
}

function hostPause(){const a=$('h-audio');a.pause();$('h-art').classList.remove('spinning');setPill('h-pill','pw','dm','Paused');sock.emit('audio:pause',{position:a.currentTime})}

function hostRestart(){
  const a=$('h-audio');if(!a.src)return;
  if(hCtx&&hCtx.state==='suspended')hCtx.resume();
  a.currentTime=0;const playAt=srvNow()+SCHED_MS;
  setTimeout(()=>{a.play().then(()=>$('h-art').classList.add('spinning')).catch(()=>{})},SCHED_MS);
  setPill('h-pill','pl','dg','â— Playing');sock.emit('audio:play',{position:0,serverPlayAt:playAt});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CREATE / JOIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createRoom(){
  initSock();amHost=true;const name=$('rname-input').value.trim()||'Audio Room';
  function go(){sock.emit('room:create',{name},r=>{if(!r?.ok){toast('âŒ Error');return}roomCode=r.code;$('h-rname').textContent=r.name;$('h-code').textContent=r.code;show('s-host');toast('ğŸ‰ Room: '+r.code)})}
  if(sock.connected)go();else{toast('Connecting...');sock.once('connect',()=>setTimeout(go,200))}
}

function joinRoom(){
  const code=$('join-code').value.trim().toUpperCase();if(code.length<6){toast('Enter full 6-letter code');return}
  $('join-err').classList.remove('on');$('join-err').textContent='';
  initSock();amHost=false;
  function go(){
    sock.emit('room:join',{code},r=>{
      if(!r?.ok){$('join-err').textContent=r?.error||'Room not found.';$('join-err').classList.add('on');return}
      roomCode=code;$('l-rname').textContent=r.name;$('l-clabel').textContent='Room: '+code;show('s-listen');toast('ğŸ§ Joined!');
      if(r.track?.streamUrl){
        loadListenerTrack(r.track.streamUrl,r.track.title,()=>{
          if(r.state?.playing&&r.state.serverPlayAt){
            const elapsed=(srvNow()-r.state.serverPlayAt)/1000;
            schedPlay(Math.max(0,(r.state.position||0)+elapsed),srvNow()+SCHED_MS);
          }else if(r.state){$('l-audio').currentTime=r.state.position||0;setSyncInfo('Ready. Waiting for host.')}
        });
      }
    });
  }
  if(sock.connected)go();else{toast('Connecting...');sock.once('connect',()=>setTimeout(go,300))}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function leave(){
  cancelSched();stopAI();clearInterval(window._ka);clearInterval(driftWatcher);
  if(progRaf){cancelAnimationFrame(progRaf);progRaf=null}
  if(vizRaf){cancelAnimationFrame(vizRaf);vizRaf=null}
  ['h-audio','l-audio'].forEach(id=>{const a=$(id);if(a){a.pause();a.removeAttribute('src');a.load()}});
  teardownChain('h');teardownChain('l');
  if(sock){sock.disconnect();sock=null}
  roomCode=null;listeners={};currentTrack=null;driftCorrections=0;autoEQ={h:false,l:false};
  setConn(false);show('s-home');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyCode(){
  const c=$('h-code').textContent;
  if(navigator.clipboard)navigator.clipboard.writeText(c).then(()=>toast('ğŸ“‹ Copied: '+c));
  else{const e=document.createElement('textarea');e.value=c;e.style.position='fixed';e.style.opacity='0';document.body.appendChild(e);e.select();document.execCommand('copy');document.body.removeChild(e);toast('ğŸ“‹ '+c)}
}

function renderListeners(){
  const ids=Object.keys(listeners);$('h-lcnt').textContent=ids.length;
  const el=$('h-llist');
  if(!ids.length){el.innerHTML='<div class="nol">Share your code!</div>';return}
  el.innerHTML=ids.map((id,i)=>'<div class="litem"><div class="lav">ğŸ§</div><span>Listener '+(i+1)+'</span><span style="margin-left:auto;font-size:9px;color:var(--g)">â— synced</span></div>').join('');
}

function startProg(audio,side){
  if(progRaf){cancelAnimationFrame(progRaf);progRaf=null}
  function tick(){progRaf=requestAnimationFrame(tick);if(!audio.duration||!isFinite(audio.duration))return;
    const p=(audio.currentTime/audio.duration)*100;
    const f=$(side+'-fill');if(f)f.style.width=p+'%';
    const c=$(side+'-cur');if(c)c.textContent=fmt(audio.currentTime);
    const d=$(side+'-dur');if(d)d.textContent=fmt(audio.duration);
  }tick();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISUALIZER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startViz(canvasId){
  if(vizRaf){cancelAnimationFrame(vizRaf);vizRaf=null}
  if(!vizAn)return;
  const cv=$(canvasId);if(!cv)return;
  const dpr=window.devicePixelRatio||1;
  const W=cv.offsetWidth||760,H=cv.offsetHeight||68;
  cv.width=W*dpr;cv.height=H*dpr;
  const ctx=cv.getContext('2d');ctx.scale(dpr,dpr);
  const bins=vizAn.frequencyBinCount;
  const freqBuf=new Uint8Array(bins);
  const peaks=new Float32Array(bins);
  const barCount=Math.min(bins,Math.floor(W/3));
  const bw=(W/barCount)*.85,bg=(W/barCount)*.15;
  let beatGlow=0,lastE=0;

  function draw(){
    vizRaf=requestAnimationFrame(draw);
    vizAn.getByteFrequencyData(freqBuf);
    ctx.fillStyle='#06070c';ctx.fillRect(0,0,W,H);

    let energy=0;for(let i=0;i<barCount;i++)energy+=freqBuf[i];energy/=barCount;
    if(energy>lastE*1.25&&energy>80)beatGlow=1;else beatGlow*=.92;lastE=energy;

    if(beatGlow>.1){const g=ctx.createRadialGradient(W/2,H,0,W/2,H,W*.6);g.addColorStop(0,`rgba(0,229,255,${beatGlow*.08})`);g.addColorStop(1,'transparent');ctx.fillStyle=g;ctx.fillRect(0,0,W,H)}

    let x=0;
    for(let i=0;i<barCount;i++){
      const idx=Math.floor(i*bins/barCount);
      const r=freqBuf[idx]/255,h=r*H*.88;
      if(r>peaks[i])peaks[i]=r;else peaks[i]*=.985;
      const hue=175+i/barCount*100,sat=80+r*20,light=50+r*15,alpha=.6+r*.4;
      const grad=ctx.createLinearGradient(x,H,x,H-h);
      grad.addColorStop(0,`hsla(${hue},${sat}%,${light}%,${alpha})`);
      grad.addColorStop(1,`hsla(${hue+20},${sat}%,${light+15}%,${alpha*.6})`);
      ctx.fillStyle=grad;
      const bh=Math.max(1,h);ctx.fillRect(x,H-bh,bw,bh);
      if(peaks[i]>.06){ctx.fillStyle=`hsla(${hue},100%,85%,${.5+peaks[i]*.3})`;ctx.fillRect(x,H-peaks[i]*H*.88-1,bw,1.5)}
      x+=bw+bg;
    }
  }draw();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$('join-code').addEventListener('input',function(){this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')});

window.addEventListener('load',()=>{
  setupUnlock();initSock();
  $('join-code').addEventListener('keydown',e=>{if(e.key==='Enter')joinRoom()});
  $('rname-input').addEventListener('keydown',e=>{if(e.key==='Enter')createRoom()});
  $('yt-url').addEventListener('keydown',e=>{if(e.key==='Enter')loadYoutube()});
  $('direct-url').addEventListener('keydown',e=>{if(e.key==='Enter')loadDirectUrl()});
  $('yt-url').addEventListener('paste',()=>{setTimeout(()=>{const v=$('yt-url').value.trim();if(v&&(v.includes('youtube.com')||v.includes('youtu.be')))setTimeout(loadYoutube,300)},100)});
  console.log('%cğŸŒŠ WaveRoom v3.0','color:#00e5ff;font-size:14px;font-weight:bold');
});

document.addEventListener('visibilitychange',()=>{if(!document.hidden)[hCtx,lCtx].forEach(c=>{if(c&&c.state==='suspended')c.resume()})});
</script>
</body>
</html>
